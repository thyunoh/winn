<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.wnn_medcost.magam.mapper.MagamMapper">
	<resultMap id="magamMap" type="egovframework.wnn_medcost.magam.model.MagamDTO">	   
          <result property="hosp_cd"     column="hosp_cd" />
          <result property="mg_year"     column="mg_year" />
          <result property="mgmonth"     column="mgmonth" />
		  <result property="mg_flag"     column="mg_flag" />
		  <result property="magamyn"     column="magamyn" />		  
		  <result property="ipwonyn"     column="ipwonyn" />
		  <result property="claim_no"    column="claim_no" />
		  <result property="clform_ver"  column="clform_ver" />
		  <result property="claim_type"  column="claim_type" />
		  <result property="treat_type"  column="treat_type" />		  
		  <result property="claim_type_nm"  column="claim_type_nm" />
		  <result property="treat_type_nm"  column="treat_type_nm" />
		  <result property="date_ym"     column="date_ym" />
		  <result property="case_cnt"    column="case_cnt" />
		  <result property="tot_amt"     column="tot_amt" />
		  <result property="claim_amt"   column="claim_amt" />
		  <result property="jobs_dt"     column="jobs_dt" />
		  <result property="file_nm"     column="file_nm" />		  
		  <result property="user_nm"     column="user_nm" />		  
		  <result property="upd_dttm"    column="upd_dttm" />
		  <result property="filenew"     column="filenew" />
		  <result property="jobyymm"     column="jobyymm" />
		  <result property="jobcode"     column="jobcode" />
		  <result property="fr_yymm"     column="fr_yymm" />		  
		  <result property="midyymm"     column="midyymm" />
		  <result property="endyymm"     column="endyymm" />
		  <result property="avg_val"     column="avg_val" />
		  <result property="ta_hosp"     column="ta_hosp" />
		  <result property="ta_f_ym"     column="ta_f_ym" />
		  <result property="ta_m_ym"     column="ta_m_ym" />
		  <result property="ta_e_ym"     column="ta_e_ym" />
		  <result property="lock_yn"     column="lock_yn" />
		  <result property="http_st"     column="http_st" />
	</resultMap>
	
	<resultMap id="filesMap" type="egovframework.wnn_medcost.magam.model.FilesDTO">	   
          <result property="hosp_cd"    column="hosp_cd" />
          <result property="mg_year"    column="mg_year" />
          <result property="mgmonth"    column="mgmonth" />
		  <result property="mg_flag"    column="mg_flag" />
		  <result property="jobs_dt"    column="jobs_dt" />
		  <result property="file_nm"    column="file_nm" />
		  <result property="line_no"    column="line_no" />
		  <result property="lineval"    column="lineval" />
		  <result property="reg_user"   column="reg_user" />
		  <result property="reg_ip"     column="reg_ip" />
		  <result property="upd_user"   column="upd_user" />
		  <result property="upd_ip"     column="upd_ip" />
		  <result property="ver_number" column="ver_number" />
	</resultMap>
	 
	<resultMap id="ipwonMap" type="egovframework.wnn_medcost.magam.model.IpwonDTO">	   
          <result property="hosp_cd"    column="hosp_cd" />
          <result property="jobyymm"    column="jobyymm" />
          <result property="seq_num"    column="seq_num" />
          <result property="chartno"    column="chartno" />
		  <result property="patname"    column="patname" />
		  <result property="ipwondt"    column="ipwondt" />
		  <result property="ipwontm"    column="ipwontm" />
		  <result property="tewondt"    column="tewondt" />
		  <result property="tewontm"    column="tewontm" />
		  <result property="juminno"    column="juminno" />
		  <result property="docname"    column="docname" />
		  <result property="dept_nm"    column="dept_nm" />
		  <result property="insurnm"    column="insurnm" />
		  <result property="word_nm"    column="word_nm" />
		  <result property="room_nm"    column="room_nm" />
		  <result property="reg_user"   column="reg_user" />
		  <result property="reg_ip"     column="reg_ip" />
		  <result property="upd_user"   column="upd_user" />
		  <result property="upd_ip"     column="upd_ip" />
	</resultMap>
	
	<resultMap id="indiMap" type="egovframework.wnn_medcost.magam.model.IndiDTO">	   
          <result property="hosp_cd"    column="hosp_cd" />
          <result property="hosp_nm"    column="hosp_nm" />
          <result property="jobyymm"    column="jobyymm" />
          <result property="cate_cd"    column="cate_cd" />
          <result property="cate_fg"    column="cate_fg" />
		  <result property="stryymm"    column="stryymm" />
		  <result property="endyymm"    column="endyymm" />
		  <result property="dtorval"    column="dtorval" />
		  <result property="ntorval"    column="ntorval" />
		  <result property="cal_val"    column="cal_val" />
		  <result property="max_val"    column="max_val" />
		  <result property="stdweig"    column="stdweig" />
		  <result property="weigval"    column="weigval" />
		  <result property="s_score"    column="s_score" />
		  <result property="cate_nm"    column="cate_nm" />
		  <result property="goal_nm"    column="goal_nm" />
		  <result property="hospgrd"    column="hospgrd" />
		  <result property="scoreyy"    column="scoreyy" />
		  <result property="scoremm"    column="scoremm" />
		  <result property="scorest"    column="scorest" />
		  <result property="scoremd"    column="scoremd" />
		  <result property="checknm"    column="checknm" />
		  
		  <result property="calval1"    column="calval1" />
		  <result property="calval2"    column="calval2" />
		  <result property="calval3"    column="calval3" />
		  <result property="calval4"    column="calval4" />
		  <result property="calval5"    column="calval5" />
		  <result property="calval6"    column="calval6" />
		  <result property="weival1"    column="weival1" />
		  <result property="weival2"    column="weival2" />
		  <result property="weival3"    column="weival3" />
		  <result property="weival4"    column="weival4" />
		  <result property="weival5"    column="weival5" />
		  <result property="weival6"    column="weival6" />
		  <result property="dtortot"    column="dtortot" />
		  <result property="ntortot"    column="ntortot" />
		  <result property="cal_avg"    column="cal_avg" />
		  <result property="weigavg"    column="weigavg" />
		  
		  <result property="reg_user"   column="reg_user" />
		  <result property="reg_ip"     column="reg_ip" />
		  <result property="upd_user"   column="upd_user" />
		  <result property="upd_ip"     column="upd_ip" />
	</resultMap>
	
	<select id="getMagamYearList" parameterType="MagamDTO"  resultMap="magamMap"><![CDATA[
		WITH MONTHS AS (
		    SELECT '01' AS MGMONTH UNION ALL
		    SELECT '02' UNION ALL
		    SELECT '03' UNION ALL
		    SELECT '04' UNION ALL
		    SELECT '05' UNION ALL
		    SELECT '06' UNION ALL
		    SELECT '07' UNION ALL
		    SELECT '08' UNION ALL
		    SELECT '09' UNION ALL
		    SELECT '10' UNION ALL
		    SELECT '11' UNION ALL
		    SELECT '12'
		)
		SELECT #{mg_year} AS MG_YEAR
		     , M.MGMONTH
		     , #{mg_flag} AS MG_FLAG
		     , CASE WHEN A.MGMONTH IS NOT NULL THEN 'Y' ELSE 'N' END     AS MAGAMYN
		     , IFNULL(A.LOCK_YN,'N')                                     AS LOCK_YN                                                
		     , CASE WHEN EXISTS ( SELECT 1 
                                    FROM TBL_IPWON_INFO B
                                   WHERE B.HOSP_CD = #{hosp_cd}
                                     AND B.JOBYYMM = CONCAT(#{mg_year}, M.MGMONTH)
                  ) THEN 'Y' ELSE 'N' 
                END AS IPWONYN
		FROM MONTHS M LEFT JOIN TBL_MAGAM_INFO A ON M.MGMONTH = A.MGMONTH
		 AND A.HOSP_CD = #{hosp_cd}
		 AND A.MG_YEAR = #{mg_year}
		 AND A.MG_FLAG = #{mg_flag}
	   ORDER BY M.MGMONTH
	]]>
	</select>
	
	<select id="magamGetFileList" parameterType="MagamDTO"  resultMap="magamMap"><![CDATA[
	  SELECT DISTINCT
	         A.CLAIM_NO    AS claim_no
		   , A.CLFORM_VER  AS clform_ver
		   , IFNULL(C.SUB_CODE_NM,'') AS claim_type_nm
	       , IFNULL(D.SUB_CODE_NM,'') AS treat_type_nm
		   , A.DATE_YM     AS date_ym
		   , A.CASE_CNT    AS case_cnt
		   , COALESCE(E.TOT_AMT,0)+COALESCE(E.NON100_COST,0) AS tot_amt
		   , COALESCE(E.CLAIM_AMT,0)+COALESCE(E.NON100_CLAIM,0)+COALESCE(E.VET_CLAM,0)+COALESCE(E.NON100_VET,0) AS claim_amt
		   , A.FILE_NM     AS file_nm
		   , A.JOBS_DT     AS jobs_dt
		   , A.UPD_DTTM    AS upd_dttm
		   , B.USER_NM     AS user_nm
		   , A.MG_YEAR     AS mg_year
		   , A.MGMONTH     AS mgmonth
		   , A.MG_FLAG     AS mg_flag
		   , CASE WHEN A.MG_FLAG = 'Z' THEN 
               (SELECT IFNULL(F2.LOCK_YN, 'N')
                  FROM TBL_MAGAM_INFO F2
                 WHERE F2.HOSP_CD = A.HOSP_CD 
                   AND F2.MG_YEAR = A.MG_YEAR 
                   AND F2.MGMONTH = A.MGMONTH 
                   AND F2.MG_FLAG = #{mg_flag}
                 LIMIT 1)
                  ELSE IFNULL(F.LOCK_YN, 'N') END AS lock_yn
	    FROM TBL_MAGAM_CHUNG A
	    LEFT OUTER JOIN TBL_CHUNG_MST  E  ON E.HOSP_CD   = A.HOSP_CD 
	                                     AND E.CLAIM_NO  = A.CLAIM_NO
	    LEFT OUTER JOIN TBL_USER_MST   B  ON B.HOSP_CD   = A.HOSP_CD 
		                                 AND B.USER_ID   = A.UPD_USER
		                                 AND B.ACTION_YN = 'Y'
		                                 AND NOW() BETWEEN B.START_DT AND B.END_DT
		                                  
		LEFT OUTER JOIN TBL_CODE_DTL   C  ON C.CODE_GB = 'Z'
		                                 AND C.CODE_CD = 'CLAIM_TYPE'
		                                 AND C.SUB_CODE = A.CLAIM_TYPE 
		                                 AND NOW() BETWEEN C.START_DT AND C.END_DT
		LEFT OUTER JOIN TBL_CODE_DTL   D  ON D.CODE_GB = 'Z'
										 AND D.CODE_CD = 'TREAT_TYPE'
		                                 AND D.SUB_CODE = A.TREAT_TYPE 
		                                 AND NOW() BETWEEN D.START_DT AND D.END_DT
		                                   
        LEFT OUTER JOIN TBL_MAGAM_INFO F  ON F.HOSP_CD = A.HOSP_CD 
	                                     AND F.MG_YEAR = A.MG_YEAR
	                                     AND F.MGMONTH = A.MGMONTH
	                                     AND F.MG_FLAG = A.MG_FLAG                                                  
		WHERE A.HOSP_CD = #{hosp_cd}
		  AND A.MG_YEAR = #{mg_year}
		  AND A.MGMONTH = #{mgmonth}
		]]>
		<if test='mg_flag == "8"'><![CDATA[   
		   AND A.MG_FLAG IN ('8','Z') 
		]]></if>  
		<if test='mg_flag == "9"'><![CDATA[   
		   AND A.MG_FLAG IN ('9','Z') 
		]]></if>  
	   
	</select>
	 
	<insert id="uploadMagamFilesMain" parameterType="java.util.List">
		INSERT INTO TBL_FILES_DATA (
            HOSP_CD, MG_YEAR, MGMONTH, MG_FLAG,
            JOBS_DT, FILE_NM, LINE_NO, LINEVAL, CHUNGGU,
            REG_DTTM,REG_USER,REG_IP
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.hosp_cd}, #{item.mg_year},  #{item.mgmonth}, #{item.mg_flag},
                #{item.jobs_dt}, #{item.file_nm},  #{item.line_no}, #{item.lineval}, #{item.chunggu},
                NOW(),           #{item.reg_user}, #{item.reg_ip}
            )
        </foreach>
	</insert>
	
	<select id="selectMagamCheck" parameterType="MagamDTO" resultMap="magamMap">
		SELECT jobs_dt
		  FROM TBL_MAGAM_INFO
		 WHERE HOSP_CD  = #{hosp_cd}
           AND MG_YEAR  = #{mg_year}
           AND MGMONTH  = #{mgmonth}
           AND MG_FLAG  = #{mg_flag}
           AND JOBS_DT  = #{jobs_dt}
         LIMIT 1
	</select>
	
	<update id="updateMagamInfo" parameterType="MagamDTO">
        UPDATE TBL_MAGAM_INFO
           SET JOBS_DT  = #{jobs_dt}
             , UPD_DTTM = NOW()
             , UPD_USER = #{upd_user}
             , UPD_IP   = #{upd_ip}
         WHERE HOSP_CD  = #{hosp_cd}
           AND MG_YEAR  = #{mg_year}
           AND MGMONTH  = #{mgmonth}
           AND MG_FLAG  = #{mg_flag}
    </update>
    
    <insert id="insertMagamInfo" parameterType="MagamDTO">
        INSERT INTO TBL_MAGAM_INFO (
            HOSP_CD, MG_YEAR, MGMONTH, MG_FLAG, 
            JOBS_DT, REG_DTTM, REG_USER, REG_IP
        )
        VALUES (
            #{hosp_cd}, #{mg_year}, #{mgmonth},  #{mg_flag}, 
            #{jobs_dt}, NOW(),      #{reg_user}, #{reg_ip}
        )
    </insert>
    
    
    
    
    <!-- 저장 프로시저 호출 -->
    <select id="callUploadMagamFiles" statementType="CALLABLE">
        CALL SP_UPLOAD_MAGAM_FILES(#{filesDataJson, jdbcType=LONGVARCHAR})
    </select>
    
 	<select id="callUploadMagamSamFiles" statementType="CALLABLE">
    	{CALL SP_UPLOAD_MAGAM_SAMFILES(#{hosp_cd,   mode=IN}, 
    	                               #{mg_year,   mode=IN},
    	                               #{mgmonth,   mode=IN},
    	                               #{mg_flag,   mode=IN},
    	                               #{jobs_dt,   mode=IN},
    	                               #{reg_user,  mode=IN},
    	                               #{t_lines,   mode=IN},
    	                               #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                               #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	</select>
	<select id="callUploadMagamPatFiles" statementType="CALLABLE">
    	{CALL SP_UPLOAD_MAGAM_SAMFILES(#{hosp_cd,   mode=IN}, 
    	                               #{mg_year,   mode=IN},
    	                               #{mgmonth,   mode=IN},
    	                               #{mg_flag,   mode=IN},
    	                               #{jobs_dt,   mode=IN},
    	                               #{reg_user,  mode=IN},
    	                               #{t_lines,   mode=IN},
    	                               #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                               #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	</select>
	
	<select id="delMagamClaimNo" statementType="CALLABLE">
    	{CALL SP_DELETE_MAGAM_CLAIMNO2(#{hosp_cd,   mode=IN}, 
    								  #{mg_year,   mode=IN},
    	                              #{mgmonth,   mode=IN},
    	                              #{mg_flag,   mode=IN},
    	                              #{claim_no,  mode=IN}, 
    	                              #{reg_user,  mode=IN},
    	                              #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                              #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	</select>
	
	<update id="updateMagamLock" parameterType="MagamDTO">
        UPDATE TBL_MAGAM_INFO A
           SET A.LOCK_YN  = CASE WHEN A.LOCK_YN = 'Y' THEN 'N'
                                 WHEN A.LOCK_YN = 'N' THEN 'Y'
                                 ELSE A.LOCK_YN END
             , A.UPD_DTTM = NOW()
         WHERE A.HOSP_CD  = #{hosp_cd}
           AND A.MG_YEAR  = #{mg_year}
           AND A.MGMONTH  = #{mgmonth}
           AND A.MG_FLAG  = #{mg_flag}
               
    </update>
	
	
	<select id="dashbordMedExpenses" statementType="CALLABLE">
		{CALL SP_DASH_MEDICALEXPENSES(#{hosp_cd,   mode=IN,  jdbcType=VARCHAR}, 
    								  #{mg_year,   mode=IN,  jdbcType=VARCHAR},
    	                              #{mgmonth,   mode=IN,  jdbcType=VARCHAR},
    	                              #{totamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 총진료비 --> 
    	                              #{totamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 전월 총진료비 -->
    	                              #{yngamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 양방청구 -->
    	                              #{yngamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 전월 양방청구 -->
    	                              #{jngamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 정액청구 -->
    	                              #{jngamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 전월 정액청구 -->
    	                              #{hwiamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 행위청구 -->
    	                              #{hwiamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 전월 행위청구 -->    	                              
    	                              #{dayamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 일당진료비 --> 
    	                              #{dayamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 평균 일당진료비 -->
    	                              #{oneamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 건당진료비 -->
    	                              #{oneamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 평균 건당진료비 -->
    	                              #{tsuamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 특정수가비 -->
    	                              #{tsuamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 평균 특정수가비 -->
    	                              #{hanamt1,   mode=OUT, jdbcType=INTEGER}, <!-- 당월 한방청구액 -->
    	                              #{hanamt2,   mode=OUT, jdbcType=INTEGER}, <!-- 평균 한방청구액 -->    	                              
    	                              #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                              #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	
		
	</select>
	
	<select id="dashbordINDICATORS" statementType="CALLABLE">
		{CALL SP_DASH_INDICATORS(#{hosp_cd,   mode=IN,  jdbcType=VARCHAR}, 
   								 #{mg_year,   mode=IN,  jdbcType=VARCHAR},
   	                             #{mgmonth,   mode=IN,  jdbcType=VARCHAR},
   	                             #{goalName,  mode=OUT, jdbcType=VARCHAR}, <!-- 주기+주차 명 --> 
   	                             #{cQuarter,  mode=OUT, jdbcType=VARCHAR}, <!-- 분기 -->
   	                             #{goal_Val,  mode=OUT, jdbcType=INTEGER}, <!-- 목표점수 -->
   	                             #{hosGrade,  mode=OUT, jdbcType=VARCHAR}, <!-- 병원등급 -->
   	                             #{year_Val,  mode=OUT, jdbcType=DECIMAL}, <!-- 년간점수 (7월 ~ 12월 누적) -->
   	                             #{strValue,  mode=OUT, jdbcType=DECIMAL}, <!-- 구조영역 (7월 ~ 12월 누적) -->
   	                             #{medValue,  mode=OUT, jdbcType=DECIMAL}, <!-- 진료영역 (7월 ~ 12월 누적) -->
   	                             #{monthVal,  mode=OUT, jdbcType=DECIMAL}, <!-- 당월점수 (구조+진료) -->    	                              
   	                             #{checkNm1,  mode=OUT, jdbcType=VARCHAR}, <!-- 점검지표 1 --> 
   	                             #{checkNm2,  mode=OUT, jdbcType=VARCHAR}, <!-- 점검지표 1 -->
   	                             #{checkNm3,  mode=OUT, jdbcType=VARCHAR}, <!-- 점검지표 1 -->
   	                             #{checkNm4,  mode=OUT, jdbcType=VARCHAR}, <!-- 점검지표 1 -->
   	                             
								 #{month_07,  mode=OUT, jdbcType=DECIMAL}, <!-- 07월점수 (구조+진료) -->
								 #{month_08,  mode=OUT, jdbcType=DECIMAL}, <!-- 08월점수 (구조+진료) -->
								 #{month_09,  mode=OUT, jdbcType=DECIMAL}, <!-- 09월점수 (구조+진료) -->
								 #{month_10,  mode=OUT, jdbcType=DECIMAL}, <!-- 10월점수 (구조+진료) -->
								 #{month_11,  mode=OUT, jdbcType=DECIMAL}, <!-- 11월점수 (구조+진료) -->
								 #{month_12,  mode=OUT, jdbcType=DECIMAL}, <!-- 12월점수 (구조+진료) -->
   	                             #{errcode,   mode=OUT, jdbcType=VARCHAR},
   	                             #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	
		
	</select>
	
	<select id="crtTotalReport" statementType="CALLABLE">
    	{CALL SP_TOTAL_REPORT_JOB_CREATE(#{hosp_cd,   mode=IN}, 
    					   			     #{jobyymm,   mode=IN},
    	                                 #{make_fg,   mode=IN}, 
    	                                 #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                                 #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	</select>
	
	<select id="setTotalReport_01" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
		SELECT M.JOBCODE AS jobcode,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JOBNOTE END), 0) AS fr_yymm,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JOBNOTE END), 0) AS midyymm,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JOBNOTE END), 0) AS endyymm,
		       0 AS avg_val,
		       0 AS ta_hosp
		 FROM TBL_REPORT_MST M
		WHERE M.HOSP_CD = #{hosp_cd}  
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		GROUP BY M.JOBCODE  
	]]> 		 
    </select>
	
	<select id="setTotalReport_02" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
		WITH ValidMonths AS (
		    SELECT JOBCODE
		         , COUNT(DISTINCT CASE WHEN COALESCE(J_COUNT, 0) > 0 OR COALESCE(JAMOUNT, 0) > 0 
		                               THEN JOBYYMM 
		                           END) AS month_count 
		      FROM TBL_REPORT_MST 
		     WHERE HOSP_CD = #{hosp_cd}
		       AND JOBYYMM  BETWEEN #{fr_yymm} AND #{endyymm}
		       AND MAKE_FG  = #{make_fg}
		     GROUP BY JOBCODE
		)
		SELECT M.JOBCODE AS jobcode,
		
		       /* fr_yymm - JAMOUNT 그대로, J_COUNT [J_COUNT%] */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0), 2), '%]')
		                    ELSE ''
		               END
		           )
		       END AS fr_yymm,
		
		       /* midyymm */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0), 2), '%]')
		                    ELSE ''
		               END
		           )
		       END AS midyymm,
		
		       /* endyymm */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0), 2), '%]')
		                    ELSE ''
		               END
		           )
		       END AS endyymm,
		
		       /* avg_val 개별행: JAMOUNT 정수, J_COUNT [소수점2자리%] */
		       CASE
		           WHEN COALESCE(IF(VM.month_count > 0,
		                    FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / VM.month_count),
		                    0), 0) = 0
		            AND COALESCE(IF(VM.month_count > 0,
		                    ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / VM.month_count, 2),
		                    0), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               COALESCE(IF(VM.month_count > 0,
		                   FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / VM.month_count),
		                   0), 0),
		               CASE WHEN COALESCE(IF(VM.month_count > 0,
		                            ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / VM.month_count, 2),
		                            0), 0) > 0
		                    THEN CONCAT('[',
		                             COALESCE(IF(VM.month_count > 0,
		                                 ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / VM.month_count, 2),
		                                 0), 0), '%]')
		                    ELSE ''
		               END
		           )
		       END AS avg_val,
		
		       COALESCE(SUM(ROUND(CASE WHEN M.JOBYYMM = #{endyymm} THEN FN_TA_HOSP(#{hosp_cd}, #{endyymm}, #{make_fg}, M.JOBCODE) END)), 0) AS ta_e_ym
		
		  FROM TBL_REPORT_MST M
		  LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		 WHERE M.HOSP_CD = #{hosp_cd}
		   AND M.JOBYYMM  BETWEEN #{fr_yymm} AND #{endyymm}
		   AND M.MAKE_FG  = #{make_fg}
		 GROUP BY M.JOBCODE
		
		UNION ALL
		
		SELECT 'T' AS jobcode,
		
		       /* fr_yymm 합계(T) - J_COUNT [정수%] */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT END), 0)), '%]')
		                    ELSE ''
		               END
		           )
		       END AS fr_yymm,
		
		       /* midyymm 합계(T) */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT END), 0)), '%]')
		                    ELSE ''
		               END
		           )
		       END AS midyymm,
		
		       /* endyymm 합계(T) */
		       CASE 
		           WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0) = 0
		            AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0)),
		               CASE WHEN COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0) > 0
		                    THEN CONCAT('[', FLOOR(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT END), 0)), '%]')
		                    ELSE ''
		               END
		           )
		       END AS endyymm,
		
		       /* avg_val 합계(T)행: JAMOUNT 정수, J_COUNT [정수%] */
		       CASE
		           WHEN COALESCE(FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / COALESCE(MAX(VM.month_count), 1)), 0) = 0
		            AND COALESCE(FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT  END) / COALESCE(MAX(VM.month_count), 1)), 0) = 0
		           THEN ''
		           ELSE CONCAT(
		               COALESCE(FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / COALESCE(MAX(VM.month_count), 1)), 0),
		               CASE WHEN COALESCE(FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / COALESCE(MAX(VM.month_count), 1)), 0) > 0
		                    THEN CONCAT('[',
		                             COALESCE(FLOOR(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / COALESCE(MAX(VM.month_count), 1)), 0), '%]')
		                    ELSE ''
		               END
		           )
		       END AS avg_val,
		
		       0 AS ta_e_ym
		
		  FROM TBL_REPORT_MST M
		  LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		 WHERE M.HOSP_CD = #{hosp_cd}
		   AND M.JOBYYMM  BETWEEN #{fr_yymm} AND #{endyymm}
		   AND M.MAKE_FG  = #{make_fg}
		 ORDER BY jobcode;
    ]]> 		 
    </select>
    <select id="setTotalReport_03" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
    
    	WITH ValidMonths AS (
		   SELECT M.JOBCODE, 
		          COUNT(DISTINCT CASE WHEN COALESCE(M.J_COUNT, 0) > 0 OR COALESCE(M.JAMOUNT, 0) > 0 
		                              THEN M.JOBYYMM 
		                          END) AS month_count
		     FROM TBL_REPORT_MST M
		    WHERE M.HOSP_CD = #{hosp_cd}
		      AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		      AND M.MAKE_FG = #{make_fg}
		    GROUP BY M.JOBCODE
		)
		SELECT M.JOBCODE AS jobcode,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN FORMAT(M.JAMOUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS fr_yymm,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN FORMAT(M.JAMOUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS midyymm,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2')
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN FORMAT(M.JAMOUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS endyymm,
		       COALESCE(
		           CASE 
		               WHEN M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2') THEN 
		                   (SELECT 
		                       IF(VM.month_count > 0, 
		                          CONCAT(
		                              '[ ', FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                           AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2') THEN M.J_COUNT END) / VM.month_count, 2), 0), ' ] ',
		                                    FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                           AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y','Y1','Y2') THEN M.JAMOUNT END) / VM.month_count, 2), 0)
		                          ), '0')
		                    FROM ValidMonths VM 
		                    WHERE VM.JOBCODE = M.JOBCODE)
		               WHEN M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') THEN 
		                   (SELECT 
		                       IF(VM.month_count > 0, 
		                          FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                 AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') THEN M.JAMOUNT END) / VM.month_count, 2), 0), '0')
		                    FROM ValidMonths VM 
		                    WHERE VM.JOBCODE = M.JOBCODE)
		           END, '0') AS avg_val,
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{fr_yymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_f_ym,
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2')
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{midyymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_m_ym,                            
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y','Y1','Y2') 
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{endyymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_e_ym
		                               
		FROM TBL_REPORT_MST M
		LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		WHERE M.HOSP_CD = #{hosp_cd}    
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		GROUP BY M.JOBCODE
		
		UNION ALL
		
		SELECT 'T' AS jobcode,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS fr_yymm,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS midyymm,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS endyymm,
		       CONCAT('[ ', FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / COALESCE(MAX(VM.month_count), 1), 2), 0), ' ] ',
		                    FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / COALESCE(MAX(VM.month_count), 1), 2), 0))    AS avg_val,
		       0 AS ta_f_ym,
		       0 AS ta_m_ym,
		       0 AS ta_e_ym
		FROM TBL_REPORT_MST M
		LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		WHERE M.HOSP_CD = #{hosp_cd}    
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		  AND M.JOBCODE IN ('A', 'B', 'C', 'D')
		ORDER BY jobcode;
	    
    ]]> 		 
    </select> 
    <select id="setTotalReport_09" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
    
    	WITH ValidMonths AS (
		   SELECT M.JOBCODE, 
		          COUNT(DISTINCT CASE WHEN COALESCE(M.J_COUNT, 0) > 0 OR COALESCE(M.JAMOUNT, 0) > 0 
		                              THEN M.JOBYYMM 
		                          END) AS month_count
		     FROM TBL_REPORT_MST M
		    WHERE M.HOSP_CD = #{hosp_cd}
		      AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		      AND M.MAKE_FG = #{make_fg}
		    GROUP BY M.JOBCODE
		)
		SELECT M.JOBCODE AS jobcode,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') 
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FORMAT(M.JAMOUNT/M.J_COUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS fr_yymm,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') 
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FORMAT(M.JAMOUNT/M.J_COUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS midyymm,
		       COALESCE(GROUP_CONCAT(CASE 
		                               WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') 
		                               THEN CONCAT('[ ', M.J_COUNT, ' ] ', FORMAT(M.JAMOUNT, 0))
		                               WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FORMAT(M.JAMOUNT/M.J_COUNT, 0)
		                             END ORDER BY M.JOBYYMM SEPARATOR ', '), 0) AS endyymm,
		       COALESCE(
		           CASE 
		               WHEN M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') THEN 
		                   (SELECT 
		                       IF(VM.month_count > 0, 
		                          CONCAT(
		                              '[ ', FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                           AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') THEN M.J_COUNT END) / VM.month_count, 2), 0), ' ] ',
		                                    FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                           AND M.JOBCODE NOT IN ('U', 'V', 'X', 'Y') THEN M.JAMOUNT END) / VM.month_count, 2), 0)
		                          ), '0')
		                    FROM ValidMonths VM 
		                    WHERE VM.JOBCODE = M.JOBCODE)
		               WHEN M.JOBCODE IN ('U', 'V', 'X', 'Y') THEN 
		                   (SELECT 
		                       IF(VM.month_count > 0, 
		                          FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) 
		                                                 AND M.JOBCODE IN ('U', 'V', 'X', 'Y') THEN M.JAMOUNT END) / SUM(M.J_COUNT), 2), 0), '0')
		                    FROM ValidMonths VM 
		                    WHERE VM.JOBCODE = M.JOBCODE)
		           END, '0') AS avg_val,
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{fr_yymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_f_ym,
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{midyymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_m_ym,                            
		       ROUND(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} AND M.JOBCODE IN ('U', 'V', 'X', 'Y') 
		                               THEN FN_TA_HOSP(#{hosp_cd}, #{endyymm}, #{make_fg}, M.JOBCODE) END), 0), 0) AS ta_e_ym
		                               
		FROM TBL_REPORT_MST M
		LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		WHERE M.HOSP_CD = #{hosp_cd}    
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		GROUP BY M.JOBCODE
		
		UNION ALL
		
		SELECT 'T' AS jobcode,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS fr_yymm,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS midyymm,
		       CONCAT('[ ', SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.J_COUNT ELSE 0 END), ' ] ', FORMAT(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT ELSE 0 END), 0)) AS endyymm,
		       CONCAT('[ ', FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.J_COUNT END) / COALESCE(MAX(VM.month_count), 1), 2), 0), ' ] ',
		                    FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / COALESCE(MAX(VM.month_count), 1), 2), 0))        AS avg_val,
		       0 AS ta_f_ym,
		       0 AS ta_m_ym,
		       0 AS ta_e_ym
		FROM TBL_REPORT_MST M
		LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		WHERE M.HOSP_CD = #{hosp_cd}    
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		  AND M.JOBCODE IN ('A', 'B', 'C', 'D')
		ORDER BY jobcode;
	    

	    
    ]]> 		 
    </select>
    <select id="setTotalReport_11" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
	    WITH ValidMonths AS (
		    SELECT JOBCODE, 
		           COUNT(DISTINCT CASE WHEN COALESCE(JAMOUNT, 0) > 0 THEN JOBYYMM END) AS month_count
		      FROM TBL_REPORT_MST 
		     WHERE HOSP_CD = #{hosp_cd}
		       AND JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		       AND MAKE_FG = #{make_fg}
		     GROUP BY JOBCODE
		),
		TotalSummaryMonthly AS (
		    SELECT 
		        JOBYYMM,
		        SUM(CASE WHEN JOBCODE = 'A' THEN COALESCE(JAMOUNT, 0) ELSE 0 END) AS total_jinryo,
		        SUM(CASE WHEN JOBCODE = 'D' THEN COALESCE(JAMOUNT, 0) ELSE 0 END) AS total_gumsa
		    FROM TBL_REPORT_MST
		    WHERE HOSP_CD = #{hosp_cd}
		      AND JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		      AND MAKE_FG = #{make_fg}
		      AND JOBCODE IN ('A','D')
		    GROUP BY JOBYYMM
		)
		SELECT 
		    M.JOBCODE AS jobcode,
		
		    CASE 
		        WHEN M.JOBCODE = 'D' AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0) > 0 THEN 
		            CONCAT('[ ', 
		                   ROUND((MAX(CASE WHEN TSM.JOBYYMM = #{fr_yymm} THEN TSM.total_gumsa END) 
		                       / COALESCE(MAX(CASE WHEN TSM.JOBYYMM = #{fr_yymm} THEN TSM.total_jinryo END), 0)) * 100), 
		                   '% ] ', 
		                   FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0), 0))
		        ELSE 
		            FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN M.JAMOUNT END), 0), 0)
		    END AS fr_yymm,
		
		    CASE 
		        WHEN M.JOBCODE = 'D' AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0) > 0 THEN 
		            CONCAT('[ ', 
		                   ROUND((MAX(CASE WHEN TSM.JOBYYMM = #{midyymm} THEN TSM.total_gumsa END) 
		                       / COALESCE(MAX(CASE WHEN TSM.JOBYYMM = #{midyymm} THEN TSM.total_jinryo END), 0)) * 100), 
		                   '% ] ', 
		                   FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0), 0))
		        ELSE 
		            FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{midyymm} THEN M.JAMOUNT END), 0), 0)
		    END AS midyymm,
		
		    CASE 
		        WHEN M.JOBCODE = 'D' AND COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0) > 0 THEN 
		            CONCAT('[ ', 
		                   ROUND((MAX(CASE WHEN TSM.JOBYYMM = #{endyymm} THEN TSM.total_gumsa END) 
		                       / COALESCE(MAX(CASE WHEN TSM.JOBYYMM = #{endyymm} THEN TSM.total_jinryo END), 0)) * 100), 
		                   '% ] ', 
		                   FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0), 0))
		        ELSE 
		            FORMAT(COALESCE(SUM(CASE WHEN M.JOBYYMM = #{endyymm} THEN M.JAMOUNT END), 0), 0)
		    END AS endyymm,
		
		    CASE 
		        WHEN M.JOBCODE = 'D' AND ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / VM.month_count, 2) > 0 THEN 
		            CONCAT('[ ', 
		                ROUND((SUM(CASE WHEN TSM.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN TSM.total_gumsa END) 
		                    / COALESCE(SUM(CASE WHEN TSM.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN TSM.total_jinryo END), 0)) * 100), 
		                '% ] ',
		                COALESCE(
		                    IF(VM.month_count > 0, 
		                       FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / VM.month_count, 2), 0), 
		                       0)
		                )
		            )
		        ELSE 
		            COALESCE(
		                IF(VM.month_count > 0, 
		                   FORMAT(ROUND(SUM(CASE WHEN M.JOBYYMM IN (#{fr_yymm}, #{midyymm}, #{endyymm}) THEN M.JAMOUNT END) / VM.month_count, 2), 0), 
		                   0)
		            )
		    END AS avg_val
		
		FROM TBL_REPORT_MST M
		LEFT JOIN ValidMonths VM ON M.JOBCODE = VM.JOBCODE
		LEFT JOIN TotalSummaryMonthly TSM ON M.JOBYYMM = TSM.JOBYYMM
		WHERE M.HOSP_CD = #{hosp_cd}  
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		GROUP BY M.JOBCODE
		ORDER BY jobcode;

    ]]> 		 
    </select>
     
    <select id="setTotalReport_13" parameterType="MagamDTO" resultMap="magamMap"><![CDATA[
		SELECT M.JOBCODE AS jobcode,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{fr_yymm} THEN CONCAT('[ ',ROUND(M.J_COUNT),' ] / [ ',M.JAMOUNT,' ]') END), 0) AS fr_yymm,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{midyymm} THEN CONCAT('[ ',ROUND(M.J_COUNT),' ] / [ ',M.JAMOUNT,' ]') END), 0) AS midyymm,
		       COALESCE(MAX(CASE WHEN M.JOBYYMM = #{endyymm} THEN CONCAT('[ ',ROUND(M.J_COUNT),' ] / [ ',M.JAMOUNT,' ]') END), 0) AS endyymm,
		       0 AS avg_val,
		       0 AS ta_hosp
		 FROM TBL_REPORT_MST M
		WHERE M.HOSP_CD = #{hosp_cd}  
		  AND M.JOBYYMM BETWEEN #{fr_yymm} AND #{endyymm}
		  AND M.MAKE_FG = #{make_fg}
		GROUP BY M.JOBCODE
	]]> 		 
    </select>
    
    
          
    <insert id="saveGasanMst" parameterType="MagamDTO">
        INSERT INTO TBL_GASAN_MST(HOSP_CD,JOBYYMM,DOC_GRD,NUR_GRD,NUR_CNT,NEED_GA,DIETGA1,DIETGA2,DIETGA3,DIETGA4,REG_USER,UPD_USER,REG_DTTM,UPD_DTTM)
        VALUES (#{hosp_cd},#{jobyymm},#{doc_grd},#{nur_grd},#{nur_cnt},#{need_ga},#{dietga1},#{dietga2},#{dietga3},#{dietga4},#{reg_user},#{reg_user},NOW(),NOW())
        ON DUPLICATE KEY UPDATE DOC_GRD  = VALUES(DOC_GRD),
                                NUR_GRD  = VALUES(NUR_GRD),
                                NUR_CNT  = VALUES(NUR_CNT),
                                NEED_GA  = VALUES(NEED_GA),
                                DIETGA1  = VALUES(DIETGA1),
                                DIETGA2  = VALUES(DIETGA2),
                                DIETGA3  = VALUES(DIETGA3),
                                DIETGA4  = VALUES(DIETGA4),
                                UPD_USER = VALUES(UPD_USER),
                                UPD_DTTM = NOW();
    </insert>
     
    <delete id="deleteIpwonInfo" parameterType="IpwonDTO">
        DELETE FROM TBL_IPWON_INFO 
         WHERE HOSP_CD = #{hosp_cd}
           AND JOBYYMM = #{jobyymm}
    </delete>
    		    
    <insert id="insertIpwonInfo" parameterType="java.util.List">
        INSERT INTO TBL_IPWON_INFO (
            HOSP_CD, JOBYYMM, SEQ_NUM, 
            CHARTNO, PATNAME, IPWONDT, IPWONTM, TEWONDT, 
            TEWONTM, JUMINNO, DOCNAME, DEPT_NM, INSURNM, WORD_NM, ROOM_NM 
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.hosp_cd}, 
                #{item.jobyymm}, 
                #{item.seq_num},
                COALESCE(#{item.chartno},''), 
                COALESCE(#{item.patname},''), 
                COALESCE(#{item.ipwondt},''), 
                COALESCE(#{item.ipwontm},''), 
                COALESCE(#{item.tewondt},''), 
                COALESCE(#{item.tewontm},''),
                COALESCE(#{item.juminno},''), 
                COALESCE(#{item.docname},''), 
                COALESCE(#{item.dept_nm},''), 
                COALESCE(#{item.insurnm},''),
                COALESCE(#{item.word_nm},''), 
                COALESCE(#{item.room_nm},'')
            )
        </foreach>
    </insert>
    
    <insert id="AdmMagamInsert" parameterType="MagamDTO">
        INSERT INTO TBL_MAGAM_CHUNG(HOSP_CD,MG_YEAR,MGMONTH,MG_FLAG,CLAIM_NO,CLFORM_VER,CLAIM_TYPE,TREAT_TYPE,DATE_YM,CASE_CNT,TOT_AMT,CLAIM_AMT,FILE_NM,JOBS_DT,REG_USER,UPD_USER)
        VALUES (#{hosp_cd},#{mg_year},#{mgmonth},#{mg_flag},#{claim_no},#{clform_ver},#{claim_type},#{treat_type},#{date_ym},#{case_cnt},#{tot_amt},#{claim_amt},#{file_nm},#{jobs_dt},#{reg_user},#{reg_user})
        ON DUPLICATE KEY UPDATE CLFORM_VER = VALUES(CLFORM_VER),
                                CLAIM_TYPE = VALUES(CLAIM_TYPE),
                                TREAT_TYPE = VALUES(TREAT_TYPE),
                                CASE_CNT   = VALUES(CASE_CNT),
                                TOT_AMT    = VALUES(TOT_AMT),
                                CLAIM_AMT  = VALUES(CLAIM_AMT),
                                FILE_NM    = VALUES(FILE_NM),
                                JOBS_DT    = VALUES(JOBS_DT),
                                REG_USER   = VALUES(REG_USER),
                                UPD_USER   = VALUES(UPD_USER);
    </insert>
    
    <select id="create_Eval_Indi" statementType="CALLABLE">
    	{CALL SP_EVALUATION_INDICATORS_CREATE2(#{hosp_cd,   mode=IN}, 
    					   			           #{jobyymm,   mode=IN},
    	                                       #{reg_user,  mode=IN}, 
    	                                       #{errcode,   mode=OUT, jdbcType=VARCHAR},
    	                                       #{errmess,   mode=OUT, jdbcType=VARCHAR})}
	</select>
	
	<select id="select_Eval_Indi" parameterType="IndiDTO" resultMap="indiMap">
		SELECT distinct 
               p.cate_cd 	as cate_cd  	          
		     , replace(replace(replace(w.wevalue_nm,'욕창 관리 환자분율',''),'(',''),')','') as cate_nm 
			 , p.cate_fg		
			 , p.stryymm 		
			 , p.endyymm 		
			 , p.dtorval 		
			 , p.ntorval 
			 , CASE WHEN  p.cate_cd IN ('01','02','03','04','07') OR p.DTORVAL = 0 THEN ''
                    WHEN  w.START_INDI > (p.NTORVAL / p.DTORVAL * 100) THEN CONCAT('+', CEIL(w.START_INDI * p.DTORVAL / 100 - p.NTORVAL),'명')
                    WHEN (p.NTORVAL / p.DTORVAL * 100) > w.END_INDI    THEN CONCAT('-', CEIL(p.NTORVAL - w.END_INDI * p.DTORVAL / 100),'명')
                    ELSE  '' END AS  fiveZone		
			 , p.cal_val 		
			 , p.max_val 		
			 , p.stdweig 		
			 , p.weigval 		
			 , p.s_score
			 , p.jobyymm
		  FROM TBL_PAT_INDI p
		  JOIN (SELECT wm.*
		          FROM TBL_WEVALUE_MST wm
		          JOIN (SELECT CATE_CODE, MAX(STD_SCORE) AS MAX_SCORE
		                  FROM TBL_WEVALUE_MST
		                 WHERE ACTION_YN = 'Y'
		                   AND CONCAT(#{jobyymm},'01') BETWEEN START_DT AND END_DT
		                 GROUP BY CATE_CODE
		               ) maxs ON wm.CATE_CODE = maxs.CATE_CODE AND wm.STD_SCORE = maxs.MAX_SCORE
		         WHERE wm.ACTION_YN = 'Y'
		       ) w ON p.CATE_CD = w.CATE_CODE AND p.JOBYYMM BETWEEN w.START_DT AND w.END_DT
		  WHERE p.HOSP_CD = #{hosp_cd}
		    AND p.JOBYYMM = #{jobyymm}
		    AND p.CATE_CD NOT LIKE 'M%'
         UNION ALL
         SELECT '99' 	  	          
		     , '합계' 
			 , ''		
			 , '' 		
			 , '' 		
			 , '' 		
			 , '' 		
			 , '' 		
			 , ''
			 , '' 		
			 , sum(pi2.stdweig) 		
			 , sum(pi2.weigval) 		
			 , ''
			 , #{jobyymm}
		  FROM TBL_PAT_INDI      pi2
		 WHERE pi2.HOSP_CD = #{hosp_cd}
           AND pi2.JOBYYMM = #{jobyymm}
           AND pi2.CATE_CD NOT LIKE 'M%'
         ORDER BY cate_cd
           
           
	</select>
	
	<!-- 
	<select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    
		SELECT sub.patId
		     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) = 2 THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), 1), '*')
                    ELSE CONCAT(LEFT(COALESCE(sub.patNm, ''), 1), '*', RIGHT(COALESCE(sub.patNm, ''), 1)) END  AS patNm
			 , sub.admitDt
			 , sub.medStart
			 , sub.docDt	
			 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'Y' then '●' 
			        when sub.overdayYn = 'N' and sub.dangerYn = 'Y' then '○'
			        else '' end                                                 AS dangerHi
			 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'N' then '●' 
			        when sub.overdayYn = 'N' and sub.dangerYn = 'N' then '○'
			        else '' end                                                 AS dangerLow
			 , case when sub.overdayYn = 'Y' then '해당' else '' end              AS dressingYn 
		  FROM ( SELECT distinct 
					    LEFT(a.pat_id, 6)           AS patId,
					    a.pat_nm                    AS patNm,
					    a.admit_dt                  AS admitDt,
					    a.med_start                 AS medStart,
					    a.doc_dt                    AS docDt,
					    CASE WHEN ((SELECT SUM(DATEDIFF(COALESCE(CASE WHEN CAT_OUT = '00000000' AND CAT_IN != '00000000' 
					                                                  THEN LAST_DAY(STR_TO_DATE(CONCAT(#{jobYymm},'01'), '%Y%m%d'))
					                                                  WHEN CAT_OUT != '00000000' 
					                                                  THEN STR_TO_DATE(CAT_OUT, '%Y%m%d') 
					                                                  ELSE CAT_OUT 
					                                                  END,CURDATE()),
					                                    COALESCE(CASE WHEN CAT_IN = '00000000' AND CAT_OUT != '00000000' 
					                                                  THEN STR_TO_DATE('19990101', '%Y%m%d')
					                                                  WHEN CAT_IN != '00000000' 
					                                                  THEN STR_TO_DATE(CAT_IN, '%Y%m%d')  
					                                                  ELSE CAT_IN END,CURDATE())
					                                   )
					                          ) AS total_days
					                  FROM (SELECT CAT_IN_1  AS CAT_IN, 
					                               CAT_OUT_1 AS CAT_OUT UNION ALL
					                        SELECT CAT_IN_2, CAT_OUT_2  UNION ALL
					                        SELECT CAT_IN_3, CAT_OUT_3  UNION ALL
					                        SELECT CAT_IN_4, CAT_OUT_4  UNION ALL
					                        SELECT CAT_IN_5, CAT_OUT_5  UNION ALL
					                        SELECT CAT_IN_6, CAT_OUT_6  UNION ALL
					                        SELECT CAT_IN_7, CAT_OUT_7  UNION ALL
					                        SELECT CAT_IN_8, CAT_OUT_8  UNION ALL
					                        SELECT CAT_IN_9, CAT_OUT_9  UNION ALL
					                        SELECT CAT_IN_10,CAT_OUT_10 ) AS cat
					                  ) > 14 OR IFNULL(a.CAT_DUR, 0) > 14)
					         THEN 'Y' ELSE 'N' END AS overdayYn,
					         
					    CASE WHEN (BOWEL_CTL = 3) OR (PR_ULCER3 + PR_ULCER4 > 0 ) OR
					              (COMA      = 1 AND DRESSING  >= 4 AND WASHING    >= 4 AND BRUSHING  >= 4 AND 
					               BATHING  >= 4 AND EATING    >= 4 AND MOVE_POS   >= 4 AND SIT_UP    >= 4 AND 
					               TRANSFER >= 4 AND EXIT_ROOM >= 4 AND TOILET_USE >= 4 AND BEDRIDDEN >= 4) OR
					              (PARALYSIS = '1' OR ALL_LIMBS = '1' OR CEREBRAL_P = '1') 
					         THEN 'Y' ELSE 'N' END AS dangerYn
		
				   FROM TBL_PATVAL_MST a
				  WHERE a.HOSP_CD = #{hospCd}
				    AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
				    AND IFNULL(a.EVAL_TYPE, '') = '2'
				    AND IFNULL(a.PAT_CLASS, '') NOT LIKE 'A%' ) sub 
				    
	</select>
	 -->
	 <!-- 
	 <select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    
		WITH
			T_CUR AS (
			  SELECT a.PAT_ID, 
			         a.PAT_NM,
			         a.ADMIT_DT, 
			         a.MED_START,  
			         a.DOC_DT, 
			         a.CAT_IN_1,  a.CAT_OUT_1,
			         a.CAT_IN_2,  a.CAT_OUT_2,
			         a.CAT_IN_3,  a.CAT_OUT_3,
			         a.CAT_IN_4,  a.CAT_OUT_4,
			         a.CAT_IN_5,  a.CAT_OUT_5,
			         a.CAT_IN_6,  a.CAT_OUT_6,
			         a.CAT_IN_7,  a.CAT_OUT_7,
			         a.CAT_IN_8,  a.CAT_OUT_8,
			         a.CAT_IN_9,  a.CAT_OUT_9,
			         a.CAT_IN_10, a.CAT_OUT_10
			    FROM TBL_PATVAL_MST a
			   WHERE a.HOSP_CD = #{hospCd}
				 AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			     AND IFNULL(a.PAT_CLASS,'') NOT LIKE 'A%'
			     AND IFNULL(a.EVAL_TYPE,'') = '2'
			     AND REPLACE(CONCAT_WS('', a.CAT_IN_1,  a.CAT_OUT_1,
								           a.CAT_IN_2,  a.CAT_OUT_2,
								           a.CAT_IN_3,  a.CAT_OUT_3,
								           a.CAT_IN_4,  a.CAT_OUT_4,
								           a.CAT_IN_5,  a.CAT_OUT_5,
								           a.CAT_IN_6,  a.CAT_OUT_6,
								           a.CAT_IN_7,  a.CAT_OUT_7,
								           a.CAT_IN_8,  a.CAT_OUT_8,
								           a.CAT_IN_9,  a.CAT_OUT_9,
								           a.CAT_IN_10, a.CAT_OUT_10
								        ), '0', '' ) != ''
			),
			T_PREV AS (
			  SELECT distinct 
			         b.PAT_ID, 
			         b.DOC_DT,
			         b.CAT_IN_1,
			         b.CAT_IN_2,
			         b.CAT_IN_3,
			         b.CAT_IN_4,
			         b.CAT_IN_5,
			         b.CAT_IN_6,
			         b.CAT_IN_7,
			         b.CAT_IN_8,
			         b.CAT_IN_9,
			         b.CAT_IN_10
			    FROM TBL_PATVAL_MST b
			   WHERE b.HOSP_CD = #{hospCd}
			     AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			     AND IFNULL(b.PAT_CLASS, '') NOT LIKE 'A%'
				 AND REPLACE(CONCAT(b.CAT_IN_1,
			                        b.CAT_IN_2,
				                    b.CAT_IN_3,
				                    b.CAT_IN_4,
				                    b.CAT_IN_5,
				                    b.CAT_IN_6,
				                    b.CAT_IN_7,
				                    b.CAT_IN_8,
				                    b.CAT_IN_9,
				                    b.CAT_IN_10
				                 ), '0', '') != '' 
			),
			PREV_INS AS (
			  SELECT PAT_ID,
			         GREATEST(
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_1, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_2, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_3, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_4, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_5, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_6, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_7, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_8, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_9, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_10,'00000000','19990101'), '%Y%m%d'))
			         ) AS LAST_INSERT_DATE
			    FROM T_PREV
			   GROUP BY PAT_ID
			),
			EVENTS AS (
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_1, '0'), '%Y%m%d') AS IN_DT, STR_TO_DATE(NULLIF(CAT_OUT_1, '0'), '%Y%m%d') AS OUT_DT FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_2, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_2, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_3, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_3, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_4, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_4, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_5, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_5, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_6, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_6, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_7, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_7, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_8, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_8, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_9, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_9, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_10, '0'),'%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_10, '0'),'%Y%m%d') FROM T_CUR
			),
			DURATION_EVENTS AS (
			    SELECT 
			        E.PAT_ID,
			        E.PAT_NM,
			        E.ADMIT_DT, 
			        E.MED_START,      
			        E.DOC_DT,
			        E.IN_DT,    
			        E.OUT_DT,
			        COALESCE(E.IN_DT,  P.LAST_INSERT_DATE)              AS FINAL_IN_DT,
			        COALESCE(E.OUT_DT, STR_TO_DATE(E.DOC_DT, '%Y%m%d')) AS FINAL_OUT_DT
			    FROM EVENTS E
			    LEFT JOIN PREV_INS P 
			      ON E.PAT_ID = P.PAT_ID 
			    WHERE E.IN_DT IS NOT NULL OR E.OUT_DT IS NOT NULL
			),
			CHAINED_EVENTS AS (
			    SELECT *,
			           LAG(FINAL_OUT_DT) OVER (PARTITION BY PAT_ID ORDER BY FINAL_IN_DT) AS PREV_OUT
			      FROM DURATION_EVENTS
			),
			CHAIN_FLAGS AS (
			    SELECT *,CASE WHEN PREV_OUT IS NULL THEN 1 
			                  WHEN 1 >= DATEDIFF(FINAL_IN_DT, PREV_OUT) THEN 0
			                  ELSE 1 END AS IS_NEW_CHAIN
			    FROM CHAINED_EVENTS
			),
			CHAINED AS (
			    SELECT *,
			           SUM(IS_NEW_CHAIN) OVER (PARTITION BY PAT_ID ORDER BY FINAL_IN_DT ROWS UNBOUNDED PRECEDING) AS CHAIN_ID
			    FROM CHAIN_FLAGS
			),
			CHAIN_PERIOD AS (
			    SELECT 
			        PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, CHAIN_ID,
			        MIN(FINAL_IN_DT) AS CHAIN_START_DT,
			        MAX(FINAL_OUT_DT) AS CHAIN_END_DT,
			        DATEDIFF(MAX(FINAL_OUT_DT), MIN(FINAL_IN_DT)) AS CHAIN_DURATION
			    FROM CHAINED
			    GROUP BY PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, CHAIN_ID
			),
			CHAIN_SUMMARY AS (
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, 'Y' AS overdayYn
			      FROM CHAIN_PERIOD
			     WHERE CHAIN_DURATION > 14 
			)
			SELECT sub.patId
			     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) >= 1 
					    THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), CHAR_LENGTH(COALESCE(sub.patNm, '')) - 1), '*')
					    ELSE ''
					END AS patNm
				 , sub.admitDt
				 , sub.medStart
				 , sub.docDt	
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'Y' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'Y' then 'N'
				        else '' end                                                 AS dangerHi
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'N' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'N' then 'N'
				        else '' end                                                 AS dangerLow
				 , sub.overdayYn                                                    AS overDay 
				 
		     FROM (SELECT left(c.PAT_ID,6)            AS patId,
			              c.PAT_NM                    AS patNm,
					      c.ADMIT_DT                  AS admitDt,
					      c.MED_START                 AS medStart,
					      c.DOC_DT                    AS docDt,
					      COALESCE(cs.overdayYn, 'N') AS overdayYn,
					      MAX(CASE WHEN (c.BOWEL_CTL = 3)  OR (c.PR_ULCER3 + c.PR_ULCER4 > 0 ) OR 
					                    (c.COMA      = 1  AND  c.DRESSING  >= 4 AND c.WASHING    >= 4 AND c.BRUSHING  >= 4 AND 
					                     c.BATHING  >= 4  AND  c.EATING    >= 4 AND c.MOVE_POS   >= 4 AND c.SIT_UP    >= 4 AND 
					                     c.TRANSFER >= 4  AND  c.EXIT_ROOM >= 4 AND c.TOILET_USE >= 4 AND c.BEDRIDDEN >= 4) OR 
					                    (c.PARALYSIS = '1' OR  c.ALL_LIMBS = '1' OR c.CEREBRAL_P  = '1')
					               THEN 'Y' ELSE 'N' END ) AS dangerYn
					 FROM TBL_PATVAL_MST c
					 LEFT JOIN CHAIN_SUMMARY cs ON c.PAT_ID = cs.PAT_ID AND c.ADMIT_DT = cs.ADMIT_DT AND c.MED_START = cs.MED_START AND c.DOC_DT = cs.DOC_DT
					WHERE c.HOSP_CD = #{hospCd}
					  AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
					  AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
					  AND IFNULL(c.EVAL_TYPE,'') = '2'
					GROUP BY c.PAT_ID, c.PAT_NM, c.ADMIT_DT, c.MED_START, c.DOC_DT ) sub
	</select>
	-->
	<!-- 
	<select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    
		WITH
			T_CUR AS (
			  SELECT a.PAT_ID, 
			         a.PAT_NM,
			         a.ADMIT_DT, 
			         a.MED_START,  
			         a.DOC_DT, 
			         a.CAT_IN_1,  a.CAT_OUT_1,
			         a.CAT_IN_2,  a.CAT_OUT_2,
			         a.CAT_IN_3,  a.CAT_OUT_3,
			         a.CAT_IN_4,  a.CAT_OUT_4,
			         a.CAT_IN_5,  a.CAT_OUT_5,
			         a.CAT_IN_6,  a.CAT_OUT_6,
			         a.CAT_IN_7,  a.CAT_OUT_7,
			         a.CAT_IN_8,  a.CAT_OUT_8,
			         a.CAT_IN_9,  a.CAT_OUT_9,
			         a.CAT_IN_10, a.CAT_OUT_10
			    FROM TBL_PATVAL_MST a
			   WHERE a.HOSP_CD = #{hospCd}
				 AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			     AND IFNULL(a.INDWELL_CATH,'') = '1'
	             AND IFNULL(a.PAT_CLASS,'') NOT LIKE 'A%'
	             AND IFNULL(a.EVAL_TYPE,'') = '2'
			),
			T_PREV AS (
			  SELECT distinct 
			         b.PAT_ID, 
			         b.DOC_DT,
			         b.CAT_IN_1,
			         b.CAT_IN_2,
			         b.CAT_IN_3,
			         b.CAT_IN_4,
			         b.CAT_IN_5,
			         b.CAT_IN_6,
			         b.CAT_IN_7,
			         b.CAT_IN_8,
			         b.CAT_IN_9,
			         b.CAT_IN_10
			    FROM TBL_PATVAL_MST b
			   WHERE b.HOSP_CD = #{hospCd}
			     AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			     AND IFNULL(b.INDWELL_CATH,'') = '1'
	             AND IFNULL(b.PAT_CLASS,'') NOT LIKE 'A%'
			),
			PREV_INS AS (
			  SELECT PAT_ID,
			         GREATEST(
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_1, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_2, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_3, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_4, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_5, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_6, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_7, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_8, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_9, '00000000','19990101'), '%Y%m%d')),
			           MAX(STR_TO_DATE(REPLACE(CAT_IN_10,'00000000','19990101'), '%Y%m%d'))
			         ) AS LAST_INSERT_DATE
			    FROM T_PREV
			   GROUP BY PAT_ID
			),
			EVENTS AS (
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_1, '0'), '%Y%m%d') AS IN_DT, STR_TO_DATE(NULLIF(CAT_OUT_1, '0'), '%Y%m%d') AS OUT_DT FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_2, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_2, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_3, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_3, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_4, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_4, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_5, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_5, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_6, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_6, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_7, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_7, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_8, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_8, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_9, '0'), '%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_9, '0'), '%Y%m%d') FROM T_CUR
			    UNION ALL
			    SELECT PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, STR_TO_DATE(NULLIF(CAT_IN_10, '0'),'%Y%m%d'), STR_TO_DATE(NULLIF(CAT_OUT_10, '0'),'%Y%m%d') FROM T_CUR
			),
			DURATION_EVENTS AS (
			    SELECT 
			        E.PAT_ID,
			        E.PAT_NM,
			        E.ADMIT_DT, 
			        E.MED_START,      
			        E.DOC_DT,
			        COALESCE(E.IN_DT,  MAX(P.LAST_INSERT_DATE))              AS FINAL_IN_DT,
		            COALESCE(MAX(E.OUT_DT), STR_TO_DATE(E.DOC_DT, '%Y%m%d')) AS FINAL_OUT_DT
			    FROM EVENTS E
			    LEFT JOIN PREV_INS P ON E.PAT_ID = P.PAT_ID 
  		       GROUP BY E.PAT_ID, E.PAT_NM, E.ADMIT_DT, E.MED_START, E.DOC_DT, E.IN_DT 
			),
			CHAINED_EVENTS AS (
			    SELECT *,
			           LAG(FINAL_OUT_DT) OVER (PARTITION BY PAT_ID ORDER BY FINAL_IN_DT) AS PREV_OUT
			      FROM DURATION_EVENTS
			),
			CHAIN_FLAGS AS (
			    SELECT *,CASE WHEN PREV_OUT IS NULL THEN 1 
			                  WHEN 1 >= DATEDIFF(FINAL_IN_DT, PREV_OUT) THEN 0
			                  ELSE 1 END AS IS_NEW_CHAIN
			    FROM CHAINED_EVENTS
			),
			CHAINED AS (
			    SELECT *,
			           SUM(IS_NEW_CHAIN) OVER (PARTITION BY PAT_ID ORDER BY FINAL_IN_DT ROWS UNBOUNDED PRECEDING) AS CHAIN_ID
			    FROM CHAIN_FLAGS
			),
			CHAIN_PERIOD AS (
			    SELECT 
			        PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, CHAIN_ID,
			        MIN(FINAL_IN_DT) AS CHAIN_START_DT,
			        MAX(FINAL_OUT_DT) AS CHAIN_END_DT,
			        DATEDIFF(MAX(FINAL_OUT_DT), MIN(FINAL_IN_DT)) AS CHAIN_DURATION
			    FROM CHAINED
			    GROUP BY PAT_ID, PAT_NM, ADMIT_DT, MED_START, DOC_DT, CHAIN_ID
			),
			CHAIN_SUMMARY AS (
			    SELECT DISTINCT AA.*
			      FROM ( SELECT PAT_ID, ADMIT_DT, MED_START, DOC_DT, 'Y' AS overdayYn
					       FROM CHAIN_PERIOD
					      WHERE CHAIN_DURATION > 14 
					      UNION ALL
					     SELECT c.PAT_ID, c.ADMIT_DT, c.MED_START, c.DOC_DT, 'Y' AS overdayYn 
					       FROM TBL_PATVAL_MST c
				          WHERE c.HOSP_CD = #{hospCd}
			                AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
						    AND IFNULL(c.INDWELL_CATH,'') = '1'
						    AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
						    AND IFNULL(c.EVAL_TYPE,'') = '2'
						    AND c.CAT_IN_1 = '00000000'
						    AND NOT EXISTS ( SELECT 1
						                       FROM TBL_PATVAL_MST d
						                      WHERE d.HOSP_CD = #{hospCd}
						                        AND d.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
						                        AND d.PAT_ID  = c.PAT_ID
						                        AND IFNULL(d.PAT_CLASS, '') NOT LIKE 'A%'
						                        AND 14 > DATEDIFF(c.DOC_DT,d.ADMIT_DT) 
						                   )) AA
			     
			)
			SELECT sub.patId
			     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) >= 1 
					    THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), CHAR_LENGTH(COALESCE(sub.patNm, '')) - 1), '*')
					    ELSE ''
					END AS patNm
				 , sub.admitDt
				 , sub.medStart
				 , sub.docDt	
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'Y' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'Y' then 'N'
				        else '' end                                                 AS dangerHi
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'N' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'N' then 'N'
				        else '' end                                                 AS dangerLow
				 , sub.overdayYn                                                    AS overDay 
				 
		     FROM (SELECT left(c.PAT_ID,6)             AS patId,
			              c.PAT_NM                     AS patNm,
					      c.ADMIT_DT                   AS admitDt,
					      c.MED_START                  AS medStart,
					      c.DOC_DT                     AS docDt,
					      COALESCE(cs.overdayYn, 'N')  AS overdayYn,
					      MAX(CASE WHEN (c.BOWEL_CTL = 3)  OR (c.PR_ULCER3 + c.PR_ULCER4 > 0 ) OR 
					                    (c.COMA      = 1  AND  c.DRESSING  >= 4 AND c.WASHING    >= 4 AND c.BRUSHING  >= 4 AND 
					                     c.BATHING  >= 4  AND  c.EATING    >= 4 AND c.MOVE_POS   >= 4 AND c.SIT_UP    >= 4 AND 
					                     c.TRANSFER >= 4  AND  c.EXIT_ROOM >= 4 AND c.TOILET_USE >= 4 AND c.BEDRIDDEN >= 4) OR 
					                    (c.PARALYSIS = '1' OR  c.ALL_LIMBS = '1' OR c.CEREBRAL_P  = '1')
					               THEN 'Y' ELSE 'N' END ) AS dangerYn
					 FROM TBL_PATVAL_MST c
					 LEFT JOIN CHAIN_SUMMARY cs ON c.PAT_ID = cs.PAT_ID AND c.ADMIT_DT = cs.ADMIT_DT AND c.MED_START = cs.MED_START AND c.DOC_DT = cs.DOC_DT
					WHERE c.HOSP_CD = #{hospCd}
					  AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
					  AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
					  AND IFNULL(c.EVAL_TYPE,'') = '2'
					GROUP BY c.PAT_ID, c.PAT_NM, c.ADMIT_DT, c.MED_START, c.DOC_DT, cs.overdayYn ) sub
	</select>
	-->
	<!-- 
	<select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		SELECT sub.patId
			     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) >= 1 
					    THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), CHAR_LENGTH(COALESCE(sub.patNm, '')) - 1), '*')
					    ELSE ''
					END AS patNm
				 , sub.admitDt
				 , sub.medStart
				 , sub.docDt	
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'Y' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'Y' then 'N'
				        else '' end                                                 AS dangerHi
				 , case when sub.overdayYn = 'Y' and sub.dangerYn = 'N' then 'Y' 
				        when sub.overdayYn = 'N' and sub.dangerYn = 'N' then 'N'
				        else '' end                                                 AS dangerLow
				 , sub.overdayYn                                                    AS overDay 
				 
		     FROM (SELECT left(c.PAT_ID,6)             AS patId,
			              c.PAT_NM                     AS patNm,
					      c.ADMIT_DT                   AS admitDt,
					      c.MED_START                  AS medStart,
					      c.DOC_DT                     AS docDt,
					      MAX(PATIENT_CATHETER_CHECK(c.HOSP_CD,c.CLFORM_VER,c.PAT_ID,c.ADMIT_DT,c.MED_START,c.EVAL_TYPE,c.INDWELL_CATH,c.PAT_CLASS)) AS overdayYn,
					      MAX(CASE WHEN (c.BOWEL_CTL = 3)  OR (c.PR_ULCER3 + c.PR_ULCER4 > 0 ) OR 
					                    (c.COMA      = 1  AND  c.DRESSING  >= 4 AND c.WASHING    >= 4 AND c.BRUSHING  >= 4 AND 
					                     c.BATHING  >= 4  AND  c.EATING    >= 4 AND c.MOVE_POS   >= 4 AND c.SIT_UP    >= 4 AND 
					                     c.TRANSFER >= 4  AND  c.EXIT_ROOM >= 4 AND c.TOILET_USE >= 4 AND c.BEDRIDDEN >= 4) OR 
					                    (c.PARALYSIS = '1' OR  c.ALL_LIMBS = '1' OR c.CEREBRAL_P  = '1')
					               THEN 'Y' ELSE 'N' END ) AS dangerYn
					 FROM TBL_PATVAL_MST c
					WHERE c.HOSP_CD = #{hospCd}
					  AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
					  AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
					  AND IFNULL(c.EVAL_TYPE,'') = '2'
					GROUP BY c.PAT_ID, c.PAT_NM, c.ADMIT_DT, c.MED_START, c.DOC_DT ) sub
							
	</select> 
	 -->
	<!--   
	<select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		SELECT sub.patId
		     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) >= 1 
				    THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), CHAR_LENGTH(COALESCE(sub.patNm, '')) - 1), '*')
				    ELSE ''
				END AS patNm
			 , sub.admitDt
			 , sub.medStart
			 , sub.docDt
			 , CASE WHEN sub.dangerYn = 'Y' AND sub.overdayYn = 'Y' THEN 'Y'
			        WHEN sub.dangerYn = 'Y' AND sub.overdayYn = 'N' THEN 'N'
			        ELSE ''
			         END     AS dangerHi
			 , CASE WHEN sub.dangerYn = 'N' AND sub.overdayYn = 'Y' THEN 'Y'
			        WHEN sub.dangerYn = 'N' AND sub.overdayYn = 'N' THEN 'N'
			        ELSE ''
			         END     AS dangerLow
			 , sub.overdayYn AS overDay 
			
		  FROM (SELECT left(c.PAT_ID,6)             AS patId
		             , c.PAT_NM                     AS patNm
				     , c.ADMIT_DT                   AS admitDt
				     , c.MED_START                  AS medStart
				     , c.DOC_DT                     AS docDt
				     , MAX(PATIENT_CATHETER_CHECK(c.HOSP_CD,c.CLFORM_VER,c.PAT_ID,c.ADMIT_DT,c.MED_START,c.EVAL_TYPE,c.INDWELL_CATH,c.PAT_CLASS)) AS overdayYn
				     , MAX(CASE WHEN (c.BOWEL_CTL = 3)  OR (c.PR_ULCER3 + c.PR_ULCER4 > 0 ) OR 
				                     (c.COMA      = 1  AND  c.DRESSING  >= 4 AND c.WASHING    >= 4 AND c.BRUSHING  >= 4 AND 
				                      c.BATHING  >= 4  AND  c.EATING    >= 4 AND c.MOVE_POS   >= 4 AND c.SIT_UP    >= 4 AND 
				                      c.TRANSFER >= 4  AND  c.EXIT_ROOM >= 4 AND c.TOILET_USE >= 4 AND c.BEDRIDDEN >= 4) OR 
				                     (c.PARALYSIS = '1' OR  c.ALL_LIMBS = '1' OR c.CEREBRAL_P  = '1')
				                THEN 'Y' ELSE 'N' END ) AS dangerYn
				  FROM TBL_PATVAL_MST c
				 WHERE c.HOSP_CD = #{hospCd}
				   AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
				   AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
				   AND IFNULL(c.EVAL_TYPE,'') = '2'
				 GROUP BY c.PAT_ID, c.PAT_NM, c.ADMIT_DT, c.MED_START, c.DOC_DT ) sub
							
	</select> 
	-->
	
	<select id="select_CategoryList05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		SELECT sub.patId
		     , CASE WHEN CHAR_LENGTH(COALESCE(sub.patNm, '')) >= 1 
				    THEN CONCAT(LEFT(COALESCE(sub.patNm, ''), CHAR_LENGTH(COALESCE(sub.patNm, '')) - 1), '*')
				    ELSE ''
				END AS patNm
			 , sub.admitDt
			 , sub.medStart
			 , sub.docDt
			 , CASE WHEN sub.dangerYn = 'Y' AND sub.overdayYn = 'Y' THEN 'Y'
			        WHEN sub.dangerYn = 'Y' AND sub.overdayYn = 'N' THEN 'N'
			        ELSE ''
			         END     AS dangerHi
			 , CASE WHEN sub.dangerYn = 'N' AND sub.overdayYn = 'Y' THEN 'Y'
			        WHEN sub.dangerYn = 'N' AND sub.overdayYn = 'N' THEN 'N'
			        ELSE ''
			         END     AS dangerLow
			 , indwellCath        
			 , sub.overdayYn AS overDay 
			
		  FROM (SELECT left(c.PAT_ID,6)             AS patId
		             , c.PAT_NM                     AS patNm
				     , c.ADMIT_DT                   AS admitDt
				     , c.MED_START                  AS medStart
				     , c.DOC_DT                     AS docDt
				     , MAX(PATIENT_CATHETER_CHECK(c.HOSP_CD,c.CLFORM_VER,c.PAT_ID,c.ADMIT_DT,c.MED_START,c.EVAL_TYPE,c.INDWELL_CATH,c.PAT_CLASS)) AS overdayYn
				     , MAX(CASE WHEN (c.BOWEL_CTL = 3)  OR (c.PR_ULCER3 + c.PR_ULCER4 > 0 ) OR 
				                     (c.COMA      = 1  AND  c.DRESSING  >= 4 AND c.WASHING    >= 4 AND c.BRUSHING  >= 4 AND 
				                      c.BATHING  >= 4  AND  c.EATING    >= 4 AND c.MOVE_POS   >= 4 AND c.SIT_UP    >= 4 AND 
				                      c.TRANSFER >= 4  AND  c.EXIT_ROOM >= 4 AND c.TOILET_USE >= 4 AND c.BEDRIDDEN >= 4) OR 
				                     (c.PARALYSIS = '1' OR  c.ALL_LIMBS = '1' OR c.CEREBRAL_P  = '1')
				                THEN 'Y' ELSE 'N' END ) AS dangerYn
				     , MAX(INDWELL_CATH) AS   indwellCath           
				  FROM TBL_PATVAL_MST c
				 WHERE c.HOSP_CD = #{hospCd}
				   AND c.MED_START LIKE CONCAT(#{jobYymm},'%')
				   AND IFNULL(c.PAT_CLASS,'') NOT LIKE 'A%'
				   
				   AND ( 
				         c.EVAL_TYPE = '2'
				         OR 
				         (
				           c.EVAL_TYPE = '3'
				           AND DAY(STR_TO_DATE(c.MED_START, '%Y%m%d')) = 1
				           AND DAY(STR_TO_DATE(c.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
				           AND NOT EXISTS (SELECT 1
				                             FROM TBL_PATVAL_MST b
				                            WHERE b.HOSP_CD            = c.HOSP_CD
				                              AND b.PAT_ID             = c.PAT_ID
				                             /* AND b.EVAL_TYPE          = '3' */
				                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(c.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
				                              AND b.DOC_DT             = c.DOC_DT)
				         )
				       )
				       
				 GROUP BY c.PAT_ID, c.PAT_NM, c.ADMIT_DT, c.MED_START, c.DOC_DT ) sub
							
	</select> 
	 
	<select id="select_CategoryList07" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		SELECT DISTINCT
		       LEFT(pm.PAT_ID,6)                                  AS patId
		     , CASE WHEN CHAR_LENGTH(COALESCE(pm.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(pm.PAT_NM, ''), CHAR_LENGTH(COALESCE(pm.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
					       
		     , pm.ADMIT_DT                                        AS admitDt
		     , pm.MED_START                                       AS medStart  
		     , pm.DOC_DT                                          AS docDt   
		     , sb.DIAG_CODE                                       AS mainDiagCd  
		     , CASE WHEN sb.EDI_CODE IS NULL THEN '' ELSE '●' END AS psyOrderYn
		  FROM (SELECT a.HOSP_CD
		             , a.PAT_ID
		             , a.PAT_NM
		             , a.ADMIT_DT
		             , a.MED_START
		             , a.DOC_DT
		          FROM TBL_PATVAL_MST a
		         FORCE INDEX (INDEX01) 
		         WHERE a.HOSP_CD = #{hospCd}
				   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
				   AND IFNULL(a.EVAL_TYPE,'') = '2'
		       ) pm
		  LEFT JOIN (SELECT DISTINCT mm.HOSP_CD, mm.PAT_ID, dm.DIAG_CODE, jm.EDI_CODE
			           FROM TBL_CHUNG_MST   cm
		 	           JOIN TBL_MYOUNG_MST  mm ON cm.HOSP_CD  = mm.HOSP_CD  AND cm.CLAIM_NO = mm.CLAIM_NO	          
		 	           JOIN TBL_DISEASE_MST dm ON mm.HOSP_CD  = dm.HOSP_CD  AND mm.CLAIM_NO = dm.CLAIM_NO AND mm.BILL_SEQ = dm.BILL_SEQ
			           JOIN TBL_JINORD_MST  jm ON mm.HOSP_CD  = jm.HOSP_CD  AND mm.CLAIM_NO = jm.CLAIM_NO AND mm.BILL_SEQ = jm.BILL_SEQ
			           JOIN TBL_DRUG_MST    td ON jm.EDI_CODE = td.EDI_CODE
			          WHERE cm.HOSP_CD = #{hospCd}
			            AND cm.DATE_YM = #{jobYymm}
			            AND IFNULL(dm.DIAG_TYPE, '0') = '1'
			            AND td.CODEFLAG = 'A'
			            AND COALESCE(mm.DELYN,'') = ''
			            AND NOT EXISTS (SELECT 1
			                              FROM TBL_SPECODE_MST tsm
			                             WHERE tsm.HOSP_CD   = mm.HOSP_CD
			                               AND tsm.CLAIM_NO  = mm.CLAIM_NO
			                               AND tsm.BILL_SEQ  = mm.BILL_SEQ
			                               AND tsm.SPEC_TYPE = 'JS008')
			        ) sb
			       ON sb.HOSP_CD = pm.HOSP_CD AND sb.PAT_ID = pm.PAT_ID
	</select>
	<!-- 
	<select id="select_CategoryList09" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		SELECT DISTINCT
		       LEFT(pm.PAT_ID,6)              AS patId
		     , pm.PAT_NM                      AS patNm
		     , pm.ADMIT_DT                    AS admitDt
		     , pm.MED_START                   AS medStart  
		     , pm.DOC_DT                      AS docDt
		     , CAST(pm.PR_ULCER1 AS UNSIGNED) AS curtStep1
		     , CAST(pm.PR_ULCER2 AS UNSIGNED) AS curtStep2
		     , CAST(pm.PR_ULCER3 AS UNSIGNED) AS curtStep3
		     , CAST(pm.PR_ULCER4 AS UNSIGNED) AS curtStep4
		     , IFNULL(pm.PRESS_REL_DEV,0)     AS preRelDev
			 , IFNULL(pm.POS_CHANGE,0)        AS posChange
			 , IFNULL(pm.NUTR_SKIN,0)         AS nutSupply
			 , IFNULL(pm.SKIN_ULC_DRES,0)     AS skinDress
			 , CASE WHEN IFNULL(pm.PRESS_REL_DEV,0) = 1 AND 
			             IFNULL(pm.POS_CHANGE,0)    = 1 AND
				         IFNULL(pm.NUTR_SKIN,0)     = 1 AND 
				         IFNULL(pm.SKIN_ULC_DRES,0) = 1      
				    THEN 'Y'
				    WHEN CONCAT(CAST(pm.PR_ULCER1 AS UNSIGNED)
				               ,CAST(pm.PR_ULCER2 AS UNSIGNED)
				               ,CAST(pm.PR_ULCER3 AS UNSIGNED)
				               ,CAST(pm.PR_ULCER4 AS UNSIGNED)) = '1000' 
				    THEN 'Y'   
				    WHEN IFNULL(pm.PRESS_REL_DEV,0) = 0 OR 
			             IFNULL(pm.POS_CHANGE,0)    = 0 OR
				         IFNULL(pm.NUTR_SKIN,0)     = 0 OR 
				         IFNULL(pm.SKIN_ULC_DRES,0) = 0            
				    THEN 'N'
				    ELSE 'N' END AS dressingYn	     
		  FROM TBL_PATVAL_MST pm
		 WHERE pm.HOSP_CD = #{hospCd}
		   AND pm.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND CAST(pm.PR_ULCER1 AS UNSIGNED) +
		       CAST(pm.PR_ULCER2 AS UNSIGNED) +
		       CAST(pm.PR_ULCER3 AS UNSIGNED) +
		       CAST(pm.PR_ULCER4 AS UNSIGNED) > 0 
	</select>
	-->
	
	<!--  
	<select id="select_CategoryList09" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
			     , IFNULL(a.PRESS_REL_DEV,0)     AS preRelDev
				 , IFNULL(a.POS_CHANGE,0)        AS posChange
				 , IFNULL(a.NUTR_SKIN,0)         AS nutSupply
				 , IFNULL(a.SKIN_ULC_DRES,0)     AS skinDress
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND IFNULL(a.EVAL_TYPE,'') = '2'
			   
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			   
			   AND CAST(b.PR_ULCER1 AS UNSIGNED) +
			       CAST(b.PR_ULCER2 AS UNSIGNED) +
		           CAST(b.PR_ULCER3 AS UNSIGNED) +
		           CAST(b.PR_ULCER4 AS UNSIGNED) > 0 
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                   
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt    
			 , COALESCE(pm.prevStep1,0) AS prevStep1                   
			 , COALESCE(pm.prevStep2,0) AS prevStep2
			 , COALESCE(pm.prevStep3,0) AS prevStep3
			 , COALESCE(pm.prevStep4,0) AS prevStep4 
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 , cm.preRelDev
			 , cm.posChange
			 , cm.nutSupply
			 , cm.skinDress
			 
			 
			 /* 
			 , CASE WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			             
			        WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) = 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			             
			        WHEN COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND      
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			                  
			        WHEN CONCAT(cm.curtStep1,cm.curtStep2,cm.curtStep3,cm.curtStep4)               = '1000' AND
			             COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) = 3 THEN '1'
			        
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 THEN '2'
			             
			        ELSE '3' END AS dressingYn
			 */
			 , CASE WHEN COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
			             COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
                         COALESCE(cm.curtStep1,0) + COALESCE(cm.curtStep2,0) + 
                         COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
                         COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + 
                         COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4                            THEN '1'
			        WHEN COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
			             COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + COALESCE(cm.curtStep2,0) + 
			             COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) = 0 AND
			             COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + 
			             COALESCE(cm.nutSupply,0) = 3                                                       THEN '1'
			        
			        WHEN (((pm.prevStep1 > 0) AND CONCAT(pm.prevStep2, pm.prevStep3, pm.prevStep4) = '000') AND
                          ((cm.curtStep1 > 0) AND CONCAT(cm.curtStep2, cm.curtStep3, cm.curtStep4) = '000') AND 
                           (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                           
                    WHEN (((pm.prevStep2 > 0) AND CONCAT(pm.prevStep3, pm.prevStep4)               =  '00') AND
                          ((cm.curtStep1 > 0) AND CONCAT(cm.curtStep2, cm.curtStep3, cm.curtStep4) = '000') AND 
                           (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                           
                    WHEN ((COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
					       COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0) AND
                          (CONCAT(cm.curtStep1, cm.curtStep2, cm.curtStep3, cm.curtStep4) = '0000') AND 
                          (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                         
			        WHEN COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 THEN '2'
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND     
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '2'     
			        ELSE '3' END AS dressingYn
			        	    
			 , CASE WHEN cm.curtStep1 + cm.curtStep2 + cm.curtStep3 + cm.curtStep4 = 0 THEN 'N'
			        ELSE 'Y' END AS nextTarget
			         
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId
	</select>
	-->
	
	<select id="select_CategoryList09" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
			     , IFNULL(a.PRESS_REL_DEV,0)     AS preRelDev
				 , IFNULL(a.POS_CHANGE,0)        AS posChange
				 , IFNULL(a.NUTR_SKIN,0)         AS nutSupply
				 , IFNULL(a.SKIN_ULC_DRES,0)     AS skinDress
				 , IFNULL(FORMAT(WEIG / 10, 1),0)  AS weig
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND ( 
			         a.EVAL_TYPE = '2'
			         OR 
			         (
			           a.EVAL_TYPE = '3' 
			           AND DAY(STR_TO_DATE(a.MED_START, '%Y%m%d')) = 1
			           AND DAY(STR_TO_DATE(a.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
			           AND NOT EXISTS (SELECT 1
			                             FROM TBL_PATVAL_MST b
			                            WHERE b.HOSP_CD            = a.HOSP_CD
			                              AND b.PAT_ID             = a.PAT_ID
			                            /*  AND b.EVAL_TYPE          = '3' */
			                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
			                              AND b.DOC_DT             = a.DOC_DT)
			         )
			       )
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			   
			   AND b.ADMIT_DT = (SELECT MAX(c.ADMIT_DT)
			                       FROM TBL_PATVAL_MST c
			                      WHERE c.HOSP_CD   = b.HOSP_CD
			                        AND c.PAT_ID    = b.PAT_ID
			                        AND c.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%'))
			   
			   AND CAST(b.PR_ULCER1 AS UNSIGNED) +
			       CAST(b.PR_ULCER2 AS UNSIGNED) +
		           CAST(b.PR_ULCER3 AS UNSIGNED) +
		           CAST(b.PR_ULCER4 AS UNSIGNED) > 0 
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                   
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt    
			 , COALESCE(pm.prevStep1,0) AS prevStep1                   
			 , COALESCE(pm.prevStep2,0) AS prevStep2
			 , COALESCE(pm.prevStep3,0) AS prevStep3
			 , COALESCE(pm.prevStep4,0) AS prevStep4 
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 , cm.preRelDev
			 , cm.posChange
			 , cm.nutSupply
			 , cm.skinDress
			 , cm.weig 
			 
			 
			 /* 
			 , CASE WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			             
			        WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) = 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			             
			        WHEN COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND      
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			                  
			        WHEN CONCAT(cm.curtStep1,cm.curtStep2,cm.curtStep3,cm.curtStep4)               = '1000' AND
			             COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) = 3 THEN '1'
			        
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 THEN '2'
			             
			        ELSE '3' END AS dressingYn
			 */
			 , CASE WHEN COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
			             COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
                         COALESCE(cm.curtStep1,0) + COALESCE(cm.curtStep2,0) + 
                         COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
                         COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + 
                         COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4                            THEN '1'
			        WHEN COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
			             COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + COALESCE(cm.curtStep2,0) + 
			             COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) = 0 AND
			             COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + 
			             COALESCE(cm.nutSupply,0) = 3                                                       THEN '1'
			        
			        WHEN (((pm.prevStep1 > 0) AND CONCAT(pm.prevStep2, pm.prevStep3, pm.prevStep4) = '000') AND
                          ((cm.curtStep1 > 0) AND CONCAT(cm.curtStep2, cm.curtStep3, cm.curtStep4) = '000') AND 
                           (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                           
                    WHEN (((pm.prevStep2 > 0) AND CONCAT(pm.prevStep3, pm.prevStep4)               =  '00') AND
                          ((cm.curtStep1 > 0) AND CONCAT(cm.curtStep2, cm.curtStep3, cm.curtStep4) = '000') AND 
                           (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                           
                    WHEN ((COALESCE(pm.prevStep1,0) + COALESCE(pm.prevStep2,0) + 
					       COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0) AND
                          (CONCAT(cm.curtStep1, cm.curtStep2, cm.curtStep3, cm.curtStep4) = '0000') AND 
                          (COALESCE(cm.preRelDev,0) + COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0)) = 3) THEN '1'
                         
			        WHEN COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 AND
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '1'
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND
			             COALESCE(cm.curtStep1,0) + 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 THEN '2'
			        WHEN COALESCE(pm.prevStep1,0) + 
			             COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) > 0 AND     
			             COALESCE(cm.preRelDev,0) + 
			             COALESCE(cm.posChange,0) + COALESCE(cm.nutSupply,0) + COALESCE(cm.skinDress,0) = 4 THEN '2'     
			        ELSE '3' END AS dressingYn
			        	    
			 , CASE WHEN cm.curtStep1 + cm.curtStep2 + cm.curtStep3 + cm.curtStep4   = 0      THEN 'N'
			        WHEN CONCAT(cm.curtStep1,cm.curtStep2,cm.curtStep3,cm.curtStep4) = '1000' THEN 'N'
			        ELSE 'Y' END AS nextTarget
			         
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId
		  UNION ALL
		  SELECT distinct 
		       LEFT(tpm.PAT_ID,6)
			 , CASE WHEN CHAR_LENGTH(COALESCE(tpm.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(tpm.PAT_NM, ''), CHAR_LENGTH(COALESCE(tpm.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm                   
			 , tpm.ADMIT_DT                    
			 , tpm.MED_START                      
			 , tpm.DOC_DT
			 ,''
			 ,''
			 ,''
			 ,''
			 , CAST(tpm.PR_ULCER1 AS UNSIGNED) AS curtStep1
		     , CAST(tpm.PR_ULCER2 AS UNSIGNED) AS curtStep2
		     , CAST(tpm.PR_ULCER3 AS UNSIGNED) AS curtStep3
		     , CAST(tpm.PR_ULCER4 AS UNSIGNED) AS curtStep4
			 , IFNULL(tpm.PRESS_REL_DEV,0)     AS preRelDev
			 , IFNULL(tpm.POS_CHANGE,0)        AS posChange
			 , IFNULL(tpm.NUTR_SKIN,0)         AS nutSupply
			 , IFNULL(tpm.SKIN_ULC_DRES,0)     AS skinDress
			 , IFNULL(FORMAT(tpm.WEIG / 10, 1),0)   AS weig
			 , '9' AS dressingYn
			 , 'Y' AS nextTarget
			         
		  FROM TBL_PATVAL_MST tpm
		 WHERE tpm.HOSP_CD = #{hospCd}
		   AND tpm.MED_START LIKE CONCAT(#{jobYymm},'%')
		    
 		   AND tpm.PAT_ID NOT IN (SELECT cm2.patId
 		                            FROM current_month cm2
 		                            JOIN previousmonth pm2 ON cm2.patId = pm2.patId)   
		                             
		   AND CAST(tpm.PR_ULCER2 AS UNSIGNED) +
		       CAST(tpm.PR_ULCER3 AS UNSIGNED) +
		       CAST(tpm.PR_ULCER4 AS UNSIGNED) > 0
		       
		   AND FN_TEWON_CHECK(tpm.HOSP_CD,#{jobYymm},tpm.ADMIT_DT,tpm.PAT_NM) != 'Y'    
	</select>
	
	<!--  
	<select id="select_CategoryList10" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
			     , CASE WHEN a.MOVE_POS >= '3' OR a.SIT_UP >= '3' OR a.TRANSFER >= '3' OR a.EXIT_ROOM >= '3'
			              OR a.MOVE_POS  = '8' OR a.SIT_UP  = '8' OR a.TRANSFER  = '8' OR a.EXIT_ROOM  = '8'
			            THEN 'Y' ELSE 'N' END    AS dangerYn
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND IFNULL(a.EVAL_TYPE,'') = '2'
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId	
			     , b.ADMIT_DT                    AS admitDt		
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4			
			     , CASE WHEN b.MOVE_POS >= '3' OR b.SIT_UP >= '3' OR b.TRANSFER >= '3' OR b.EXIT_ROOM >= '3'
			              OR b.MOVE_POS  = '8' OR b.SIT_UP  = '8' OR b.TRANSFER  = '8' OR b.EXIT_ROOM  = '8'
			            THEN 'Y' ELSE 'N' END    AS dangerYn
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                        
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
			 , CASE WHEN pm.dangerYn   = 'Y' THEN '고' 
			        WHEN pm.dangerYn   = 'N' THEN '저' 
			        WHEN pm.dangerYn is null THEN '-'                    
			        ELSE '' END AS dangerPm
			        
			 , CASE WHEN cm.dangerYn   = 'Y' THEN '고' 
			        WHEN cm.dangerYn   = 'N' THEN '저' 
			        WHEN cm.dangerYn is null THEN '-'  
			        ELSE '' END AS dangerCm
			 , COALESCE(pm.prevStep1,'') AS prevStep1                   
			 , COALESCE(pm.prevStep2,'') AS prevStep2
			 , COALESCE(pm.prevStep3,'') AS prevStep3
			 , COALESCE(pm.prevStep4,'') AS prevStep4
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 
			 , CASE WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) = 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 
			        THEN '1' ELSE '2' END AS improveYn
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId AND cm.admitDt = pm.admitDt
		 WHERE pm.dangerYn = 'Y'
		   AND cm.dangerYn = 'Y'
		  
	</select>
	-->
	<select id="select_CategoryList10" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
			     , CASE WHEN a.MOVE_POS >= '3' OR a.SIT_UP >= '3' OR a.TRANSFER >= '3' OR a.EXIT_ROOM >= '3'
			              OR a.MOVE_POS  = '8' OR a.SIT_UP  = '8' OR a.TRANSFER  = '8' OR a.EXIT_ROOM  = '8'
			            THEN 'Y' ELSE 'N' END    AS dangerYn
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND ( 
			         a.EVAL_TYPE = '2'
			         OR 
			         (
			           a.EVAL_TYPE = '3'
			           AND DAY(STR_TO_DATE(a.MED_START, '%Y%m%d')) = 1
			           AND DAY(STR_TO_DATE(a.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
			           AND NOT EXISTS (SELECT 1
			                             FROM TBL_PATVAL_MST b
			                            WHERE b.HOSP_CD            = a.HOSP_CD
			                              AND b.PAT_ID             = a.PAT_ID
			                            /*  AND b.EVAL_TYPE          = '3' */
			                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
			                              AND b.DOC_DT             = a.DOC_DT)
			         )
			       )
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId	
			     , b.ADMIT_DT                    AS admitDt		
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4			
			     , CASE WHEN b.MOVE_POS >= '3' OR b.SIT_UP >= '3' OR b.TRANSFER >= '3' OR b.EXIT_ROOM >= '3'
			              OR b.MOVE_POS  = '8' OR b.SIT_UP  = '8' OR b.TRANSFER  = '8' OR b.EXIT_ROOM  = '8'
			            THEN 'Y' ELSE 'N' END    AS dangerYn
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			   
			   AND b.ADMIT_DT = (SELECT MAX(c.ADMIT_DT)
			                       FROM TBL_PATVAL_MST c
			                      WHERE c.HOSP_CD   = b.HOSP_CD
			                        AND c.PAT_ID    = b.PAT_ID
			                        AND c.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%'))
			   
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                        
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
			 , CASE WHEN pm.dangerYn   = 'Y' THEN '고' 
			        WHEN pm.dangerYn   = 'N' THEN '저' 
			        WHEN pm.dangerYn is null THEN '-'                    
			        ELSE '' END AS dangerPm
			        
			 , CASE WHEN cm.dangerYn   = 'Y' THEN '고' 
			        WHEN cm.dangerYn   = 'N' THEN '저' 
			        WHEN cm.dangerYn is null THEN '-'  
			        ELSE '' END AS dangerCm
			 , COALESCE(pm.prevStep1,'') AS prevStep1                   
			 , COALESCE(pm.prevStep2,'') AS prevStep2
			 , COALESCE(pm.prevStep3,'') AS prevStep3
			 , COALESCE(pm.prevStep4,'') AS prevStep4
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 
			 , CASE WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) = 0 AND
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0 
			        THEN '1' ELSE '2' END AS improveYn
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId AND cm.admitDt = pm.admitDt
		 WHERE pm.dangerYn = 'Y'
		   AND cm.dangerYn = 'Y'
		  
	</select>
	
	<!-- 
	<select id="select_CategoryList11" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
		         , FN_TEWON_CHECK(a.HOSP_CD,#{jobYymm},a.ADMIT_DT,a.PAT_NM) AS tewonYn
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND IFNULL(a.EVAL_TYPE,'') = '2'
			   
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId			
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4			
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			   
			   AND CAST(b.PR_ULCER2 AS UNSIGNED) +
		           CAST(b.PR_ULCER3 AS UNSIGNED) +
		           CAST(b.PR_ULCER4 AS UNSIGNED) > 0
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                         
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
			 , COALESCE(pm.prevStep1,'') AS prevStep1                   
			 , COALESCE(pm.prevStep2,'') AS prevStep2
			 , COALESCE(pm.prevStep3,'') AS prevStep3
			 , COALESCE(pm.prevStep4,'') AS prevStep4
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 
			 <![CDATA[
			 , CASE WHEN /* 개선 조건 충족, 악화 조건 미충족 */
			            ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			             OR 
			             CASE
			                 WHEN pm.prevStep4 > 0 THEN 4
			                 WHEN pm.prevStep3 > 0 THEN 3
			                 WHEN pm.prevStep2 > 0 THEN 2
			                 ELSE 0
			             END 
			             >
			             CASE
			                 WHEN cm.curtStep4 > 0 THEN 4
			                 WHEN cm.curtStep3 > 0 THEN 3
			                 WHEN cm.curtStep2 > 0 THEN 2
			                 ELSE 0
			             END
			            )
			            AND NOT (
			                (pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			                OR
			                CASE
			                    WHEN pm.prevStep4 > 0 THEN 4
			                    WHEN pm.prevStep3 > 0 THEN 3
			                    WHEN pm.prevStep2 > 0 THEN 2
			                    ELSE 0
			                END 
			                <
			                CASE
			                    WHEN cm.curtStep4 > 0 THEN 4
			                    WHEN cm.curtStep3 > 0 THEN 3
			                    WHEN cm.curtStep2 > 0 THEN 2
			                    ELSE 0
			                END
			            )
			        THEN '1' /* 개선 */
			        
			        WHEN ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			               AND
			              (pm.prevStep4 >= cm.curtStep4)
			               AND 
			              (pm.prevStep3 >= cm.curtStep3)
			               AND
			              (pm.prevStep2 >= cm.curtStep2) 
			             )
			        THEN '1' /* 개선 */
			        
			        WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) = 0 AND 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0
			        THEN '4' /* 공백 */ 
			        WHEN ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			               OR
			               CASE
			                   WHEN pm.prevStep4 > 0 THEN 4
			                   WHEN pm.prevStep3 > 0 THEN 3
			                   WHEN pm.prevStep2 > 0 THEN 2
			                   ELSE 0
			               END 
			               <
			               CASE
			                   WHEN cm.curtStep4 > 0 THEN 4
			                   WHEN cm.curtStep3 > 0 THEN 3
			                   WHEN cm.curtStep2 > 0 THEN 2
			                   ELSE 0
			               END
			            )
			        THEN '3' /* 미개선 */  
			        WHEN /* 악화 조건 충족, 개선 조건 충족 */
			            ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			             OR 
			             CASE
			                 WHEN pm.prevStep4 > 0 THEN 4
			                 WHEN pm.prevStep3 > 0 THEN 3
			                 WHEN pm.prevStep2 > 0 THEN 2
			                 ELSE 0
			             END 
			             <
			             CASE
			                 WHEN cm.curtStep4 > 0 THEN 4
			                 WHEN cm.curtStep3 > 0 THEN 3
			                 WHEN cm.curtStep2 > 0 THEN 2
			                 ELSE 0
			             END
			            )
			            AND ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			                OR
			                CASE
			                    WHEN pm.prevStep4 > 0 THEN 4
			                    WHEN pm.prevStep3 > 0 THEN 3
			                    WHEN pm.prevStep2 > 0 THEN 2
			                    ELSE 0
			                END 
			                >
			                CASE
			                    WHEN cm.curtStep4 > 0 THEN 4
			                    WHEN cm.curtStep3 > 0 THEN 3
			                    WHEN cm.curtStep2 > 0 THEN 2
			                    ELSE 0
			                END
			            )
			        THEN '2' /* 제외 */
			        ELSE '3' /* 미개선 */
			         END AS improveYn
			 ]]> 
             
             /* 2. 다음월 대상여부 컬럼 (퇴원제외(X) / 대상제외(N) / 대상(Y)) */       
             <![CDATA[
			 , CASE WHEN cm.tewonYn = 'Y' 
			        THEN 'X' /* 퇴원제외 */
			        WHEN cm.curtStep1 + cm.curtStep2 + cm.curtStep3 + cm.curtStep4 > 0 
			        THEN 'Y' /* 대상 */
			        ELSE '' END AS nextTarget
			 ]]>
  		            
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId
	</select>
	 -->
	
	<select id="select_CategoryList11" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH current_month AS (
			SELECT a.PAT_ID                      AS patId
			     , a.PAT_NM                      AS patNm
			     , a.ADMIT_DT                    AS admitDt
			     , a.MED_START                   AS medStart  
			     , a.DOC_DT                      AS docDt
			     , CAST(a.PR_ULCER1 AS UNSIGNED) AS curtStep1
		         , CAST(a.PR_ULCER2 AS UNSIGNED) AS curtStep2
		         , CAST(a.PR_ULCER3 AS UNSIGNED) AS curtStep3
		         , CAST(a.PR_ULCER4 AS UNSIGNED) AS curtStep4
		         , FN_TEWON_CHECK(a.HOSP_CD,#{jobYymm},a.ADMIT_DT,a.PAT_NM) AS tewonYn
			  FROM TBL_PATVAL_MST a
			 WHERE a.HOSP_CD = #{hospCd}
			   AND a.MED_START LIKE CONCAT(#{jobYymm},'%')
			   AND ( 
			         a.EVAL_TYPE = '2'
			         OR 
			         (
			           a.EVAL_TYPE = '3'
			           AND DAY(STR_TO_DATE(a.MED_START, '%Y%m%d')) = 1
			           AND DAY(STR_TO_DATE(a.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
			           AND NOT EXISTS (SELECT 1
			                             FROM TBL_PATVAL_MST b
			                            WHERE b.HOSP_CD            = a.HOSP_CD
			                              AND b.PAT_ID             = a.PAT_ID
			                            /*  AND b.EVAL_TYPE          = '3' */
			                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(a.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
			                              AND b.DOC_DT             = a.DOC_DT)
			         )
			       )
			   
		),
		previousmonth AS (
			SELECT b.PAT_ID                      AS patId			
			     , CAST(b.PR_ULCER1 AS UNSIGNED) AS prevStep1
		         , CAST(b.PR_ULCER2 AS UNSIGNED) AS prevStep2
		         , CAST(b.PR_ULCER3 AS UNSIGNED) AS prevStep3
		         , CAST(b.PR_ULCER4 AS UNSIGNED) AS prevStep4			
			  FROM TBL_PATVAL_MST b
			 WHERE b.HOSP_CD = #{hospCd}
			 
			   AND b.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
			   
			   AND b.ADMIT_DT = (SELECT MAX(c.ADMIT_DT)
			                       FROM TBL_PATVAL_MST c
			                      WHERE c.HOSP_CD   = b.HOSP_CD
			                        AND c.PAT_ID    = b.PAT_ID
			                        AND c.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%'))
			                         
			   AND CAST(b.PR_ULCER2 AS UNSIGNED) +
		           CAST(b.PR_ULCER3 AS UNSIGNED) +
		           CAST(b.PR_ULCER4 AS UNSIGNED) > 0
		       
		           
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                         
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
			 , COALESCE(pm.prevStep1,'') AS prevStep1                   
			 , COALESCE(pm.prevStep2,'') AS prevStep2
			 , COALESCE(pm.prevStep3,'') AS prevStep3
			 , COALESCE(pm.prevStep4,'') AS prevStep4
			 , cm.curtStep1                  
			 , cm.curtStep2
			 , cm.curtStep3
			 , cm.curtStep4
			 
			 <![CDATA[
			 , CASE WHEN /* 악화 조건 충족, 개선 조건 충족 */
			            ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			             OR 
			             CASE
			                 WHEN pm.prevStep4 > 0 THEN 4
			                 WHEN pm.prevStep3 > 0 THEN 3
			                 WHEN pm.prevStep2 > 0 THEN 2
			                 ELSE 0
			             END 
			             <
			             CASE
			                 WHEN cm.curtStep4 > 0 THEN 4
			                 WHEN cm.curtStep3 > 0 THEN 3
			                 WHEN cm.curtStep2 > 0 THEN 2
			                 ELSE 0
			             END
			            )
			            AND ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			                OR
			                CASE
			                    WHEN pm.prevStep4 > 0 THEN 4
			                    WHEN pm.prevStep3 > 0 THEN 3
			                    WHEN pm.prevStep2 > 0 THEN 2
			                    ELSE 0
			                END 
			                >
			                CASE
			                    WHEN cm.curtStep4 > 0 THEN 4
			                    WHEN cm.curtStep3 > 0 THEN 3
			                    WHEN cm.curtStep2 > 0 THEN 2
			                    ELSE 0
			                END
			            )
			        THEN '2' /* 제외 */
			        
			        WHEN /* 개선 조건 충족, 악화 조건 미충족 */
			            ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			             OR 
			             CASE
			                 WHEN pm.prevStep4 > 0 THEN 4
			                 WHEN pm.prevStep3 > 0 THEN 3
			                 WHEN pm.prevStep2 > 0 THEN 2
			                 ELSE 0
			             END 
			             >
			             CASE
			                 WHEN cm.curtStep4 > 0 THEN 4
			                 WHEN cm.curtStep3 > 0 THEN 3
			                 WHEN cm.curtStep2 > 0 THEN 2
			                 ELSE 0
			             END
			            )
			            AND NOT (
			                (pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			                OR
			                CASE
			                    WHEN pm.prevStep4 > 0 THEN 4
			                    WHEN pm.prevStep3 > 0 THEN 3
			                    WHEN pm.prevStep2 > 0 THEN 2
			                    ELSE 0
			                END 
			                <
			                CASE
			                    WHEN cm.curtStep4 > 0 THEN 4
			                    WHEN cm.curtStep3 > 0 THEN 3
			                    WHEN cm.curtStep2 > 0 THEN 2
			                    ELSE 0
			                END
			            )
			        THEN '1' /* 개선 */
			        
			        WHEN ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) > (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			               AND
			              (pm.prevStep4 >= cm.curtStep4)
			               AND 
			              (pm.prevStep3 >= cm.curtStep3)
			               AND
			              (pm.prevStep2 >= cm.curtStep2) 
			             )
			        THEN '1' /* 개선 */
			        
			        WHEN COALESCE(pm.prevStep2,0) + COALESCE(pm.prevStep3,0) + COALESCE(pm.prevStep4,0) = 0 AND 
			             COALESCE(cm.curtStep2,0) + COALESCE(cm.curtStep3,0) + COALESCE(cm.curtStep4,0) > 0
			        THEN '4' /* 공백 */ 
			        WHEN ((pm.prevStep2 + pm.prevStep3 + pm.prevStep4) < (cm.curtStep2 + cm.curtStep3 + cm.curtStep4)
			               OR
			               CASE
			                   WHEN pm.prevStep4 > 0 THEN 4
			                   WHEN pm.prevStep3 > 0 THEN 3
			                   WHEN pm.prevStep2 > 0 THEN 2
			                   ELSE 0
			               END 
			               <
			               CASE
			                   WHEN cm.curtStep4 > 0 THEN 4
			                   WHEN cm.curtStep3 > 0 THEN 3
			                   WHEN cm.curtStep2 > 0 THEN 2
			                   ELSE 0
			               END
			            )
			        THEN '3' /* 미개선 */  
			        
			        ELSE '3' /* 미개선 */
			         END AS improveYn
			 ]]> 
             
             /* 2. 다음월 대상여부 컬럼 (퇴원제외(X) / 대상제외(N) / 대상(Y)) */       
             <![CDATA[
			 , CASE WHEN cm.tewonYn = 'Y' 
			        THEN 'X' /* 퇴원제외 */
			        WHEN cm.curtStep1 > 0 AND cm.curtStep2 + cm.curtStep3 + cm.curtStep4 = 0
			        THEN 'N'  /* 당월 1단계만 존재시 제외 */ 
			        WHEN cm.curtStep1 + cm.curtStep2 + cm.curtStep3 + cm.curtStep4 > 0 
			        THEN 'Y' /* 대상 */
			        ELSE '' END AS nextTarget
			 ]]>
  		            
		  FROM current_month cm
		  JOIN previousmonth pm ON cm.patId = pm.patId
		  UNION ALL
		  SELECT distinct 
		       LEFT(tpm.PAT_ID,6)
			 , CASE WHEN CHAR_LENGTH(COALESCE(tpm.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(tpm.PAT_NM, ''), CHAR_LENGTH(COALESCE(tpm.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm                   
			 , tpm.ADMIT_DT                    
			 , tpm.MED_START                      
			 , tpm.DOC_DT
			 ,''
			 ,''
			 ,''
			 ,''
			 , CAST(tpm.PR_ULCER1 AS UNSIGNED) AS curtStep1
		     , CAST(tpm.PR_ULCER2 AS UNSIGNED) AS curtStep2
		     , CAST(tpm.PR_ULCER3 AS UNSIGNED) AS curtStep3
		     , CAST(tpm.PR_ULCER4 AS UNSIGNED) AS curtStep4
			 
			 , '4' AS improveYn
			 , 'Y' AS nextTarget
			         
		  FROM TBL_PATVAL_MST tpm
		 WHERE tpm.HOSP_CD = #{hospCd}
		   AND tpm.MED_START LIKE CONCAT(#{jobYymm},'%')
		    
 		   AND tpm.PAT_ID NOT IN (SELECT cm2.patId
 		                            FROM current_month cm2
		                            JOIN previousmonth pm2 ON cm2.patId = pm2.patId)   
		                             
		   AND CAST(tpm.PR_ULCER2 AS UNSIGNED) +
		       CAST(tpm.PR_ULCER3 AS UNSIGNED) +
		       CAST(tpm.PR_ULCER4 AS UNSIGNED) > 0
		       
		   AND FN_TEWON_CHECK(tpm.HOSP_CD,#{jobYymm},tpm.ADMIT_DT,tpm.PAT_NM) != 'Y' 
	</select>
	
	<!--  
	<select id="select_CategoryList12" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH
		current_month AS (
		SELECT d.PAT_ID                      AS patId
			 , d.PAT_NM                      AS patNm
			 , d.ADMIT_DT                    AS admitDt
			 , d.MED_START                   AS medStart  
			 , d.DOC_DT                      AS docDt
			 , FN_TEWON_CHECK(d.HOSP_CD,#{jobYymm},d.ADMIT_DT,d.PAT_NM) AS tewonYn
		     , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '1') AS cAdlScore
		  	 , CASE WHEN IFNULL(d.PAT_CLASS,'') = '' THEN LEFT(PATIENT_CLASSIFICATION(d.HOSP_CD, d.PAT_ID, d.CHUNGSEQ, d.CLFORM_VER, d.ADMIT_DT, d.MED_START),1)
		  	 			ELSE LEFT(d.PAT_CLASS,1) END AS cPatClass
		  FROM TBL_PATVAL_MST d
		 FORCE INDEX (INDEX01)
		 WHERE d.HOSP_CD = #{hospCd}
		   AND d.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND IFNULL(d.EVAL_TYPE,'') = '2'
		),
		previous_month AS (
		SELECT d.PAT_ID AS patId
		  	 , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '1') AS pAdlScore
		  	 , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '2') AS pAdl10Val
		  	 , CASE WHEN IFNULL(d.PAT_CLASS,'') = '' THEN LEFT(PATIENT_CLASSIFICATION(d.HOSP_CD, d.PAT_ID, d.CHUNGSEQ, d.CLFORM_VER, d.ADMIT_DT, d.MED_START),1)
		  	 			ELSE LEFT(d.PAT_CLASS,1) END AS pPatClass
		  FROM TBL_PATVAL_MST d
		 FORCE INDEX (INDEX01)
		 WHERE d.HOSP_CD = #{hospCd}
		   AND d.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                            
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
		     , pm.pPatClass
		     , pm.pAdl10Val       
		     , pm.pAdlScore
		     , cm.cPatClass
		     , cm.cAdlScore
		     
		     /*
		     , CASE WHEN cm.cPatClass IN ('A','E') OR pm.pPatClass IN ('A','E') OR pm.pAdl10Val = 1
		            THEN '2'  
		            WHEN pm.pAdlScore > cm.cAdlScore + 1  
		            THEN '1'
		            ELSE '3' END AS improveYn
		     */
		     , CASE WHEN cm.cPatClass IN ('A','E') AND pm.pPatClass IN ('A','E') OR pm.pAdl10Val = 1
		            THEN '3'
		            WHEN cm.cPatClass IN ('A','E') AND pm.pPatClass IS NULL
		            THEN '3'  
		            WHEN pm.pAdlScore > cm.cAdlScore  + 1  
		            THEN '1'
		            WHEN cm.cAdlScore - pm.pAdlScore >= 2     
		            THEN '2'
		            ELSE '4' END AS improveYn		              
		     
		     , cm.tewonYn        AS nextTarget
		     
		  FROM current_month cm
		  LEFT JOIN previous_month pm ON cm.patId = pm.patId
	</select>
	-->
	
	<select id="select_CategoryList12" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		WITH
		current_month AS (
		SELECT d.PAT_ID                      AS patId
			 , d.PAT_NM                      AS patNm
			 , d.ADMIT_DT                    AS admitDt
			 , d.MED_START                   AS medStart  
			 , d.DOC_DT                      AS docDt
			 , FN_TEWON_CHECK(d.HOSP_CD,#{jobYymm},d.ADMIT_DT,d.PAT_NM) AS tewonYn
		     , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '1') AS cAdlScore
		  	 , CASE WHEN IFNULL(d.PAT_CLASS,'') = '' THEN LEFT(PATIENT_CLASSIFICATION(d.HOSP_CD, d.PAT_ID, d.CHUNGSEQ, d.CLFORM_VER, d.ADMIT_DT, d.MED_START),1)
		  	 			ELSE LEFT(d.PAT_CLASS,1) END AS cPatClass
		  FROM TBL_PATVAL_MST d
		 FORCE INDEX (INDEX01)
		 WHERE d.HOSP_CD = #{hospCd}
		   AND d.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND ( 
		         d.EVAL_TYPE = '2'
		         OR 
		         (
		           d.EVAL_TYPE = '3'
		           AND DAY(STR_TO_DATE(d.MED_START, '%Y%m%d')) = 1
		           AND DAY(STR_TO_DATE(d.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
		           AND NOT EXISTS (SELECT 1
		                             FROM TBL_PATVAL_MST b
		                            WHERE b.HOSP_CD            = d.HOSP_CD
		                              AND b.PAT_ID             = d.PAT_ID
		                             /* AND b.EVAL_TYPE          = '3' */
		                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(d.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
		                              AND b.DOC_DT             = d.DOC_DT)
		         )
		       )
		),
		previous_month AS (
		SELECT d.PAT_ID AS patId
		  	 , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '1') AS pAdlScore
		  	 , ADL_SCORE_CHECK(d.DRESSING,d.WASHING,d.BRUSHING,d.BATHING,d.EATING,d.MOVE_POS,d.SIT_UP,d.TRANSFER,d.EXIT_ROOM,d.TOILET_USE, '2') AS pAdl10Val
		  	 , CASE WHEN IFNULL(d.PAT_CLASS,'') = '' THEN LEFT(PATIENT_CLASSIFICATION(d.HOSP_CD, d.PAT_ID, d.CHUNGSEQ, d.CLFORM_VER, d.ADMIT_DT, d.MED_START),1)
		  	 			ELSE LEFT(d.PAT_CLASS,1) END AS pPatClass
		  FROM TBL_PATVAL_MST d
		 FORCE INDEX (INDEX01)
		 WHERE d.HOSP_CD = #{hospCd}
		   AND d.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m'),'%')
		)
		SELECT distinct 
		       LEFT(cm.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(cm.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(cm.patNm, ''), CHAR_LENGTH(COALESCE(cm.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                            
			 , cm.admitDt                     
			 , cm.medStart                      
			 , cm.docDt  
		     , pm.pPatClass
		     , pm.pAdl10Val       
		     , pm.pAdlScore
		     , cm.cPatClass
		     , cm.cAdlScore
		     
		     /*
		     , CASE WHEN cm.cPatClass IN ('A','E') OR pm.pPatClass IN ('A','E') OR pm.pAdl10Val = 1
		            THEN '2'  
		            WHEN pm.pAdlScore > cm.cAdlScore + 1  
		            THEN '1'
		            ELSE '3' END AS improveYn
		     */
		     , CASE WHEN cm.cPatClass IN ('A','E') AND pm.pPatClass IN ('A','E') OR pm.pAdl10Val = 1
		            THEN '3'
		            WHEN cm.cPatClass IN ('A','E') AND pm.pPatClass IS NULL
		            THEN '3'  
		            WHEN pm.pAdlScore > cm.cAdlScore  + 1  
		            THEN '1'
		            WHEN cm.cAdlScore - pm.pAdlScore >= 2     
		            THEN '2'
		            ELSE '4' END AS improveYn		              
		     
		     , cm.tewonYn        AS nextTarget
		     
		  FROM current_month cm
		  LEFT JOIN previous_month pm ON cm.patId = pm.patId
	</select>
	
	<!--  
	<select id="select_CategoryList13" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    WITH
		patient_data AS (
		SELECT DISTINCT 
		       e.PAT_ID                            AS patId
			 , e.PAT_NM                            AS patNm
			 , e.MED_START                         AS medStart  
		     , e.DIABETES                          AS diabeYn
		     , e.HBA1C_TEST                        AS hba1cYn
		     , e.HBA1C_VALUE / 10                  AS eResult
		     , STR_TO_DATE(e.TEST_DATE,  '%Y%m%d') AS examiDt
		     , STR_TO_DATE(e.DOC_DT,     '%Y%m%d') AS docDt
		     , STR_TO_DATE(e.ADMIT_DT,   '%Y%m%d') AS admitDt
		     , MAX(COALESCE(tdm.DIAG_CODE,''))     AS preDiag
		     
		  FROM TBL_PATVAL_MST e
		  LEFT JOIN TBL_MYOUNG_MST  tmm ON tmm.HOSP_CD = e.HOSP_CD   AND tmm.PAT_ID   = e.PAT_ID
		  LEFT JOIN TBL_CHUNG_MST   tcm ON tcm.HOSP_CD = tmm.HOSP_CD AND tcm.CLAIM_NO = tmm.CLAIM_NO 
		                                                             AND tcm.DATE_YM  = DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m')
		  LEFT JOIN TBL_DISEASE_MST tdm ON tdm.HOSP_CD = tmm.HOSP_CD AND tdm.CLAIM_NO = tmm.CLAIM_NO 
		                                                             AND tdm.BILL_SEQ = tmm.BILL_SEQ
		                                                             AND LEFT(tdm.DIAG_CODE,3) IN ('E10','E11','E12','E13','E14')
		                                                             /* AND tdm.DIAG_CODE LIKE 'E1%' */
		                                                             /* AND tdm.DIAG_TYPE = '1' */
		 WHERE e.HOSP_CD = #{hospCd}
		   AND e.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND IFNULL(e.EVAL_TYPE,'') = '2'		   
		 GROUP BY  e.PAT_ID,e.PAT_NM,e.MED_START,e.DIABETES,e.HBA1C_TEST,e.HBA1C_VALUE,e.TEST_DATE,e.DOC_DT,e.ADMIT_DT 
		)
		SELECT distinct 
		       LEFT(pd.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(pd.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(pd.patNm, ''), CHAR_LENGTH(COALESCE(pd.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                        
			 , pd.admitDt                     
			 , pd.medStart                      
			 , pd.docDt 
			 , CASE WHEN pd.diabeYn = 0 THEN '' 
			        ELSE pd.diabeYn END AS diabeYn
			 , pd.hba1cYn
			 , pd.preDiag
			 , COALESCE(pd.examiDt,'')  AS examiDt
			 , CASE WHEN pd.eResult = 0 THEN '' 
			        ELSE pd.eResult END AS eResult
			 <![CDATA[
			 /*
	         , CASE WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, pd.admitDt)                 <= 90 THEN 'X'
	                WHEN pd.examiDt IS NOT NULL AND REPLACE(pd.examiDt,'-','') > pd.docDt                THEN 'X'
	                
	                WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, REPLACE(pd.examiDt,'-','')) >= 90 THEN '1'
		            WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, REPLACE(pd.examiDt,'-','')) <   0 THEN '2'
		            
		            WHEN pd.examiDt IS NOT NULL AND                    pd.eResult  >= 8.5 THEN '3'
		            
		            WHEN pd.examiDt IS NOT NULL AND                    pd.eResult  <    4 THEN '4'
		            
		            WHEN pd.diabeYn  = '1' AND ( pd.examiDt IS NULL OR 
		                                         pd.eResult IS NULL OR 
		                                         pd.eResult = 0 )                        THEN '5'
		                                         
		            WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 4 AND pd.eResult < 8.5 AND pd.examiDt <= pd.docDt THEN '6'
		            
		            WHEN pd.preDiag != ''       AND                     pd.diabeYn != '1' THEN 'Y'
		            ELSE '' END AS approYn
		     */
		     , CASE 
				    /* 입원 후 문서일(docDt)이 3개월(월 기준) 이내이면 'X' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt < DATE_ADD(pd.admitDt, INTERVAL 3 MONTH) THEN 'X'
				    
				    /* 검사일이 문서일보다 미래이면 'X' */
				    WHEN pd.examiDt IS NOT NULL AND REPLACE(pd.examiDt,'-','') > pd.docDt THEN 'X'
				    
				    /* 검사일로부터 3개월 경과 후 문서가 작성되면 '1' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt > DATE_ADD(STR_TO_DATE(pd.examiDt, '%Y-%m-%d'), INTERVAL 3 MONTH) THEN '1'
				    
				    /* 검사일이 문서일보다 미래이면 '2' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt < STR_TO_DATE(pd.examiDt, '%Y-%m-%d') THEN '2'
				    
				    /* 검사값이 8.5 이상이면 '3' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 8.5 THEN '3'
				    
				    /* 검사값이 4 미만이면 '4' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult < 4 THEN '4'
				    
				    /* 당뇨 진단인데 검사값이 없거나 0이면 '5' */
				    WHEN pd.diabeYn = '1' AND (pd.examiDt IS NULL OR pd.eResult IS NULL OR pd.eResult = 0) THEN '5'
				    
				    /* 검사값이 4 이상, 8.5 미만이고 검사일이 문서일 이전이면 '6' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 4 AND pd.eResult < 8.5 AND pd.examiDt <= pd.docDt THEN '6'
				    
				    /* 과거 진단이 있고, 당뇨 진단이 아닌 경우 'Y' */
				    WHEN pd.preDiag != '' AND pd.diabeYn != '1' THEN 'Y'
				    
				    ELSE '' END AS approYn
		            
	         ]]>  
			 , FN_TEWON_CHECK(#{hospCd},#{jobYymm},pd.admitDt,pd.patNm) AS tewonYn     
			   
	  	  FROM patient_data pd
	</select>
	-->
	
	<select id="select_CategoryList13" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    WITH
		patient_data AS (
		SELECT DISTINCT 
		       e.PAT_ID                            AS patId
			 , e.PAT_NM                            AS patNm
			 , e.MED_START                         AS medStart  
		     , e.DIABETES                          AS diabeYn
		     , e.HBA1C_TEST                        AS hba1cYn
		     , e.HBA1C_VALUE / 10                  AS eResult
		     , STR_TO_DATE(e.TEST_DATE,  '%Y%m%d') AS examiDt
		     , STR_TO_DATE(e.DOC_DT,     '%Y%m%d') AS docDt
		     , STR_TO_DATE(e.ADMIT_DT,   '%Y%m%d') AS admitDt
		     , MAX(COALESCE(tdm.DIAG_CODE,''))     AS preDiag
		     
		  FROM TBL_PATVAL_MST e
		  LEFT JOIN TBL_MYOUNG_MST  tmm ON tmm.HOSP_CD = e.HOSP_CD   AND tmm.PAT_ID   = e.PAT_ID
		       JOIN TBL_CHUNG_MST   tcm ON tcm.HOSP_CD = tmm.HOSP_CD AND tcm.CLAIM_NO = tmm.CLAIM_NO 
		                                                             AND tcm.DATE_YM  = DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm}, '01'), INTERVAL 1 MONTH), '%Y%m')
		  LEFT JOIN TBL_DISEASE_MST tdm ON tdm.HOSP_CD = tmm.HOSP_CD AND tdm.CLAIM_NO = tmm.CLAIM_NO 
		                                                             AND tdm.BILL_SEQ = tmm.BILL_SEQ
		                                                             AND LEFT(tdm.DIAG_CODE,3) IN ('E10','E11','E12','E13','E14')
		                                                             /* AND tdm.DIAG_CODE LIKE 'E1%' */
		                                                             /* AND tdm.DIAG_TYPE = '1' */
		 WHERE e.HOSP_CD = #{hospCd}
		   AND e.MED_START LIKE CONCAT(#{jobYymm},'%')
		   
		   AND ( 
		         e.EVAL_TYPE = '2'
		         OR 
		         (
		           e.EVAL_TYPE = '3'
		           AND DAY(STR_TO_DATE(e.MED_START, '%Y%m%d')) = 1
		           AND DAY(STR_TO_DATE(e.DOC_DT, '%Y%m%d')) BETWEEN 7 AND 10
		           AND NOT EXISTS (SELECT 1
		                             FROM TBL_PATVAL_MST b
		                            WHERE b.HOSP_CD            = e.HOSP_CD
		                              AND b.PAT_ID             = e.PAT_ID
		                             /* AND b.EVAL_TYPE          = '3' */
		                              AND LEFT(b.MED_START, 6) = DATE_FORMAT(DATE_SUB(STR_TO_DATE(e.MED_START, '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m')
		                              AND b.DOC_DT             = e.DOC_DT)
		         )
		        OR (   e.DIABETES = '0' 
                  AND tdm.DIAG_CODE IS NOT NULL
                  AND LEFT(tdm.DIAG_CODE, 3) IN ('E10','E11','E12','E13','E14')
                  )
		       )
		   	   
		 GROUP BY  e.PAT_ID,e.PAT_NM,e.MED_START,e.DIABETES,e.HBA1C_TEST,e.HBA1C_VALUE,e.TEST_DATE,e.DOC_DT,e.ADMIT_DT 
		)
		SELECT distinct 
		       LEFT(pd.patId,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(pd.patNm, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(pd.patNm, ''), CHAR_LENGTH(COALESCE(pd.patNm, '')) - 1), '*')
					ELSE '' END AS patNm                        
			 , pd.admitDt                     
			 , pd.medStart                      
			 , pd.docDt 
			 , CASE WHEN pd.diabeYn = 0 THEN '' 
			        ELSE pd.diabeYn END AS diabeYn
			 , pd.hba1cYn
			 , pd.preDiag
			 , COALESCE(pd.examiDt,'')  AS examiDt
			 , CASE WHEN pd.eResult = 0 THEN '' 
			        ELSE pd.eResult END AS eResult
			 <![CDATA[
			 /*
	         , CASE WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, pd.admitDt)                 <= 90 THEN 'X'
	                WHEN pd.examiDt IS NOT NULL AND REPLACE(pd.examiDt,'-','') > pd.docDt                THEN 'X'
	                
	                WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, REPLACE(pd.examiDt,'-','')) >= 90 THEN '1'
		            WHEN pd.examiDt IS NOT NULL AND DATEDIFF(pd.docDt, REPLACE(pd.examiDt,'-','')) <   0 THEN '2'
		            
		            WHEN pd.examiDt IS NOT NULL AND                    pd.eResult  >= 8.5 THEN '3'
		            
		            WHEN pd.examiDt IS NOT NULL AND                    pd.eResult  <    4 THEN '4'
		            
		            WHEN pd.diabeYn  = '1' AND ( pd.examiDt IS NULL OR 
		                                         pd.eResult IS NULL OR 
		                                         pd.eResult = 0 )                        THEN '5'
		                                         
		            WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 4 AND pd.eResult < 8.5 AND pd.examiDt <= pd.docDt THEN '6'
		            
		            WHEN pd.preDiag != ''       AND                     pd.diabeYn != '1' THEN 'Y'
		            ELSE '' END AS approYn
		     */
		     , CASE 
		    
				    /* 입원 후 문서일(docDt)이 3개월(월 기준) 이내이면 'X' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt < DATE_ADD(pd.admitDt, INTERVAL 3 MONTH) THEN 'X'
				    
				    /* 검사일이 문서일보다 미래이면 'X' */
				    WHEN pd.examiDt IS NOT NULL AND REPLACE(pd.examiDt,'-','') > pd.docDt THEN 'X'
				    
				    /* 검사일로부터 3개월 경과 후 문서가 작성되면 '1' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt > DATE_ADD(STR_TO_DATE(pd.examiDt, '%Y-%m-%d'), INTERVAL 3 MONTH) THEN '1'
				    
				    /* 검사일이 문서일보다 미래이면 '2' */
				    WHEN pd.examiDt IS NOT NULL AND pd.docDt < STR_TO_DATE(pd.examiDt, '%Y-%m-%d') THEN '2'
				    
				    /* 검사값이 8.5 이상이면 '3' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 8.5 THEN '3'
				    
				    /* 검사값이 4 미만이면 '4' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult < 4 THEN '4'
				    
				    /* 당뇨 진단인데 검사값이 없거나 0이면 '5' */
				    WHEN (pd.diabeYn = '1')  AND (pd.examiDt IS NULL OR pd.eResult IS NULL OR pd.eResult = 0) THEN '5'
				    
				    /* 검사값이 4 이상, 8.5 미만이고 검사일이 문서일 이전이면 '6' */
				    WHEN pd.examiDt IS NOT NULL AND pd.eResult >= 4 AND pd.eResult < 8.5 AND pd.examiDt <= pd.docDt THEN '6'
		     	
		     		/* 과거 진단이 있고, 당뇨 진단이 아닌 경우 'Y' */
				    WHEN pd.preDiag != '' AND pd.diabeYn != '1'  THEN 'Y'				    

				    
				    ELSE '' END AS approYn
		            
	         ]]>  
			 , FN_TEWON_CHECK(#{hospCd},#{jobYymm},pd.admitDt,pd.patNm) AS tewonYn     
			   
	  	  FROM patient_data pd
	</select>
	
	<!-- 
	<select id="select_CategoryList14" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    SELECT distinct 
		       LEFT(pm.PAT_ID,6) AS patId 
			 , CASE WHEN CHAR_LENGTH(COALESCE(pm.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(pm.PAT_NM, ''), CHAR_LENGTH(COALESCE(pm.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm                            
			 , pm.ADMIT_DT       AS admitDt  
			 , pm.MED_START      AS medStart                     
			 , pm.DOC_DT         AS docDt
			 
			 , CASE WHEN IFNULL(pm.PAT_CLASS,'') = '' THEN LEFT(PATIENT_CLASSIFICATION(pm.HOSP_CD, pm.PAT_ID, pm.CHUNGSEQ, pm.CLFORM_VER, pm.ADMIT_DT, pm.MED_START),1)
		  	 		ELSE LEFT(pm.PAT_CLASS,1) END AS cPatClass
		  	 
		  	 , CASE WHEN LEFT(IFNULL(pm.PAT_CLASS,PATIENT_CLASSIFICATION(pm.HOSP_CD, pm.PAT_ID, pm.CHUNGSEQ, pm.CLFORM_VER, pm.ADMIT_DT, pm.MED_START)),1) IN ('D','E')
			             AND DATEDIFF(COALESCE(ii.TEWONDT,DATE_FORMAT(pm.DOC_DT,'%Y%m%d')),DATE_FORMAT(pm.ADMIT_DT,'%Y%m%d')) + 1 >= 181
			        THEN 'Y' ELSE '' END AS longAdm       
			 
			 , CASE WHEN LEFT(IFNULL(pm.PAT_CLASS,PATIENT_CLASSIFICATION(pm.HOSP_CD, pm.PAT_ID, pm.CHUNGSEQ, pm.CLFORM_VER, pm.ADMIT_DT, pm.MED_START)),1) IN ('A','B','C')
			        THEN 'Y' ELSE '' END AS approYn  
	      
	      FROM TBL_PATVAL_MST      pm
		  LEFT JOIN TBL_IPWON_INFO ii ON ii.HOSP_CD         = pm.HOSP_CD
		                             AND ii.JOBYYMM         = #{jobYymm}
		                             AND LEFT(ii.JUMINNO,6) = LEFT(pm.PAT_ID,6)
		                             AND REPLACE(ii.IPWONDT,'-','') = pm.ADMIT_DT
		                             AND COALESCE(ii.TEWONDT,'')   != ''
		                             AND #{jobYymm} >= LEFT(REPLACE(ii.TEWONDT,'-',''),6) 
		                             AND pm.PAT_NM  = REGEXP_REPLACE(ii.PATNAME, '[0-9]', '')
		 WHERE pm.HOSP_CD = #{hospCd}
		   AND pm.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND IFNULL(pm.EVAL_TYPE,'') IN ('1','2')
		   AND LEFT(pm.PAT_CLASS,1) IN ('D','E')
		    
	</select>
	-->
	
	<select id="select_CategoryList14" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    WITH filtered_pat AS (
		    SELECT pm1.PAT_ID
		      FROM TBL_PATVAL_MST pm1
		     WHERE pm1.HOSP_CD = #{hospCd}
		       <![CDATA[
		       AND pm1.MED_START BETWEEN CONCAT(CASE WHEN CAST(SUBSTRING(#{jobYymm},5,2) AS UNSIGNED) <= 6 
		                                             THEN #{jobYymm} 
		                                             ELSE CONCAT(SUBSTRING(#{jobYymm},1,4),'07') END, '01')
		                             AND CONCAT(#{jobYymm}, '31')
		       ]]>     
		     GROUP BY pm1.PAT_ID
		    HAVING SUM(CASE WHEN LEFT(IFNULL(pm1.PAT_CLASS,PATIENT_CLASSIFICATION(pm1.HOSP_CD, pm1.PAT_ID, pm1.CHUNGSEQ, pm1.CLFORM_VER, pm1.ADMIT_DT, pm1.MED_START)),1) NOT IN ('D','E') 
		                    THEN 1 ELSE 0 END) = 0
		)
		SELECT DISTINCT 
		       LEFT(pm2.PAT_ID,6) AS patId 
		     , CASE WHEN CHAR_LENGTH(COALESCE(pm2.PAT_NM, '')) >= 1 
		            THEN CONCAT(LEFT(COALESCE(pm2.PAT_NM, ''), CHAR_LENGTH(COALESCE(pm2.PAT_NM, '')) - 1), '*')
		            ELSE '' END AS patNm
		     , pm2.ADMIT_DT     AS admitDt  
		     , pm2.MED_START    AS medStart                     
		     , pm2.DOC_DT       AS docDt
		       
		     , CASE WHEN IFNULL(pm2.PAT_CLASS,'') = '' 
		            THEN LEFT(PATIENT_CLASSIFICATION(pm2.HOSP_CD, pm2.PAT_ID, pm2.CHUNGSEQ, pm2.CLFORM_VER, pm2.ADMIT_DT, pm2.MED_START),1)
		            ELSE LEFT(pm2.PAT_CLASS,1) 
		             END AS cPatClass
		     , CASE WHEN LEFT(IFNULL(pm2.PAT_CLASS,PATIENT_CLASSIFICATION(pm2.HOSP_CD, pm2.PAT_ID, pm2.CHUNGSEQ, pm2.CLFORM_VER, pm2.ADMIT_DT, pm2.MED_START)),1) IN ('D','E') AND 
		                 DATEDIFF(COALESCE(ii.TEWONDT, DATE_FORMAT(pm2.DOC_DT,'%Y%m%d')), DATE_FORMAT(pm2.ADMIT_DT,'%Y%m%d')) + 1 >= 181 
		            THEN 'Y' ELSE '' 
		             END AS longAdm
		     , CASE WHEN LEFT(IFNULL(pm2.PAT_CLASS,PATIENT_CLASSIFICATION(pm2.HOSP_CD, pm2.PAT_ID, pm2.CHUNGSEQ, pm2.CLFORM_VER, pm2.ADMIT_DT, pm2.MED_START)),1) IN ('A','B','C') 
		            THEN 'Y' ELSE '' 
		             END AS approYn
		  FROM TBL_PATVAL_MST pm2
		  LEFT JOIN TBL_IPWON_INFO ii 
		         ON ii.HOSP_CD = pm2.HOSP_CD
		        <![CDATA[
		        AND ii.JOBYYMM BETWEEN CASE WHEN CAST(SUBSTRING(#{jobYymm},5,2) AS UNSIGNED) <= 6
		                                    THEN #{jobYymm}
		                                    ELSE CONCAT(SUBSTRING(#{jobYymm},1,4), '07')
		                                     END AND #{jobYymm}
		        ]]> 
		        AND LEFT(ii.JUMINNO,6) = LEFT(pm2.PAT_ID,6)
		        AND REPLACE(ii.IPWONDT,'-','') = pm2.ADMIT_DT
		        AND COALESCE(ii.TEWONDT,'')   != ''
		        AND #{jobYymm} >= LEFT(REPLACE(ii.TEWONDT,'-',''),6) 
		        AND pm2.PAT_NM  = REGEXP_REPLACE(ii.PATNAME, '[0-9]', '')
		
		  WHERE pm2.HOSP_CD = #{hospCd}
		    AND pm2.PAT_ID IN (SELECT fp.PAT_ID FROM filtered_pat fp)
		    <![CDATA[
		      AND pm2.MED_START BETWEEN CONCAT(CASE WHEN CAST(SUBSTRING(#{jobYymm},5,2) AS UNSIGNED) <= 6 THEN #{jobYymm}
		                                            ELSE CONCAT(SUBSTRING(#{jobYymm},1,4), '07') END, '01')
		                            AND CONCAT(#{jobYymm}, '31')
		    ]]>
	</select>
	
	
	<select id="select_assesCheck00" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    
		  -- [평가구분 오류 1] 계속입원자인데 평가구분이 1 또는 3인 경우 ( 전월대상 평가표에 평가구분이 1일면 제외 )
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
					        
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A1'                                              AS errType
			   , '계속 입원환자 중 당월 요양 개시일이 1일이고, 작성일이 당월 7~10일 사이 작성되었으나 평가구분이 1. 입원평가 또는 3. 이전 평가 적용인 경우(2. 계속입원)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND A.DOC_DT       LIKE CONCAT(#{jobYymm},'%')
		     AND A.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE IN ('1', '3')
		     AND (SELECT COUNT(B.PAT_ID)
		            FROM TBL_PATVAL_MST B
		           WHERE B.HOSP_CD  = A.HOSP_CD
		             AND B.PAT_ID   = A.PAT_ID
		             AND B.ADMIT_DT = A.ADMIT_DT
		             AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm},'01'), INTERVAL 1 MONTH), '%Y%m'),'%')
		             AND B.EVAL_TYPE IN ('2','3')) > 0                    
		UNION ALL
		
		  -- [평가구분 오류 2] 요양개시일(당월) 작성일(전월(말일-6 ~ 월말)) 평가구분 = 2
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A2'                                              AS errType
			   , '요양개시일이 당월인데, 평가표 작성일이 이전월에 작성되었으나 평가구분이 2. 계속입원중인평가로 체크된 경우(3. 이전평가 적용)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
			 AND STR_TO_DATE(A.DOC_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND A.EVAL_TYPE = '2'
		
		UNION ALL
		
		  -- [평가구분 오류 3] 전월말 입원+당월 평가+평가구분=1 대상자중 
		  --               당월 진료개시일이 1일이면서 평가구분 = 2인 대상자 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A3'                                              AS errType
			   , '월말 입원하여 익월에 평가표가 1. 입원평가로 작성되었으나, 당월 환자평가표 관찰기간에 포함되는 경우(관찰기간 겹침 오류)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '1'
		     AND STR_TO_DATE(A.ADMIT_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND EXISTS ( SELECT 1
		                    FROM TBL_PATVAL_MST B
		                   WHERE A.HOSP_CD    = B.HOSP_CD
		                     AND A.CHUNGSEQ   = B.CHUNGSEQ
		                     AND A.CLFORM_VER = B.CLFORM_VER
		                     AND A.PAT_ID     = B.PAT_ID
		                     AND A.ADMIT_DT   = B.ADMIT_DT
		                     --  진료개시일이 당월 1일이며, 평가구분이 2인 경우가 있으면
		                     AND B.MED_START  = CONCAT(#{jobYymm},'01')
		                     AND B.EVAL_TYPE  = '2' )
		
		UNION ALL
		
		  -- [작성일자 오류 1] 계속입원중인데 작성일이 요양개시일로부터 10일 이상 초과
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		      , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'B1'                                              AS errType
			   , '계속입원중인 평가 중 요양개시일 이후 평가표 작성 관찰기간이 10일을 초과하여 작성된 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND DATEDIFF(STR_TO_DATE(A.DOC_DT,   '%Y%m%d'), 
		                  STR_TO_DATE(A.MED_START,'%Y%m%d')) > 10
		     AND A.EVAL_TYPE = '2'
		
		UNION ALL
		
		  -- [작성일자 오류 2] 계속 입원 중인 대상자 중 특정기간 등으로 인하여 월말(-6) 에 평가표가 작성
		  --               진료개시일이 당월 1일이면
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'B2'                                              AS errType
			   , '당월 평가표 요양개시일이 1일인데, 전월 말일에 평가표가 작성되어 관찰기간 중복 가능성이 있는 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '2'
		     AND STR_TO_DATE(A.DOC_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND EXISTS ( SELECT 1
		                    FROM TBL_PATVAL_MST B
		                   WHERE B.HOSP_CD    = A.HOSP_CD
		                     AND B.CHUNGSEQ   = A.CHUNGSEQ
		                     AND B.CLFORM_VER = A.CLFORM_VER
		                     AND B.PAT_ID     = A.PAT_ID
		                     AND B.ADMIT_DT   = A.ADMIT_DT
		                     --  진료개시일이 당월 1일이면
		                     AND B.MED_START  = CONCAT(#{jobYymm},'01') )
		
		UNION ALL
		
		  -- [작성일자 오류 3] 당월 요양개시일에 평가구분 IN ('1','2') 대상중
		  --              요양개시일자 다르고, 평가구분이 2가 아닌 대상
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
		              THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
		              ELSE '' END                                  AS patNm
		       , A.ADMIT_DT                                        AS admitDt
		       , B.MED_START                                       AS medStart		       
		       , A.DOC_DT                                          AS docDt
		       , B.EVAL_TYPE                                       AS evalType
		       , 'B3'                                              AS errType
		       , '당월 요양개시일에 평가구분이 1 또는 2로 작성된 대상자 중, 다른 평가표의 개시일이 다르고 평가구분이 2가 아닌 경우' AS errName
		    FROM TBL_PATVAL_MST A
		    JOIN TBL_PATVAL_MST B
  		      ON B.HOSP_CD    = A.HOSP_CD
  		     AND B.CHUNGSEQ   = A.CHUNGSEQ
  		     AND B.CLFORM_VER = A.CLFORM_VER
		     AND B.PAT_ID     = A.PAT_ID
		     AND B.ADMIT_DT   = A.ADMIT_DT
		     AND B.DOC_DT    != A.DOC_DT
		     AND B.EVAL_TYPE != '2'
		     AND B.MED_START != A.MED_START
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE IN ('1','2')
		
		UNION ALL
		
		  -- [환자분류 오류 1] 환자평가표가 2회 작성된 대상자 중 환자분류군이 다를 경우
		  --               계속 입원중인 환자 중(당월 재입원대상자 제외) 
		  --               환자평가표가 2회 작성된 대상자 중 환자분류군이 다를 경우
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'C1'                                              AS errType
			   , '당월 환자평가표가 2개 이상 작성되었을 때 환자분류군이 다를 경우(당월 재입원대상자 제외)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND A.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '2'
		     AND A.PAT_ID IN ( SELECT B.PAT_ID
		                         FROM TBL_PATVAL_MST B
		                        WHERE B.HOSP_CD = #{hospCd}
		                          AND B.MED_START    LIKE CONCAT(#{jobYymm},'%')
		                          AND B.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		                          AND B.EVAL_TYPE = '2'
		                        GROUP BY B.PAT_ID 
		                       HAVING COUNT(*) >= 2 
		                          AND COUNT(DISTINCT B.PAT_CLASS) > 1 )
		
		UNION ALL
		
		  -- [환자분류 오류 2] 당월평가표 개시일 1일, 작성일 7~10일 사이 작성되었으나, 
		  --               평가구분이 3 이전평가표로 체크되어 있는 경우
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'C2'                                              AS errType
			   , '당월 환자평가표 개시일 1일이고, 작성일 7~10일 사이 작성되었으나 평가구분이 3. 이전평가표로 체크되어 있는 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD   = #{hospCd}
		     AND A.MED_START = CONCAT(#{jobYymm},'01')
		     AND RIGHT(A.DOC_DT, 2) BETWEEN '07' AND '10'
		     AND A.EVAL_TYPE = '3'
		
		UNION ALL
		
		-- [유치도뇨관 오류 1,2] 1. 중복 삽입일자, 2. 삽입일자 확인불가
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
		       , A.MED_START                                       AS medStart  
		       , A.DOC_DT                                          AS docDt
		       , A.EVAL_TYPE                                       AS evalType
		       , CASE WHEN C.LAST_FG = '1' THEN 'D1' ELSE 'D2' END AS errType
		       
		       , CASE WHEN C.LAST_FG = '1' THEN '전월환자평가표 상 마지막 기록이 삽입일자 이나, 당월평가표에 삽입일자가 작성되어 있는 경우 (삽입일자 중복작성 오류)' 
		              ELSE '전월환자평가표 상 마지막 기록이 제거일자 이나, 당월평가표에 삽입일자 공란, 제거일자가 작성되어 있는 경우 (삽입일자 확인불가)' END AS errName
		       
		       
		    FROM TBL_PATVAL_MST A
		    JOIN (SELECT B.HOSP_CD
		               , B.PAT_ID
		               , B.ADMIT_DT
		               , B.DOC_DT
				       -- 마지막이 삽입,제거 확인
		  		       , CASE WHEN B.CAT_OUT_10 != '00000000' THEN '2'
				              WHEN B.CAT_IN_10  != '00000000' THEN '1'
				              WHEN B.CAT_OUT_9  != '00000000' THEN '2'
				              WHEN B.CAT_IN_9   != '00000000' THEN '1'
				  	          WHEN B.CAT_OUT_8  != '00000000' THEN '2'
				 	          WHEN B.CAT_IN_8   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_7  != '00000000' THEN '2'
					          WHEN B.CAT_IN_7   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_6  != '00000000' THEN '2'
					          WHEN B.CAT_IN_6   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_5  != '00000000' THEN '2'
					          WHEN B.CAT_IN_5   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_4  != '00000000' THEN '2'
					          WHEN B.CAT_IN_4   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_3  != '00000000' THEN '2'
					          WHEN B.CAT_IN_3   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_2  != '00000000' THEN '2'
					          WHEN B.CAT_IN_2   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_1  != '00000000' THEN '2'
				 	          WHEN B.CAT_IN_1   != '00000000' THEN '1'
					          ELSE '0' END AS LAST_FG
		           FROM TBL_PATVAL_MST B
		          WHERE B.HOSP_CD = #{hospCd}
		            AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		            AND REPLACE(CONCAT(B.CAT_IN_1 ,B.CAT_IN_2 ,B.CAT_IN_3 ,B.CAT_IN_4 ,B.CAT_IN_5 ,
		                               B.CAT_IN_6 ,B.CAT_IN_7 ,B.CAT_IN_8 ,B.CAT_IN_9 ,B.CAT_IN_10,
		                               B.CAT_OUT_1,B.CAT_OUT_2,B.CAT_OUT_3,B.CAT_OUT_4,B.CAT_OUT_5,
		                               B.CAT_OUT_6,B.CAT_OUT_7,B.CAT_OUT_8,B.CAT_OUT_9,B.CAT_OUT_10),'0','') != '' 
		         ) C ON A.HOSP_CD  = C.HOSP_CD 
		            AND A.PAT_ID   = C.PAT_ID 
		            AND A.ADMIT_DT = C.ADMIT_DT
		  WHERE A.HOSP_CD = #{hospCd}
		    AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		    AND ((C.LAST_FG = '1' AND A.CAT_IN_1 != '00000000')
 		         OR 
 		         (C.LAST_FG = '2' AND A.CAT_IN_1  = '00000000' AND A.CAT_OUT_1 != '00000000'))
		    AND A.INDWELL_CATH = '1'  
		    AND A.DOC_DT != C.DOC_DT  
		
		UNION ALL
		-- [유치도뇨관 오류 3] 삽입일자 없음, 제거일자만 있음
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'E1'                                              AS errType
			   , 'g-1-1, g-2-1 삽입일자는 공란이나 g-1-2, g-2-2 제거일자에만 모두 작성되어 있는경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_1,A.CAT_IN_2),'0','') = ''
		   AND A.CAT_OUT_1 != '00000000' 
		   AND A.CAT_OUT_2 != '00000000'
		   AND A.INDWELL_CATH = '1' 
		
		UNION ALL
		-- [유치도뇨관 오류 4] 마지막 삽입,제거없이 삽입기간에 일수 있는경우
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'F1'                                              AS errType
			   , 'g.11 삽입기간에 삽입일수가 작성된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_10,A.CAT_OUT_10),'0','') = ''
		   AND IFNULL(A.CAT_DUR,0) > 0
		   AND A.INDWELL_CATH = '1' 
		
		UNION ALL
		-- [유치도뇨관 오류 5] 첫번째 삽입,제거 없는데 두번째 삽입 또느 제거 있는경우  
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'G1'                                              AS errType
			   , '유치도뇨관 첫 줄 삽입일자/ 제거일자가 공란이나, 2번째 삽일 또는 제거일자가 기재된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_1,A.CAT_OUT_1),'0','') = ''
		   AND (A.CAT_IN_2  != '00000000' OR 
		        A.CAT_OUT_2 != '00000000') 
		   AND A.INDWELL_CATH = '1'     
		
		UNION ALL
		
		-- [유치도뇨관 오류 6] 당월 환자평가표 작성일 이후 삽입 및 제거일자가 작성되어 있는 경우  
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'G2'                                              AS errType
			   , '당월 환자평가표 작성일 이후의 삽입일자 또는 제거일자가 기재된 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND ((A.CAT_IN_1   > A.DOC_DT) OR
				  (A.CAT_IN_2   > A.DOC_DT) OR
				  (A.CAT_IN_3   > A.DOC_DT) OR
				  (A.CAT_IN_4   > A.DOC_DT) OR
				  (A.CAT_IN_5   > A.DOC_DT) OR
				  (A.CAT_IN_6   > A.DOC_DT) OR
				  (A.CAT_IN_7   > A.DOC_DT) OR
				  (A.CAT_IN_8   > A.DOC_DT) OR
				  (A.CAT_IN_9   > A.DOC_DT) OR
				  (A.CAT_IN_10  > A.DOC_DT) OR
				  (A.CAT_OUT_1  > A.DOC_DT) OR
				  (A.CAT_OUT_2  > A.DOC_DT) OR
				  (A.CAT_OUT_3  > A.DOC_DT) OR
				  (A.CAT_OUT_4  > A.DOC_DT) OR
				  (A.CAT_OUT_5  > A.DOC_DT) OR
				  (A.CAT_OUT_6  > A.DOC_DT) OR
				  (A.CAT_OUT_7  > A.DOC_DT) OR
				  (A.CAT_OUT_8  > A.DOC_DT) OR
				  (A.CAT_OUT_9  > A.DOC_DT) OR
				  (A.CAT_OUT_10 > A.DOC_DT))
			 AND A.INDWELL_CATH = '1' 	  
		
		UNION ALL
		
		-- [유치도뇨관 오류 7] 유치도뇨관 삽입에 체크, 마지막 작성이 삽입, 소변조절상태가 '조절할 수 있음'  
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'H1'                                              AS errType
			   , '유치도뇨관이 삽입된 상태이나, 소변조절상태가 조절할 수 있음으로 체크되어 있지 않은 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
				     -- 마지막이 삽입,제거 확인
				     , CASE WHEN B.CAT_OUT_10 != '00000000' THEN '2'
				            WHEN B.CAT_IN_10  != '00000000' THEN '1'
				            WHEN B.CAT_OUT_9  != '00000000' THEN '2'
		                    WHEN B.CAT_IN_9   != '00000000' THEN '1'
				  	        WHEN B.CAT_OUT_8  != '00000000' THEN '2'
				 	        WHEN B.CAT_IN_8   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_7  != '00000000' THEN '2'
					        WHEN B.CAT_IN_7   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_6  != '00000000' THEN '2'
					        WHEN B.CAT_IN_6   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_5  != '00000000' THEN '2'
					        WHEN B.CAT_IN_5   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_4  != '00000000' THEN '2'
					        WHEN B.CAT_IN_4   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_3  != '00000000' THEN '2'
					        WHEN B.CAT_IN_3   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_2  != '00000000' THEN '2'
					        WHEN B.CAT_IN_2   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_1  != '00000000' THEN '2'
				 	        WHEN B.CAT_IN_1   != '00000000' THEN '1'
					        ELSE '0' END AS LAST_FG
			     FROM TBL_PATVAL_MST B
			    WHERE B.HOSP_CD = #{hospCd}
		          AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		          AND REPLACE(CONCAT(B.CAT_IN_1 ,B.CAT_IN_2 ,B.CAT_IN_3 ,B.CAT_IN_4 ,B.CAT_IN_5 ,
		                             B.CAT_IN_6 ,B.CAT_IN_7 ,B.CAT_IN_8 ,B.CAT_IN_9 ,B.CAT_IN_10,
			                         B.CAT_OUT_1,B.CAT_OUT_2,B.CAT_OUT_3,B.CAT_OUT_4,B.CAT_OUT_5,
			                         B.CAT_OUT_6,B.CAT_OUT_7,B.CAT_OUT_8,B.CAT_OUT_9,B.CAT_OUT_10),'0','') != '' 
		       ) C ON A.HOSP_CD  = C.HOSP_CD 
		          AND A.PAT_ID   = C.PAT_ID 
		          AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.LAST_FG      = '1'
		   AND A.URINE_CTL    = '0'
		   AND A.INDWELL_CATH = '1'
		
		UNION ALL
		-- [욕창 새로생긴 오류 1] 전월 욕창이 없고, 당월 욕창이 생겼으나, 이전평가 이후 새로운 욕창 발생여부에 '없음'으로 체크 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I1'
			   , '전월 욕창이 없고, 당월 욕창이 생겼으나 2. 새로발생한 욕창 a. 이전평가 이후 새로운 욕창 발생여부에 없음으로 체크된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') = ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') != ''
		  AND A.NEW_ULCER = '0'
		
		UNION ALL
		
		-- [욕창 새로생긴 오류 2] 전월,당월 욕창이 있고, 이후 새로운 욕창 발생여부에 '있음'으로 체크 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I2'
			   , '전월, 당월 욕창 욕창이 있는 대상자 중 2. 새로발생한 욕창 a. 이전평가 이후 새로운 욕창 발생여부에 있음으로 체크되어 있으나 전월의 발생일자가 동일하게 작성된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') != ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') != ''
		  AND A.NEW_ULCER = '1'
		
		UNION ALL
		
		-- [욕창 새로생긴 오류 3] 전월,당월 욕창이 없고, 이후 새로운 욕창 발생여부에 '있음'으로 체크, 발생일이 기록이 있는경우 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I3'
			   , '전월, 당월 욕창이 없으나, a. 이전평가 이후 새로운 욕창 발생여부에 있음으로 체크되어 있고 발생일이 기록이 있는경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') = ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') = ''
		  AND A.NEW_ULCER = '1' 
		  AND A.ULCER_DT != '00000000'
		
		UNION ALL
		
		-- [욕창관리환자 오류 1] 전월 욕창 있고,당월 욕창이 없고, 지난 1년사이의 욕창(압박성궤양) 과거력거력에 '없음'으로 체크
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J1'
			   , '전월 욕창이 있고, 당월욕창이 없는 경우 3. 지난 1년사이의 욕창(압박성궤양) 과거력거력에 없음으로 체크된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') != ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') = ''
		  AND A.PAST_ULCER = '0'
		
		UNION ALL
		
		-- [욕창관리환자 오류 2-1] 인정범위는 'M0121 염증성처치'를 실시한 경우, 피부궤양 드레싱 실시 안함
		  SELECT DISTINCT 
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J2'                                              AS errType
			   , '청구sam 파일에 M0121 염증성처치가 시행되었으나,  2. 피부문제에 대한 처치 중 피부궤양 드레싱에 체크가 없는 경우(점검용)' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT mm.HOSP_CD
				     , mm.PAT_ID
				  FROM TBL_CHUNG_MST  cm
				  JOIN TBL_JINORD_MST jm ON jm.HOSP_CD  = cm.HOSP_CD
				                        AND jm.CLAIM_NO = cm.CLAIM_NO
							            AND jm.EDI_CODE = 'M0121'
				  JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = jm.HOSP_CD
				                        AND mm.CLAIM_NO = jm.CLAIM_NO
				                        AND mm.BILL_SEQ = jm.BILL_SEQ
				 WHERE cm.HOSP_CD = #{hospCd}
				   AND cm.DATE_YM = #{jobYymm}
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND A.SKIN_ULC_DRES = '0'
		  AND A.FOOT_INFEC    = '0' 
          AND A.CI_UL1 + A.CI_UL2 + A.CI_UL3 + A.CI_UL4 = 0
		
		UNION ALL
		
		-- [욕창관리환자 오류 2-2] 피부궤양 드레싱 실시 함, 인정범위는 'M0121 염증성처치' 처방없는 경우
		  SELECT DISTINCT 
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J3'                                              AS errType  
			   , '피부궤양 드레싱 실시에 체크되어 있으나, 청구 sam 파일에 M0121 염증성처치가 확인되지 않은 경우' AS errName   
		  FROM TBL_PATVAL_MST A
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND A.SKIN_ULC_DRES = '1'
		  AND     EXISTS (SELECT 1
		                    FROM TBL_CHUNG_MST  cm
		                    JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = cm.HOSP_CD
		                                          AND mm.CLAIM_NO = cm.CLAIM_NO
				                                  AND mm.PAT_ID   = A.PAT_ID
				           WHERE cm.HOSP_CD = #{hospCd}
				             AND cm.DATE_YM = #{jobYymm})
		  AND NOT EXISTS (SELECT 1
		                    FROM TBL_CHUNG_MST  cm
		                    JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = cm.HOSP_CD
		                                          AND mm.CLAIM_NO = cm.CLAIM_NO
				                                  AND mm.PAT_ID   = A.PAT_ID
				            JOIN TBL_JINORD_MST jm ON jm.HOSP_CD  = mm.HOSP_CD
				                                  AND jm.CLAIM_NO = mm.CLAIM_NO
							                      AND jm.EDI_CODE = 'M0121'
				           WHERE cm.HOSP_CD = #{hospCd}
				             AND cm.DATE_YM = #{jobYymm})
	           
  		 UNION ALL  
  		 -- 환자평가표 관찰기간내 체충 측정 여부	
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J4'                                              AS errType  
			   , '환자평가표 관찰기간내 체충 측정 여부' AS errName
		  FROM TBL_PATVAL_MST A
          WHERE A.HOSP_CD = #{hospCd}
            AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		    AND A.WEIG_DT NOT BETWEEN A.MED_START AND A.DOC_DT            
            AND A.WEIG_HEIG_YN = '1' 
            
       UNION ALL
          -- 욕창처치 대상자로 영양공급에 예 로 체크되어 있으나, 체중즉정에 아니오 로 기재된 경우로 필요열량 및 단백 확인 불가  
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J5'                                              AS errType  
			   , '욕창처치 대상자로 영양공급에 예 로 체크되어 있으나, 체중즉정에 아니오 로 기재된 경우로 필요열량 및 단백 확인 불가' AS errName
		  FROM TBL_PATVAL_MST A
		  WHERE A.HOSP_CD = #{hospCd}
            AND A.MED_START LIKE CONCAT(#{jobYymm},'%')	
		    AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') != ''
		    AND A.NUTR_SKIN = '1'  
		    AND A.WEIG_HEIG_YN = '0'             
            	           
		UNION ALL  
		          		
		-- [일상생활수행능력(ADL)개선 점검 1] 전월대비 총점 ±1점인 대상자
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K1'                                              AS errType 
			   , '전월대비 ADL 총점이 ±1점인 대상자' AS errName   
		  FROM TBL_PATVAL_MST C
		  JOIN TBL_PATVAL_MST P ON C.HOSP_CD = P.HOSP_CD AND C.PAT_ID = P.PAT_ID AND C.ADMIT_DT = P.ADMIT_DT
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND P.HOSP_CD = #{hospCd}
		   AND P.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m'),'%')
		    -- ±1점 차이인 경우만 추출
		   AND ABS(ADL_SCORE_CHECK(C.DRESSING, C.WASHING, C.BRUSHING, C.BATHING,   C.EATING,
			                       C.MOVE_POS, C.SIT_UP,  C.TRANSFER, C.EXIT_ROOM, C.TOILET_USE, '1'
			      ) -
			      ADL_SCORE_CHECK(P.DRESSING, P.WASHING, P.BRUSHING, P.BATHING,   P.EATING,
			                      P.MOVE_POS, P.SIT_UP,  P.TRANSFER, P.EXIT_ROOM, P.TOILET_USE, '1'
			      )
		       ) = 1
		
		UNION ALL
		
		-- [일상생활수행능력(ADL)개선 점검 2] 전월대비 총점 ±3점인 대상자
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K2'
			   , '전월대비 ADL 총점이 ±3점 이상인 대상자' AS errName   
		  FROM TBL_PATVAL_MST C
		  JOIN TBL_PATVAL_MST P ON C.HOSP_CD = P.HOSP_CD AND C.PAT_ID = P.PAT_ID AND C.ADMIT_DT = P.ADMIT_DT
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND P.HOSP_CD = #{hospCd}
		   AND P.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m'),'%')
		   AND ABS(ADL_SCORE_CHECK(C.DRESSING, C.WASHING, C.BRUSHING, C.BATHING,   C.EATING,
			                       C.MOVE_POS, C.SIT_UP,  C.TRANSFER, C.EXIT_ROOM, C.TOILET_USE, '1'
			      ) -
			      ADL_SCORE_CHECK(P.DRESSING, P.WASHING, P.BRUSHING, P.BATHING,   P.EATING,
			                      P.MOVE_POS, P.SIT_UP,  P.TRANSFER, P.EXIT_ROOM, P.TOILET_USE, '1'
			      )
		       ) >= 3
		
		UNION ALL
		
		-- [일상생활수행능력(ADL)개선 점검 3] 행동심리증상_n.배회에 가끔, 자주, 매우자주에 체크, ADL항목 중 옮겨앉기, 방밖으로 나오기, 화장실사용하기가 '상당한도움','전적인도움'
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K3'                                              AS errType
			   , '행동심리증상_n.배회에 가끔, 자주, 매우자주에 체크되어 있으나 ADL항목 중 옮겨앉기, 방밖으로 나오기, 화장실사용하기가 상당한도움,전적인도움에  체크되어 있는 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.WANDER IN ('1', '2', '3')
		   AND (C.TRANSFER   IN ('3', '4') OR
		        C.EXIT_ROOM  IN ('3', '4') OR
		        C.TOILET_USE IN ('3', '4'))
		
		UNION ALL
		
		-- [당뇨병 환자 점검 1] 질병 당뇨에 체크되어 있으나, 3개월 이내 헤모글로빈 검사 실시여부 '아니오'로 체크 
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M1'                                              AS errType
			   , '질병 당뇨에 체크되어 있으나, 3개월 이내 헤모글로빈 검사 실시여부 아니오로 체크 된 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES   = '1'
		   AND C.HBA1C_TEST = '0'
		
		UNION ALL
		
		-- [당뇨병 환자 점검 2] 질병-당뇨-헤모글로빈 검사일자가 평가표 작성일 보다 이후 
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M2'                                              AS errType
			   , '질병-당뇨-헤모글로빈 검사일자가 평가표 작성일 보다 이후 인 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES  = '1'
		   AND C.TEST_DATE > C.DOC_DT
		
		UNION ALL
		
		-- [당뇨병 환자 점검 3] 질병-당뇨-헤모글로빈 검사일자가 평가표 작성일보다 90일 이전인 경우
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M3'                                              AS errType
			   , '당월 7일을 기준으로 질병-당뇨-헤모글로빈 검사일자가 90일 이전인 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES  = '1'
		   AND DATEDIFF(STR_TO_DATE(C.DOC_DT,   '%Y%m%d'), 
		                STR_TO_DATE(C.TEST_DATE,'%Y%m%d')) > 90
		
		-- ORDER BY errType
	</select>
	
	<select id="select_assesCheck01" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
	    
		  -- [평가구분 오류 1] 계속입원자인데 평가구분이 1 또는 3인 경우 ( 전월대상 평가표에 평가구분이 1일면 제외 )
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
					        
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A1'                                              AS errType
			   , '계속 입원환자 중 당월 요양 개시일이 1일이고, 작성일이 당월 7~10일 사이 작성되었으나 평가구분이 1. 입원평가 또는 3. 이전 평가 적용인 경우(2.계속입원)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND A.DOC_DT       LIKE CONCAT(#{jobYymm},'%')
		     AND A.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE IN ('1', '3')
		     AND (SELECT COUNT(B.PAT_ID)
		            FROM TBL_PATVAL_MST B
		           WHERE B.HOSP_CD  = A.HOSP_CD
		             AND B.PAT_ID   = A.PAT_ID
		             AND B.ADMIT_DT = A.ADMIT_DT
		             AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(CONCAT(#{jobYymm},'01'), INTERVAL 1 MONTH), '%Y%m'),'%')
		             AND B.EVAL_TYPE IN ('2','3')) > 0                    
		UNION ALL
		
		  -- [평가구분 오류 2] 요양개시일(당월) 작성일(전월(말일-6 ~ 월말)) 평가구분 = 2
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A2'                                              AS errType
			   , '요양개시일이 당월인데, 평가표 작성일이 이전월에 작성되었으나 평가구분이 2. 계속입원중인평가로 체크된 경우(3. 이전평가 적용)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
			 AND STR_TO_DATE(A.DOC_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND A.EVAL_TYPE = '2'
		
		UNION ALL
		
		  -- [평가구분 오류 3] 전월말 입원+당월 평가+평가구분=1 대상자중 
		  --               당월 진료개시일이 1일이면서 평가구분 = 2인 대상자 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'A3'                                              AS errType
			   , '월말 입원하여 익월에 평가표가 1. 입원평가로 작성되었으나, 당월 환자평가표 관찰기간에 포함되는 경우(관찰기간 겹침 오류)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '1'
		     AND STR_TO_DATE(A.ADMIT_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND EXISTS ( SELECT 1
		                    FROM TBL_PATVAL_MST B
		                   WHERE A.HOSP_CD    = B.HOSP_CD
		                     AND A.CHUNGSEQ   = B.CHUNGSEQ
		                     AND A.CLFORM_VER = B.CLFORM_VER
		                     AND A.PAT_ID     = B.PAT_ID
		                     AND A.ADMIT_DT   = B.ADMIT_DT
		                     --  진료개시일이 당월 1일이며, 평가구분이 2인 경우가 있으면
		                     AND B.MED_START  = CONCAT(#{jobYymm},'01')
		                     AND B.EVAL_TYPE  = '2' )
		
		UNION ALL
		
		  -- [작성일자 오류 1] 계속입원중인데 작성일이 요양개시일로부터 10일 이상 초과
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		      , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'B1'                                              AS errType
			   , '계속입원중인 평가 중 요양개시일 이후 평가표 작성 관찰기간이 10일을 초과하여 작성된 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND DATEDIFF(STR_TO_DATE(A.DOC_DT,   '%Y%m%d'), 
		                  STR_TO_DATE(A.MED_START,'%Y%m%d')) > 10
		     AND A.EVAL_TYPE = '2'
		
		UNION ALL
		
		  -- [작성일자 오류 2] 계속 입원 중인 대상자 중 특정기간 등으로 인하여 월말(-6) 에 평가표가 작성
		  --               진료개시일이 당월 1일이면
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'B2'                                              AS errType
			   , '당월 평가표 요양개시일이 1일인데, 전월 말일에 평가표가 작성되어 관찰기간 중복 가능성이 있는 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '2'
		     AND STR_TO_DATE(A.DOC_DT, '%Y%m%d') 
		         BETWEEN
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH)) - INTERVAL 6 DAY
		         AND 
		             LAST_DAY(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH))
		     AND EXISTS ( SELECT 1
		                    FROM TBL_PATVAL_MST B
		                   WHERE B.HOSP_CD    = A.HOSP_CD
		                     AND B.CHUNGSEQ   = A.CHUNGSEQ
		                     AND B.CLFORM_VER = A.CLFORM_VER
		                     AND B.PAT_ID     = A.PAT_ID
		                     AND B.ADMIT_DT   = A.ADMIT_DT
		                     --  진료개시일이 당월 1일이면
		                     AND B.MED_START  = CONCAT(#{jobYymm},'01') )
		
		UNION ALL
		
		  -- [작성일자 오류 3] 당월 요양개시일에 평가구분 IN ('1','2') 대상중
		  --              요양개시일자 다르고, 평가구분이 2가 아닌 대상
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
		              THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
		              ELSE '' END                                  AS patNm
		       , A.ADMIT_DT                                        AS admitDt
		       , B.MED_START                                       AS medStart		       
		       , A.DOC_DT                                          AS docDt
		       , B.EVAL_TYPE                                       AS evalType
		       , 'B3'                                              AS errType
		       , '당월 요양개시일에 평가구분이 1 또는 2로 작성된 대상자 중, 다른 평가표의 개시일이 다르고 평가구분이 2가 아닌 경우' AS errName
		    FROM TBL_PATVAL_MST A
		    JOIN TBL_PATVAL_MST B
  		      ON B.HOSP_CD    = A.HOSP_CD
		     AND B.CHUNGSEQ   = A.CHUNGSEQ
  		     AND B.CLFORM_VER = A.CLFORM_VER
		     AND B.PAT_ID     = A.PAT_ID
		     AND B.ADMIT_DT   = A.ADMIT_DT
		     AND B.DOC_DT    != A.DOC_DT
		     AND B.EVAL_TYPE != '2'
		     AND B.MED_START != A.MED_START
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE IN ('1','2')
		
		UNION ALL
		
		  -- [환자분류 오류 1] 환자평가표가 2회 작성된 대상자 중 환자분류군이 다를 경우
		  --               계속 입원중인 환자 중(당월 재입원대상자 제외) 
		  --               환자평가표가 2회 작성된 대상자 중 환자분류군이 다를 경우
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'C1'                                              AS errType
			   , '당월 환자평가표가 2개 이상 작성되었을 때 환자분류군이 다를 경우(당월 재입원대상자 제외)' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND A.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		     AND A.EVAL_TYPE = '2'
		     AND A.PAT_ID IN ( SELECT B.PAT_ID
		                         FROM TBL_PATVAL_MST B
		                        WHERE B.HOSP_CD = #{hospCd}
		                          AND B.MED_START    LIKE CONCAT(#{jobYymm},'%')
		                          AND B.ADMIT_DT NOT LIKE CONCAT(#{jobYymm},'%')
		                          AND B.EVAL_TYPE = '2'
		                        GROUP BY B.PAT_ID 
		                       HAVING COUNT(*) >= 2 
		                          AND COUNT(DISTINCT B.PAT_CLASS) > 1 )
		
		UNION ALL
		
		  -- [환자분류 오류 2] 당월평가표 개시일 1일, 작성일 7~10일 사이 작성되었으나, 
		  --               평가구분이 3 이전평가표로 체크되어 있는 경우
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'C2'                                              AS errType
			   , '당월 환자평가표 개시일 1일이고, 작성일 7~10일 사이 작성되었으나 평가구분이 3. 이전평가표로 체크되어 있는 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD   = #{hospCd}
		     AND A.MED_START = CONCAT(#{jobYymm},'01')
		     AND RIGHT(A.DOC_DT, 2) BETWEEN '07' AND '10'
		     AND A.EVAL_TYPE = '3'
		
	    ORDER BY errType
	</select>
	
	<select id="select_assesCheck02" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		-- [유치도뇨관 오류 1,2] 1. 중복 삽입일자, 2. 삽입일자 확인불가
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
		       , A.MED_START                                       AS medStart  
		       , A.DOC_DT                                          AS docDt
		       , A.EVAL_TYPE                                       AS evalType
		       , CASE WHEN C.LAST_FG = '1' THEN 'D1' ELSE 'D2' END AS errType
		       
		       , CASE WHEN C.LAST_FG = '1' THEN '전월환자평가표 상 마지막 기록이 삽입일자 이나, 당월평가표에 삽입일자가 작성되어 있는 경우 (삽입일자 중복작성 오류)' 
		              ELSE '전월환자평가표 상 마지막 기록이 제거일자 이나, 당월평가표에 삽입일자 공란, 제거일자가 작성되어 있는 경우 (삽입일자 확인불가)' END AS errName
		       
		       
		    FROM TBL_PATVAL_MST A
		    JOIN (SELECT B.HOSP_CD
		               , B.PAT_ID
		               , B.ADMIT_DT
		               , B.DOC_DT
				       -- 마지막이 삽입,제거 확인
		  		       , CASE WHEN B.CAT_OUT_10 != '00000000' THEN '2'
				              WHEN B.CAT_IN_10  != '00000000' THEN '1'
				              WHEN B.CAT_OUT_9  != '00000000' THEN '2'
				              WHEN B.CAT_IN_9   != '00000000' THEN '1'
				  	          WHEN B.CAT_OUT_8  != '00000000' THEN '2'
				 	          WHEN B.CAT_IN_8   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_7  != '00000000' THEN '2'
					          WHEN B.CAT_IN_7   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_6  != '00000000' THEN '2'
					          WHEN B.CAT_IN_6   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_5  != '00000000' THEN '2'
					          WHEN B.CAT_IN_5   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_4  != '00000000' THEN '2'
					          WHEN B.CAT_IN_4   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_3  != '00000000' THEN '2'
					          WHEN B.CAT_IN_3   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_2  != '00000000' THEN '2'
					          WHEN B.CAT_IN_2   != '00000000' THEN '1'
					          WHEN B.CAT_OUT_1  != '00000000' THEN '2'
				 	          WHEN B.CAT_IN_1   != '00000000' THEN '1'
					          ELSE '0' END AS LAST_FG
		           FROM TBL_PATVAL_MST B
		          WHERE B.HOSP_CD = #{hospCd}
		            AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		            AND REPLACE(CONCAT(B.CAT_IN_1 ,B.CAT_IN_2 ,B.CAT_IN_3 ,B.CAT_IN_4 ,B.CAT_IN_5 ,
		                               B.CAT_IN_6 ,B.CAT_IN_7 ,B.CAT_IN_8 ,B.CAT_IN_9 ,B.CAT_IN_10,
		                               B.CAT_OUT_1,B.CAT_OUT_2,B.CAT_OUT_3,B.CAT_OUT_4,B.CAT_OUT_5,
		                               B.CAT_OUT_6,B.CAT_OUT_7,B.CAT_OUT_8,B.CAT_OUT_9,B.CAT_OUT_10),'0','') != '' 
		         ) C ON A.HOSP_CD  = C.HOSP_CD 
		            AND A.PAT_ID   = C.PAT_ID 
		            AND A.ADMIT_DT = C.ADMIT_DT
		  WHERE A.HOSP_CD = #{hospCd}
		    AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		    AND ((C.LAST_FG = '1' AND A.CAT_IN_1 != '00000000')
 		         OR 
 		         (C.LAST_FG = '2' AND A.CAT_IN_1  = '00000000' AND A.CAT_OUT_1 != '00000000'))
		    AND A.INDWELL_CATH = '1'  
		    AND A.DOC_DT != C.DOC_DT  
		
		UNION ALL
		-- [유치도뇨관 오류 3] 삽입일자 없음, 제거일자만 있음
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'E1'                                              AS errType
			   , 'g-1-1, g-2-1 삽입일자는 공란이나 g-1-2, g-2-2 제거일자에만 모두 작성되어 있는경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_1,A.CAT_IN_2),'0','') = ''
		   AND A.CAT_OUT_1 != '00000000' 
		   AND A.CAT_OUT_2 != '00000000'
		   AND A.INDWELL_CATH = '1' 
		
		UNION ALL
		-- [유치도뇨관 오류 4] 마지막 삽입,제거없이 삽입기간에 일수 있는경우
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'F1'                                              AS errType
			   , 'g.11 삽입기간에 삽입일수가 작성된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_10,A.CAT_OUT_10),'0','') = ''
		   AND IFNULL(A.CAT_DUR,0) > 0
		   AND A.INDWELL_CATH = '1' 
		
		UNION ALL
		-- [유치도뇨관 오류 5] 첫번째 삽입,제거 없는데 두번째 삽입 또느 제거 있는경우  
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'G1'                                              AS errType
			   , '유치도뇨관 첫 줄 삽입일자/ 제거일자가 공란이나, 2번째 삽일 또는 제거일자가 기재된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		 WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND REPLACE(CONCAT(A.CAT_IN_1,A.CAT_OUT_1),'0','') = ''
		   AND (A.CAT_IN_2  != '00000000' OR 
		        A.CAT_OUT_2 != '00000000') 
		   AND A.INDWELL_CATH = '1'     
		
		UNION ALL
		
		-- [유치도뇨관 오류 6] 당월 환자평가표 작성일 이후 삽입 및 제거일자가 작성되어 있는 경우  
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'G2'                                              AS errType
			   , '당월 환자평가표 작성일 이후의 삽입일자 또는 제거일자가 기재된 경우' AS errName
		    FROM TBL_PATVAL_MST A
		   WHERE A.HOSP_CD = #{hospCd}
		     AND A.MED_START    LIKE CONCAT(#{jobYymm},'%')
		     AND ((A.CAT_IN_1   > A.DOC_DT) OR
				  (A.CAT_IN_2   > A.DOC_DT) OR
				  (A.CAT_IN_3   > A.DOC_DT) OR
				  (A.CAT_IN_4   > A.DOC_DT) OR
				  (A.CAT_IN_5   > A.DOC_DT) OR
				  (A.CAT_IN_6   > A.DOC_DT) OR
				  (A.CAT_IN_7   > A.DOC_DT) OR
				  (A.CAT_IN_8   > A.DOC_DT) OR
				  (A.CAT_IN_9   > A.DOC_DT) OR
				  (A.CAT_IN_10  > A.DOC_DT) OR
				  (A.CAT_OUT_1  > A.DOC_DT) OR
				  (A.CAT_OUT_2  > A.DOC_DT) OR
				  (A.CAT_OUT_3  > A.DOC_DT) OR
				  (A.CAT_OUT_4  > A.DOC_DT) OR
				  (A.CAT_OUT_5  > A.DOC_DT) OR
				  (A.CAT_OUT_6  > A.DOC_DT) OR
				  (A.CAT_OUT_7  > A.DOC_DT) OR
				  (A.CAT_OUT_8  > A.DOC_DT) OR
				  (A.CAT_OUT_9  > A.DOC_DT) OR
				  (A.CAT_OUT_10 > A.DOC_DT))
			 AND A.INDWELL_CATH = '1' 	  
		
		UNION ALL
		
		-- [유치도뇨관 오류 7] 유치도뇨관 삽입에 체크, 마지막 작성이 삽입, 소변조절상태가 '조절할 수 있음'  
		
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'H1'                                              AS errType
			   , '유치도뇨관이 삽입된 상태이나, 소변조절상태가 조절할 수 있음으로 체크되어 있지 않은 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
				     -- 마지막이 삽입,제거 확인
				     , CASE WHEN B.CAT_OUT_10 != '00000000' THEN '2'
				            WHEN B.CAT_IN_10  != '00000000' THEN '1'
				            WHEN B.CAT_OUT_9  != '00000000' THEN '2'
		                    WHEN B.CAT_IN_9   != '00000000' THEN '1'
				  	        WHEN B.CAT_OUT_8  != '00000000' THEN '2'
				 	        WHEN B.CAT_IN_8   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_7  != '00000000' THEN '2'
					        WHEN B.CAT_IN_7   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_6  != '00000000' THEN '2'
					        WHEN B.CAT_IN_6   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_5  != '00000000' THEN '2'
					        WHEN B.CAT_IN_5   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_4  != '00000000' THEN '2'
					        WHEN B.CAT_IN_4   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_3  != '00000000' THEN '2'
					        WHEN B.CAT_IN_3   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_2  != '00000000' THEN '2'
					        WHEN B.CAT_IN_2   != '00000000' THEN '1'
					        WHEN B.CAT_OUT_1  != '00000000' THEN '2'
				 	        WHEN B.CAT_IN_1   != '00000000' THEN '1'
					        ELSE '0' END AS LAST_FG
			     FROM TBL_PATVAL_MST B
			    WHERE B.HOSP_CD = #{hospCd}
		          AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		          AND REPLACE(CONCAT(B.CAT_IN_1 ,B.CAT_IN_2 ,B.CAT_IN_3 ,B.CAT_IN_4 ,B.CAT_IN_5 ,
		                             B.CAT_IN_6 ,B.CAT_IN_7 ,B.CAT_IN_8 ,B.CAT_IN_9 ,B.CAT_IN_10,
			                         B.CAT_OUT_1,B.CAT_OUT_2,B.CAT_OUT_3,B.CAT_OUT_4,B.CAT_OUT_5,
			                         B.CAT_OUT_6,B.CAT_OUT_7,B.CAT_OUT_8,B.CAT_OUT_9,B.CAT_OUT_10),'0','') != '' 
		       ) C ON A.HOSP_CD  = C.HOSP_CD 
		          AND A.PAT_ID   = C.PAT_ID 
		          AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		   AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.LAST_FG      = '1'
		   AND A.URINE_CTL    = '0'
		   AND A.INDWELL_CATH = '1'	 	  
		
		ORDER BY errType
	</select>
	<select id="select_assesCheck03" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		-- [욕창 새로생긴 오류 1] 전월 욕창이 없고, 당월 욕창이 생겼으나, 이전평가 이후 새로운 욕창 발생여부에 '없음'으로 체크 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I1'
			   , '전월 욕창이 없고, 당월 욕창이 생겼으나 2. 새로발생한 욕창 a. 이전평가 이후 새로운 욕창 발생여부에 없음으로 체크된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') = ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') != ''
		  AND A.NEW_ULCER = '0'
		
		UNION ALL
		
		-- [욕창 새로생긴 오류 2] 전월,당월 욕창이 있고, 이후 새로운 욕창 발생여부에 '있음'으로 체크 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I2'
			   , '전월, 당월 욕창 욕창이 있는 대상자 중 2. 새로발생한 욕창 a. 이전평가 이후 새로운 욕창 발생여부에 있음으로 체크되어 있으나 전월의 발생일자가 동일하게 작성된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') != ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') != ''
		  AND A.NEW_ULCER = '1'
		
		UNION ALL
		
		-- [욕창 새로생긴 오류 3] 전월,당월 욕창이 없고, 이후 새로운 욕창 발생여부에 '있음'으로 체크, 발생일이 기록이 있는경우 
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'I3'
			   , '전월, 당월 욕창이 없으나, a. 이전평가 이후 새로운 욕창 발생여부에 있음으로 체크되어 있고 발생일이 기록이 있는경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') = ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') = ''
		  AND A.NEW_ULCER = '1' 
		  AND A.ULCER_DT != '00000000'
		
		ORDER BY errType
	</select>
	<select id="select_assesCheck04" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		-- [욕창관리환자 오류 1] 전월 욕창 있고,당월 욕창이 없고, 지난 1년사이의 욕창(압박성궤양) 과거력거력에 '없음'으로 체크
		  SELECT DISTINCT
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J1'
			   , '전월 욕창이 있고, 당월욕창이 없는 경우 3. 지난 1년사이의 욕창(압박성궤양) 과거력거력에 없음으로 체크된 경우' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT B.HOSP_CD
		  	         , B.CHUNGSEQ
			         , B.CLFORM_VER
			         , B.PAT_ID
			         , B.ADMIT_DT
		          FROM TBL_PATVAL_MST B
		         WHERE B.HOSP_CD = #{hospCd}
		           AND B.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'),'%Y%m%d'), INTERVAL 1 MONTH),'%Y%m'),'%') 
		           AND REPLACE(CONCAT(B.PR_ULCER1,B.PR_ULCER2,B.PR_ULCER3,B.PR_ULCER4),'0','') != ''
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID 
		           AND A.ADMIT_DT = C.ADMIT_DT
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND REPLACE(CONCAT(A.PR_ULCER1,A.PR_ULCER2,A.PR_ULCER3,A.PR_ULCER4),'0','') = ''
		  AND A.PAST_ULCER = '0'
		
		UNION ALL
		
		-- [욕창관리환자 오류 2-1] 인정범위는 'M0121 염증성처치'를 실시한 경우, 피부궤양 드레싱 실시 안함
		  SELECT DISTINCT 
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J2'                                              AS errType
			   , '청구sam 파일에 M0121 염증성처치가 시행되었으나,  2. 피부문제에 대한 처치 중 피부궤양 드레싱에 체크가 없는 경우(점검용)' AS errName
		  FROM TBL_PATVAL_MST A
		  JOIN (SELECT mm.HOSP_CD
				     , mm.PAT_ID
				  FROM TBL_CHUNG_MST  cm
				  JOIN TBL_JINORD_MST jm ON jm.HOSP_CD  = cm.HOSP_CD
				                        AND jm.CLAIM_NO = cm.CLAIM_NO
							            AND jm.EDI_CODE = 'M0121'
				  JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = jm.HOSP_CD
				                        AND mm.CLAIM_NO = jm.CLAIM_NO
				                        AND mm.BILL_SEQ = jm.BILL_SEQ
				 WHERE cm.HOSP_CD = #{hospCd}
				   AND cm.DATE_YM = #{jobYymm}
		       ) C  ON A.HOSP_CD  = C.HOSP_CD 
		           AND A.PAT_ID   = C.PAT_ID
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND A.SKIN_ULC_DRES = '0'
		  AND A.FOOT_INFEC    = '0' 
          AND A.CI_UL1 + A.CI_UL2 + A.CI_UL3 + A.CI_UL4 = 0
		
		UNION ALL
		
		-- [욕창관리환자 오류 2-2] 피부궤양 드레싱 실시 함, 인정범위는 'M0121 염증성처치' 처방없는 경우
		  SELECT DISTINCT 
		         LEFT(A.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(A.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(A.PAT_NM, ''), CHAR_LENGTH(COALESCE(A.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
		       , A.ADMIT_DT                                        AS admitDt
			   , A.MED_START                                       AS medStart  
			   , A.DOC_DT                                          AS docDt
			   , A.EVAL_TYPE                                       AS evalType
			   , 'J3'                                              AS errType  
			   , '피부궤양 드레싱 실시에 체크되어 있으나, 청구 sam 파일에 M0121 염증성처치가 확인되지 않은 경우' AS errName   
		  FROM TBL_PATVAL_MST A
		WHERE A.HOSP_CD = #{hospCd}
		  AND A.MED_START LIKE CONCAT(#{jobYymm},'%')
		  AND A.SKIN_ULC_DRES = '1'
		  AND     EXISTS (SELECT 1
		                    FROM TBL_CHUNG_MST  cm
		                    JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = cm.HOSP_CD
		                                          AND mm.CLAIM_NO = cm.CLAIM_NO
				                                  AND mm.PAT_ID   = A.PAT_ID
				           WHERE cm.HOSP_CD = #{hospCd}
				             AND cm.DATE_YM = #{jobYymm})
		  AND NOT EXISTS (SELECT 1
		                    FROM TBL_CHUNG_MST  cm
		                    JOIN TBL_MYOUNG_MST mm ON mm.HOSP_CD  = cm.HOSP_CD
		                                          AND mm.CLAIM_NO = cm.CLAIM_NO
				                                  AND mm.PAT_ID   = A.PAT_ID
				            JOIN TBL_JINORD_MST jm ON jm.HOSP_CD  = mm.HOSP_CD
				                                  AND jm.CLAIM_NO = mm.CLAIM_NO
							                      AND jm.EDI_CODE = 'M0121'
				           WHERE cm.HOSP_CD = #{hospCd}
				             AND cm.DATE_YM = #{jobYymm})
		
		ORDER BY errType
	</select>
	<select id="select_assesCheck05" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		-- [일상생활수행능력(ADL)개선 점검 1] 전월대비 총점 ±1점인 대상자
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K1'                                              AS errType 
			   , '전월대비 ADL 총점이 ±1점인 대상자' AS errName   
		  FROM TBL_PATVAL_MST C
		  JOIN TBL_PATVAL_MST P ON C.HOSP_CD = P.HOSP_CD AND C.PAT_ID = P.PAT_ID AND C.ADMIT_DT = P.ADMIT_DT
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND P.HOSP_CD = #{hospCd}
		   AND P.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m'),'%')
		    -- ±1점 차이인 경우만 추출
		   AND ABS(ADL_SCORE_CHECK(C.DRESSING, C.WASHING, C.BRUSHING, C.BATHING,   C.EATING,
			                       C.MOVE_POS, C.SIT_UP,  C.TRANSFER, C.EXIT_ROOM, C.TOILET_USE, '1'
			      ) -
			      ADL_SCORE_CHECK(P.DRESSING, P.WASHING, P.BRUSHING, P.BATHING,   P.EATING,
			                      P.MOVE_POS, P.SIT_UP,  P.TRANSFER, P.EXIT_ROOM, P.TOILET_USE, '1'
			      )
		       ) = 1
		
		UNION ALL
		
		-- [일상생활수행능력(ADL)개선 점검 2] 전월대비 총점 ±3점인 대상자
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K2'
			   , '전월대비 ADL 총점이 ±3점 이상인 대상자' AS errName   
		  FROM TBL_PATVAL_MST C
		  JOIN TBL_PATVAL_MST P ON C.HOSP_CD = P.HOSP_CD AND C.PAT_ID = P.PAT_ID AND C.ADMIT_DT = P.ADMIT_DT
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND P.HOSP_CD = #{hospCd}
		   AND P.MED_START LIKE CONCAT(DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(#{jobYymm}, '01'), '%Y%m%d'), INTERVAL 1 MONTH), '%Y%m'),'%')
		   AND ABS(ADL_SCORE_CHECK(C.DRESSING, C.WASHING, C.BRUSHING, C.BATHING,   C.EATING,
			                       C.MOVE_POS, C.SIT_UP,  C.TRANSFER, C.EXIT_ROOM, C.TOILET_USE, '1'
			      ) -
			      ADL_SCORE_CHECK(P.DRESSING, P.WASHING, P.BRUSHING, P.BATHING,   P.EATING,
			                      P.MOVE_POS, P.SIT_UP,  P.TRANSFER, P.EXIT_ROOM, P.TOILET_USE, '1'
			      )
		       ) >= 3
		
		UNION ALL
		
		-- [일상생활수행능력(ADL)개선 점검 3] 행동심리증상_n.배회에 가끔, 자주, 매우자주에 체크, ADL항목 중 옮겨앉기, 방밖으로 나오기, 화장실사용하기가 '상당한도움','전적인도움'
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'K3'                                              AS errType
			   , '행동심리증상_n.배회에 가끔, 자주, 매우자주에 체크되어 있으나 ADL항목 중 옮겨앉기, 방밖으로 나오기, 화장실사용하기가 상당한도움,전적인도움에  체크되어 있는 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.WANDER IN ('1', '2', '3')
		   AND (C.TRANSFER   IN ('3', '4') OR
		        C.EXIT_ROOM  IN ('3', '4') OR
		        C.TOILET_USE IN ('3', '4'))
		
		ORDER BY errType
	</select>
	<select id="select_assesCheck06" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		-- [당뇨병 환자 점검 1] 질병 당뇨에 체크되어 있으나, 3개월 이내 헤모글로빈 검사 실시여부 아니오로 체크 
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M1'                                              AS errType
			   , '질병 당뇨에 체크되어 있으나, 3개월 이내 헤모글로빈 검사 실시여부 아니오로 체크 된 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES   = '1'
		   AND C.HBA1C_TEST = '0'
		
		UNION ALL
		
		-- [당뇨병 환자 점검 2] 질병-당뇨-헤모글로빈 검사일자가 평가표 작성일 보다 이후 
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M2'                                              AS errType
			   , '질병-당뇨-헤모글로빈 검사일자가 평가표 작성일 보다 이후 인 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES  = '1'
		   AND C.TEST_DATE > C.DOC_DT
		
		UNION ALL
		
		-- [당뇨병 환자 점검 3] 질병-당뇨-헤모글로빈 검사일자가 평가표 작성일보다 90일 이전인 경우
		  SELECT DISTINCT 
		         LEFT(C.PAT_ID,6)                                  AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , 'M3'                                              AS errType
			   , '당월 7일을 기준으로 질병-당뇨-헤모글로빈 검사일자가 90일 이전인 경우' AS errName
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   AND C.DIABETES  = '1'
		   AND DATEDIFF(STR_TO_DATE(C.DOC_DT,   '%Y%m%d'), 
		                STR_TO_DATE(C.TEST_DATE,'%Y%m%d')) > 90
		
		ORDER BY errType
	</select>
	
	<select id="select_assesCheck99" parameterType="map" resultType="egovframework.wnn_medcost.magam.model.PatvalDTO">
		
		  SELECT DISTINCT 
		         C.PAT_ID                                          AS patId
		       , CASE WHEN CHAR_LENGTH(COALESCE(C.PAT_NM, '')) >= 1 
					THEN CONCAT(LEFT(COALESCE(C.PAT_NM, ''), CHAR_LENGTH(COALESCE(C.PAT_NM, '')) - 1), '*')
					ELSE '' END AS patNm
			   , C.ADMIT_DT                                        AS admitDt
			   , C.MED_START                                       AS medStart  
			   , C.DOC_DT                                          AS docDt
			   , C.EVAL_TYPE                                       AS evalType
			   , C.PAT_CLASS                                       AS patClass
			   , C.USE_YN                                          AS useYn
		  FROM TBL_PATVAL_MST C
		 WHERE C.HOSP_CD = #{hospCd}
		   AND C.MED_START LIKE CONCAT(#{jobYymm},'%')
		   
	</select>
	
	<select id="select_HospitalMst" resultMap="indiMap">
		SELECT DISTINCT
		       hm.HOSP_CD AS hosp_cd 
		     , hm.HOSP_NM AS hosp_nm
		  FROM TBL_HOSP_MST hm
		 WHERE hm.JOB_SEQ = (SELECT MAX(JOB_SEQ)
		                       FROM TBL_HOSP_MST a
		                      WHERE a.HOSP_CD = hm.HOSP_CD)
		   AND hm.USE_YN  = 'Y'
		   
		   <if test="hosp_cd != null and hosp_cd != ''">
			   AND hm.HOSP_CD = #{hosp_cd}
		   </if>
		   
         ORDER BY hm.HOSP_NM 		   
	</select>
	<!--  
	<select id="select_Hosp_Indi" parameterType="map" resultMap="indiMap">
	    WITH grouped_data AS (
		    SELECT code.SUB_CODE_NM      AS cate_nm
		         , MAX(main.STDWEIG)     AS stdweig
		         
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_1} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval1
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_2} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval2
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_3} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval3
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_4} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval4
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_5} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval5
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_6} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval6
		
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_1} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival1
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_2} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival2
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_3} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival3
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_4} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival4
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_5} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival5
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_6} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival6
		
		         , ROUND(AVG(main.DTORVAL), 2) AS dtortot
		         , ROUND(AVG(main.NTORVAL), 2) AS ntortot
		         
		         , CASE WHEN  main.CATE_CD IN ('01','02','03','04','07') OR ROUND(AVG(main.DTORVAL), 2) = 0 THEN ''
                        WHEN  MAX(w.START_INDI) > (ROUND(AVG(main.NTORVAL), 2) / ROUND(AVG(main.DTORVAL), 2) * 100) THEN CONCAT('+', CEIL(MAX(w.START_INDI) * ROUND(AVG(main.DTORVAL), 2) / 100 - ROUND(AVG(main.NTORVAL), 2)),'명')
                        WHEN (ROUND(AVG(main.NTORVAL), 2) / ROUND(AVG(main.DTORVAL), 2) * 100) > MAX(w.END_INDI)    THEN CONCAT('-', CEIL(ROUND(AVG(main.NTORVAL), 2) - MAX(w.END_INDI) * ROUND(AVG(main.DTORVAL), 2) / 100),'명')
                        ELSE  '' END AS  fiveZone
                        
		         , ROUND(AVG(main.CAL_VAL), 2) AS cal_avg
		         , ROUND(AVG(main.WEIGVAL), 2) AS weigavg
		         , main.CATE_CD AS cate_cd
		    FROM TBL_PAT_INDI main
		    JOIN (SELECT wm.*
		            FROM TBL_WEVALUE_MST wm
		            JOIN (SELECT CATE_CODE, MAX(STD_SCORE) AS MAX_SCORE
		                    FROM TBL_WEVALUE_MST
		                   WHERE ACTION_YN = 'Y'
		                     AND CONCAT(#{stryymm},'01') BETWEEN START_DT AND END_DT
		                   GROUP BY CATE_CODE
		                 ) maxs ON wm.CATE_CODE = maxs.CATE_CODE AND wm.STD_SCORE = maxs.MAX_SCORE
		           WHERE wm.ACTION_YN = 'Y'
		         ) w ON main.CATE_CD = w.CATE_CODE AND main.JOBYYMM BETWEEN w.START_DT AND w.END_DT
		    LEFT JOIN TBL_CODE_DTL code
		      ON code.CODE_GB = 'Z'
		     AND code.CODE_CD = 'WVALUE'
		     AND code.SUB_CODE = main.CATE_CD
		     AND COALESCE(code.PROP_1, 'N') = 'Y'
		    WHERE main.HOSP_CD IN
		        <foreach item="cd" collection="hospcds" open="(" separator="," close=")">
		            #{cd}
		        </foreach>
		      AND main.JOBYYMM BETWEEN #{stryymm} AND #{endyymm}
		    GROUP BY main.CATE_CD, code.SUB_CODE_NM
		)
		
		SELECT *
		  FROM grouped_data
		
		 UNION ALL
		
		SELECT '합계' AS cate_nm
		     , SUM(stdweig) AS stdweig
		     , '' AS calval1
		     , '' AS calval2
		     , '' AS calval3
		     , '' AS calval4
		     , '' AS calval5
		     , '' AS calval6
		     , '' AS weival1
		     , '' AS weival2
		     , '' AS weival3
		     , '' AS weival4
		     , '' AS weival5
		     , '' AS weival6
		     , '' AS dtortot
		     , '' AS ntortot
		     , '' AS fiveZone
		     , '' AS cal_avg
		     , SUM(weigavg) AS weigavg
		     , '99' AS cate_cd
		FROM grouped_data
		
		ORDER BY 
		  CASE WHEN cate_cd = '99' THEN 999 ELSE CAST(cate_cd AS UNSIGNED) END
    </select>
    -->
    
    <select id="select_Hosp_Indi" parameterType="map" resultMap="indiMap">
	    WITH grouped_data AS (
		    SELECT code.SUB_CODE_NM      AS cate_nm
		         , MAX(main.STDWEIG)     AS stdweig
		         
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_1} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval1
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_2} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval2
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_3} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval3
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_4} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval4
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_5} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval5
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_6} THEN COALESCE(main.CAL_VAL,0) ELSE NULL END), 2),0) AS calval6
		
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_1} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival1
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_2} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival2
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_3} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival3
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_4} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival4
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_5} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival5
		         , COALESCE(ROUND(AVG(CASE WHEN main.JOBYYMM = #{month_6} THEN COALESCE(main.WEIGVAL,0) ELSE NULL END), 2),0) AS weival6
		
		         , ROUND(SUM(CASE WHEN main.CATE_CD IN ('01','02','03','04') AND RIGHT(main.JOBYYMM,2)     IN ('07','10')  
                                  THEN main.DTORVAL 
                                  WHEN main.CATE_CD IN ('01','02','03','04') AND RIGHT(main.JOBYYMM,2) NOT IN ('07','10') 
                                  THEN 0
		                          ELSE main.NTORVAL END), 2) AS dtortot
                 
                 , ROUND(SUM(CASE WHEN main.CATE_CD IN ('01','02','03','04') AND RIGHT(main.JOBYYMM,2)     IN ('07','10')  
                                  THEN main.NTORVAL 
                                  WHEN main.CATE_CD IN ('01','02','03','04') AND RIGHT(main.JOBYYMM,2) NOT IN ('07','10') 
                                  THEN 0
		                          ELSE main.DTORVAL END), 2) AS ntortot
		         
		         , CASE WHEN  main.CATE_CD IN ('01','02','03','04','07') OR ROUND(AVG(main.DTORVAL), 2) = 0 THEN ''
                        WHEN  MAX(w.START_INDI) > (ROUND(SUM(main.NTORVAL), 2) / ROUND(SUM(main.DTORVAL), 2) * 100) THEN CONCAT('+', CEIL(MAX(w.START_INDI) * ROUND(SUM(main.DTORVAL), 2) / 100 - ROUND(SUM(main.NTORVAL), 2)),'명')
                        WHEN (ROUND(SUM(main.NTORVAL), 2) / ROUND(SUM(main.DTORVAL), 2) * 100) > MAX(w.END_INDI)    THEN CONCAT('-', CEIL(ROUND(SUM(main.NTORVAL), 2) - MAX(w.END_INDI) * ROUND(SUM(main.DTORVAL), 2) / 100),'명')
                        ELSE  '' END AS  fiveZone
                        
		         , ROUND(EVALUATION_INDICATORS_VALUE('1',main.CATE_CD,MAX(main.JOBYYMM),SUM(main.DTORVAL),SUM(main.NTORVAL)), 2) AS cal_avg  -- ROUND(AVG(main.CAL_VAL), 2) AS cal_avg
		         , ROUND(EVALUATION_INDICATORS_VALUE('2',main.CATE_CD,MAX(main.JOBYYMM),SUM(main.DTORVAL),SUM(main.NTORVAL)), 2) AS weigavg  -- ROUND(AVG(main.WEIGVAL), 2) AS weigavg
		         , main.CATE_CD AS cate_cd
		    FROM TBL_PAT_INDI main
		    JOIN (SELECT wm.*
		            FROM TBL_WEVALUE_MST wm
		            JOIN (SELECT CATE_CODE, MAX(STD_SCORE) AS MAX_SCORE
		                    FROM TBL_WEVALUE_MST
		                   WHERE ACTION_YN = 'Y'
		                     AND CONCAT(#{stryymm},'01') BETWEEN START_DT AND END_DT
		                   GROUP BY CATE_CODE
		                 ) maxs ON wm.CATE_CODE = maxs.CATE_CODE AND wm.STD_SCORE = maxs.MAX_SCORE
		           WHERE wm.ACTION_YN = 'Y'
		         ) w ON main.CATE_CD = w.CATE_CODE AND main.JOBYYMM BETWEEN w.START_DT AND w.END_DT
		    LEFT JOIN TBL_CODE_DTL code
		      ON code.CODE_GB = 'Z'
		     AND code.CODE_CD = 'WVALUE'
		     AND code.SUB_CODE = main.CATE_CD
		     AND COALESCE(code.PROP_1, 'N') = 'Y'
		    WHERE main.HOSP_CD IN
		        <foreach item="cd" collection="hospcds" open="(" separator="," close=")">
		            #{cd}
		        </foreach>
		      AND main.JOBYYMM BETWEEN #{stryymm} AND #{endyymm}
		    GROUP BY main.CATE_CD, code.SUB_CODE_NM
		)
		
		SELECT *
		  FROM grouped_data
		
		 UNION ALL
		
		SELECT '합계' AS cate_nm
		     , SUM(stdweig) AS stdweig
		     , '' AS calval1
		     , '' AS calval2
		     , '' AS calval3
		     , '' AS calval4
		     , '' AS calval5
		     , '' AS calval6
		     , '' AS weival1
		     , '' AS weival2
		     , '' AS weival3
		     , '' AS weival4
		     , '' AS weival5
		     , '' AS weival6
		     , '' AS dtortot
		     , '' AS ntortot
		     , '' AS fiveZone
		     , '' AS cal_avg
		     , SUM(weigavg) AS weigavg
		     , '99' AS cate_cd
		FROM grouped_data
		
		ORDER BY 
		  CASE WHEN cate_cd = '99' THEN 999 ELSE CAST(cate_cd AS UNSIGNED) END
    </select>
    
    <insert id="insGoolgleSheet" parameterType="MagamDTO">
        INSERT INTO TBL_GOOGLE_ST(HOSP_CD,JOBYYMM,JOBCODE,HTTP_PH,REG_USER,UPD_USER,REG_DTTM,UPD_DTTM)
        VALUES (#{hosp_cd},#{jobyymm},#{jobcode},#{http_st},#{reg_user},#{reg_user},NOW(),NOW())
        ON DUPLICATE KEY UPDATE HTTP_PH  = VALUES(HTTP_PH),
                                UPD_USER = VALUES(UPD_USER),
                                UPD_DTTM = NOW();
    </insert>
    
     
    <select id="selGoolgleSheet" parameterType="MagamDTO" resultMap="magamMap">
		SELECT IFNULL(a.HTTP_PH,'') as http_st
		  FROM TBL_GOOGLE_ST a
		 WHERE a.HOSP_CD  = #{hosp_cd}
           AND a.JOBYYMM  = #{jobyymm}
           AND a.JOBCODE  = #{jobcode}
         LIMIT 1
	</select>
	
   <update id="modifyPatval" parameterType="PatvalDTO">
        UPDATE TBL_PATVAL_MST
           SET USE_YN    = #{useYn}
             , UPD_DTTM  = NOW()
             , UPD_USER  = #{updUser}
         WHERE HOSP_CD   = #{hospCd}
           AND PAT_ID    = #{patId}
           AND ADMIT_DT  = #{admitDt}
           AND MED_START = #{medStart}
    </update>  
    
    
       
	<!--   
	<select id="select_Hosp_Indi" parameterType="map" resultMap="indiMap">
	    WITH grouped_data AS (
		    SELECT code.SUB_CODE_NM      AS cate_nm
		         , MAX(main.STDWEIG)     AS stdweig
		         
		         , MAX(CASE WHEN main.JOBYYMM = #{month_1} THEN main.CAL_VAL ELSE NULL END) AS calval1
		         , MAX(CASE WHEN main.JOBYYMM = #{month_2} THEN main.CAL_VAL ELSE NULL END) AS calval2
		         , MAX(CASE WHEN main.JOBYYMM = #{month_3} THEN main.CAL_VAL ELSE NULL END) AS calval3
		         , MAX(CASE WHEN main.JOBYYMM = #{month_4} THEN main.CAL_VAL ELSE NULL END) AS calval4
		         , MAX(CASE WHEN main.JOBYYMM = #{month_5} THEN main.CAL_VAL ELSE NULL END) AS calval5
		         , MAX(CASE WHEN main.JOBYYMM = #{month_6} THEN main.CAL_VAL ELSE NULL END) AS calval6
		
		         , MAX(CASE WHEN main.JOBYYMM = #{month_1} THEN main.WEIGVAL ELSE NULL END) AS weival1
		         , MAX(CASE WHEN main.JOBYYMM = #{month_2} THEN main.WEIGVAL ELSE NULL END) AS weival2
		         , MAX(CASE WHEN main.JOBYYMM = #{month_3} THEN main.WEIGVAL ELSE NULL END) AS weival3
		         , MAX(CASE WHEN main.JOBYYMM = #{month_4} THEN main.WEIGVAL ELSE NULL END) AS weival4
		         , MAX(CASE WHEN main.JOBYYMM = #{month_5} THEN main.WEIGVAL ELSE NULL END) AS weival5
		         , MAX(CASE WHEN main.JOBYYMM = #{month_6} THEN main.WEIGVAL ELSE NULL END) AS weival6
		
		         , ROUND(AVG(hosp_avg.DTORVAL), 2) AS dtortot
		         , ROUND(AVG(hosp_avg.NTORVAL), 2) AS ntortot
		         
		         , CASE WHEN  main.CATE_CD IN ('01','02','03','04','07') OR ROUND(AVG(hosp_avg.DTORVAL), 2) = 0 THEN ''
                        WHEN  MAX(w.START_INDI) > (ROUND(AVG(hosp_avg.NTORVAL), 2) / ROUND(AVG(hosp_avg.DTORVAL), 2) * 100) THEN CONCAT('+', CEIL(MAX(w.START_INDI) * ROUND(AVG(hosp_avg.DTORVAL), 2) / 100 - ROUND(AVG(hosp_avg.NTORVAL), 2)),'명')
                        WHEN (ROUND(AVG(hosp_avg.NTORVAL), 2) / ROUND(AVG(hosp_avg.DTORVAL), 2) * 100) > MAX(w.END_INDI)    THEN CONCAT('-', CEIL(ROUND(AVG(hosp_avg.NTORVAL), 2) - MAX(w.END_INDI) * ROUND(AVG(hosp_avg.DTORVAL), 2) / 100),'명')
                        ELSE  '' END AS  fiveZone
                        
		         , ROUND(AVG(hosp_avg.CALC_AVG), 2) AS cal_avg
		         , ROUND(AVG(hosp_avg.WEIG_AVG), 2) AS weigavg
		         , main.CATE_CD AS cate_cd
		    FROM TBL_PAT_INDI main
		    JOIN (SELECT wm.*
		            FROM TBL_WEVALUE_MST wm
		            JOIN (SELECT CATE_CODE, MAX(STD_SCORE) AS MAX_SCORE
		                    FROM TBL_WEVALUE_MST
		                   WHERE ACTION_YN = 'Y'
		                     AND CONCAT(#{stryymm},'01') BETWEEN START_DT AND END_DT
		                   GROUP BY CATE_CODE
		                 ) maxs ON wm.CATE_CODE = maxs.CATE_CODE AND wm.STD_SCORE = maxs.MAX_SCORE
		           WHERE wm.ACTION_YN = 'Y'
		         ) w ON main.CATE_CD = w.CATE_CODE AND main.JOBYYMM BETWEEN w.START_DT AND w.END_DT
		    JOIN TBL_CODE_DTL code
		      ON code.CODE_GB = 'Z'
		     AND code.CODE_CD = 'WVALUE'
		     AND code.SUB_CODE = main.CATE_CD
		     AND COALESCE(code.PROP_1, 'N') = 'Y'
		    LEFT JOIN (
		        SELECT HOSP_CD, CATE_CD,
		               
		               ROUND(AVG(DTORVAL), 2) AS DTORVAL,
		               ROUND(AVG(NTORVAL), 2) AS NTORVAL,
		                
		               ROUND(AVG(CAL_VAL), 2) AS CALC_AVG,
		               ROUND(AVG(WEIGVAL), 2) AS WEIG_AVG
		        FROM TBL_PAT_INDI
		        WHERE JOBYYMM BETWEEN #{stryymm} AND #{endyymm}
		          AND HOSP_CD IN
		          <foreach item="cd" collection="hospcds" open="(" separator="," close=")">
		              #{cd}
		          </foreach>
		        GROUP BY HOSP_CD, CATE_CD
		    ) hosp_avg ON hosp_avg.HOSP_CD = main.HOSP_CD
		              AND hosp_avg.CATE_CD = main.CATE_CD
		    WHERE main.HOSP_CD IN
		        <foreach item="cd" collection="hospcds" open="(" separator="," close=")">
		            #{cd}
		        </foreach>
		      AND main.JOBYYMM BETWEEN #{stryymm} AND #{endyymm}
		    GROUP BY main.CATE_CD, code.SUB_CODE_NM
		)
		
		SELECT *
		  FROM grouped_data
		
		 UNION ALL
		
		SELECT '합계' AS cate_nm
		     , SUM(stdweig) AS stdweig
		     , '' AS calval1
		     , '' AS calval2
		     , '' AS calval3
		     , '' AS calval4
		     , '' AS calval5
		     , '' AS calval6
		     , '' AS weival1
		     , '' AS weival2
		     , '' AS weival3
		     , '' AS weival4
		     , '' AS weival5
		     , '' AS weival6
		     , '' AS dtortot
		     , '' AS ntortot
		     , '' AS fiveZone
		     , '' AS cal_avg
		     , SUM(weigavg) AS weigavg
		     , '99' AS cate_cd
		FROM grouped_data
		
		ORDER BY 
		  CASE WHEN cate_cd = '99' THEN 999 ELSE CAST(cate_cd AS UNSIGNED) END
    </select>
     -->
	 
	<!--
	<insert id="uploadMagamFiles" parameterType="filesDTO">
        INSERT INTO TBL_FILES_DATA (
            HOSP_CD,
            MG_YEAR,
            MGMONTH,
            MG_FLAG,
            JOBS_DT,
            FILE_NM,
            LINE_NO,
            LINEVAL,
            REG_DTTM,
            REG_USER,
            REG_IP
        )
        VALUES (
            #{hosp_cd},
            #{mg_year},
            #{mgmonth},
            #{mg_flag},
            #{jobs_dt},
            #{file_nm},
            #{line_no},
            #{lineval},
            NOW(),
            #{reg_user},
            #{reg_ip}
        )
    </insert>
    -->
</mapper>